--[[
    Nova UI Library v5.0 - Ultimate New Year Edition
    Premium Mod Menu Framework for Roblox
    Author: Nova Team
    License: MIT
    Design: Luxury Premium with Enhanced New Year Theme
    Optimized for PC & Mobile
--]]

-- Services
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

-- Cache frequently used enums
local EasingStyle = Enum.EasingStyle
local EasingDirection = Enum.EasingDirection
local UserInputType = Enum.UserInputType
local Font = Enum.Font

-- Library Table
local Nova = {
    Version = "5.0",
    Debug = false,
    Themes = {},
    ActiveMenus = {}
}

Nova.__index = Nova

-- Enhanced New Year Colors
local NEW_YEAR_COLORS = {
    Gold = Color3.fromRGB(255, 215, 0),
    Silver = Color3.fromRGB(192, 192, 192),
    Red = Color3.fromRGB(220, 20, 60),
    Green = Color3.fromRGB(46, 204, 113),
    Blue = Color3.fromRGB(52, 152, 219),
    Purple = Color3.fromRGB(155, 89, 182),
    White = Color3.fromRGB(255, 255, 255),
    DarkBlue = Color3.fromRGB(25, 25, 40),
    Cyan = Color3.fromRGB(0, 255, 255),
    Pink = Color3.fromRGB(255, 105, 180)
}

-- Premium New Year Themes
Nova.Themes = {
    GoldenNewYear = {
        Name = "Golden New Year",
        AccentColor = NEW_YEAR_COLORS.Gold,
        SecondaryColor = NEW_YEAR_COLORS.Silver,
        Background = Color3.fromRGB(15, 15, 25),
        Surface = Color3.fromRGB(30, 30, 45),
        Surface2 = Color3.fromRGB(40, 40, 60),
        Text = NEW_YEAR_COLORS.White,
        SubText = Color3.fromRGB(180, 180, 210),
        Border = NEW_YEAR_COLORS.Gold,
        Hover = Color3.fromRGB(50, 50, 80),
        Shadow = Color3.new(0, 0, 0),
        Glow = Color3.fromRGB(255, 215, 0, 0.15),
        Success = NEW_YEAR_COLORS.Green,
        Warning = NEW_YEAR_COLORS.Red,
        Info = NEW_YEAR_COLORS.Cyan
    },
    WinterWonderland = {
        Name = "Winter Wonderland",
        AccentColor = NEW_YEAR_COLORS.Cyan,
        SecondaryColor = NEW_YEAR_COLORS.Blue,
        Background = Color3.fromRGB(10, 15, 30),
        Surface = Color3.fromRGB(20, 30, 50),
        Surface2 = Color3.fromRGB(30, 45, 70),
        Text = Color3.fromRGB(240, 245, 255),
        SubText = Color3.fromRGB(170, 190, 220),
        Border = NEW_YEAR_COLORS.Cyan,
        Hover = Color3.fromRGB(40, 60, 90),
        Shadow = Color3.new(0, 0, 0),
        Glow = Color3.fromRGB(0, 255, 255, 0.15),
        Success = Color3.fromRGB(0, 255, 127),
        Warning = Color3.fromRGB(255, 69, 0),
        Info = NEW_YEAR_COLORS.Blue
    },
    MidnightCelebration = {
        Name = "Midnight Celebration",
        AccentColor = NEW_YEAR_COLORS.Purple,
        SecondaryColor = NEW_YEAR_COLORS.Pink,
        Background = Color3.fromRGB(20, 10, 30),
        Surface = Color3.fromRGB(40, 20, 60),
        Surface2 = Color3.fromRGB(60, 30, 80),
        Text = Color3.fromRGB(255, 240, 245),
        SubText = Color3.fromRGB(200, 170, 210),
        Border = NEW_YEAR_COLORS.Purple,
        Hover = Color3.fromRGB(70, 40, 90),
        Shadow = Color3.new(0, 0, 0),
        Glow = Color3.fromRGB(155, 89, 182, 0.15),
        Success = Color3.fromRGB(0, 255, 157),
        Warning = Color3.fromRGB(255, 87, 51),
        Info = NEW_YEAR_COLORS.Pink
    }
}

local DEFAULT_CONFIG = {
    Theme = "GoldenNewYear",
    BackgroundTransparency = 0.1,
    BlurEnabled = true,
    Keybind = Enum.KeyCode.RightShift,
    GlowEffect = true,
    Animations = true,
    SnowEffect = true,
    SoundEffects = false,
    RoundedCorners = true,
    ShadowEffect = true
}

-- Utility Functions
local function SafeCreate(class, props)
    local obj = Instance.new(class)
    
    for prop, value in pairs(props) do
        if prop ~= "Parent" and prop ~= "Children" and prop ~= "LayoutOrder" then
            local success = pcall(function()
                obj[prop] = value
            end)
            if not success and Nova.Debug then
                warn("[Nova UI] Failed to set", prop, "on", class)
            end
        end
    end
    
    if props.Parent then
        obj.Parent = props.Parent
    end
    
    if props.Children then
        for _, child in ipairs(props.Children) do
            if child then
                child.Parent = obj
            end
        end
    end
    
    if props.LayoutOrder then
        obj.LayoutOrder = props.LayoutOrder
    end
    
    return obj
end

local function CreateTween(obj, props, duration, easingStyle, easingDirection)
    if not obj or not props then return nil end
    
    local tweenInfo = TweenInfo.new(
        duration or 0.3,
        easingStyle or EasingStyle.Quint,
        easingDirection or EasingDirection.Out,
        0,
        false,
        0
    )
    
    local tweenObj = TweenService:Create(obj, tweenInfo, props)
    tweenObj:Play()
    return tweenObj
end

local function GenerateId()
    return HttpService:GenerateGUID(false):sub(1, 8)
end

local function IsMobile()
    return UserInputService.TouchEnabled
end

-- Main Constructor
function Nova.new(menuName, config)
    menuName = menuName or "NovaUI"
    
    -- Cleanup old menus
    for _, child in ipairs(CoreGui:GetChildren()) do
        if child:IsA("ScreenGui") and child.Name:find(menuName) then
            child:Destroy()
        end
    end
    
    local self = setmetatable({}, Nova)
    
    self.MenuName = menuName .. "_" .. GenerateId()
    self.Sections = {}
    self.ActiveSection = nil
    self.Config = config and table.clone(config) or table.clone(DEFAULT_CONFIG)
    self.CurrentTheme = Nova.Themes[self.Config.Theme] or Nova.Themes.GoldenNewYear
    self.IsMobile = IsMobile()
    self.IsOpen = false
    self.Connections = {}
    self.WidgetInstances = {}
    self.SnowParticles = {}
    
    -- Initialize
    local success, err = pcall(function()
        self:InitializeUI()
        self:InitializeInput()
        self:ApplyTheme()
        
        if self.Config.GlowEffect then
            self:CreateGlowEffect()
        end
        
        if self.Config.SnowEffect then
            self:CreateSnowEffect()
        end
        
        if self.Config.ShadowEffect then
            self:CreateShadowEffect()
        end
    end)
    
    if not success then
        warn("[Nova UI] Initialization error:", err)
        return nil
    end
    
    table.insert(Nova.ActiveMenus, self)
    print("[Nova UI] Ultimate New Year menu created:", self.MenuName)
    return self
end

-- Enhanced UI Initialization
function Nova:InitializeUI()
    -- Main ScreenGui
    self.ScreenGui = SafeCreate("ScreenGui", {
        Name = self.MenuName,
        Parent = CoreGui,
        ResetOnSpawn = false,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling,
        DisplayOrder = 999,
        IgnoreGuiInset = true
    })
    
    -- Main Container
    self.Container = SafeCreate("Frame", {
        Name = "Container",
        Parent = self.ScreenGui,
        AnchorPoint = Vector2.new(0.5, 0.5),
        Position = UDim2.new(0.5, 0, 0.5, 0),
        Size = UDim2.new(0, self.IsMobile and 380 or 820, 0, self.IsMobile and 580 or 700),
        BackgroundTransparency = 1,
        Visible = false,
        Active = true
    })
    
    -- Background with gradient
    self.Background = SafeCreate("Frame", {
        Name = "Background",
        Parent = self.Container,
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundColor3 = self.CurrentTheme.Background,
        BackgroundTransparency = 1,
        ClipsDescendants = true
    })
    
    if self.Config.RoundedCorners then
        SafeCreate("UICorner", {
            CornerRadius = UDim.new(0, 24),
            Parent = self.Background
        })
    end
    
    SafeCreate("UIStroke", {
        Color = self.CurrentTheme.AccentColor,
        Thickness = 2,
        Transparency = 0.3,
        Parent = self.Background
    })
    
    -- Background gradient
    local bgGradient = SafeCreate("UIGradient", {
        Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, self.CurrentTheme.Background),
            ColorSequenceKeypoint.new(1, self.CurrentTheme.Background:Lerp(Color3.new(0, 0, 0), 0.1))
        }),
        Rotation = 45,
        Parent = self.Background
    })
    
    -- Luxury Header
    self.Header = SafeCreate("Frame", {
        Name = "Header",
        Parent = self.Background,
        Size = UDim2.new(1, 0, 0, 90),
        BackgroundColor3 = self.CurrentTheme.Surface,
        BorderSizePixel = 0
    })
    
    if self.Config.RoundedCorners then
        SafeCreate("UICorner", {
            CornerRadius = UDim.new(0, 24),
            Parent = self.Header
        })
    end
    
    -- Header gradient
    local headerGradient = SafeCreate("UIGradient", {
        Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, self.CurrentTheme.Surface),
            ColorSequenceKeypoint.new(0.5, self.CurrentTheme.Surface:Lerp(self.CurrentTheme.AccentColor, 0.15)),
            ColorSequenceKeypoint.new(1, self.CurrentTheme.Surface)
        }),
        Rotation = 90,
        Parent = self.Header
    })
    
    -- Logo with animation
    self.Logo = SafeCreate("TextLabel", {
        Name = "Logo",
        Parent = self.Header,
        AnchorPoint = Vector2.new(0, 0.5),
        Position = UDim2.new(0, 25, 0.5, 0),
        Size = UDim2.new(0, 50, 0, 50),
        BackgroundTransparency = 1,
        Text = "üéÑ",
        TextColor3 = self.CurrentTheme.AccentColor,
        Font = Font.GothamBlack,
        TextSize = 36,
        TextStrokeColor3 = Color3.new(1, 1, 1),
        TextStrokeTransparency = 0.7
    })
    
    -- Title with gradient text
    self.Title = SafeCreate("TextLabel", {
        Name = "Title",
        Parent = self.Header,
        AnchorPoint = Vector2.new(0, 0.5),
        Position = UDim2.new(0, 90, 0.5, -10),
        Size = UDim2.new(0.4, 0, 0, 40),
        BackgroundTransparency = 1,
        Text = "NOVA 2025",
        TextColor3 = self.CurrentTheme.Text,
        Font = Font.GothamBold,
        TextSize = 26,
        TextXAlignment = Enum.TextXAlignment.Left
    })
    
    SafeCreate("TextLabel", {
        Parent = self.Header,
        AnchorPoint = Vector2.new(0, 0),
        Position = UDim2.new(0, 90, 0, 55),
        Size = UDim2.new(0.4, 0, 0, 20),
        BackgroundTransparency = 1,
        Text = "Ultimate Edition v" .. self.Version,
        TextColor3 = self.CurrentTheme.SubText,
        Font = Font.GothamMedium,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left
    })
    
    -- Enhanced Close Button
    self.CloseButton = SafeCreate("TextButton", {
        Name = "CloseButton",
        Parent = self.Header,
        AnchorPoint = Vector2.new(1, 0.5),
        Position = UDim2.new(1, -25, 0.5, 0),
        Size = UDim2.new(0, 46, 0, 46),
        BackgroundColor3 = self.CurrentTheme.Warning,
        AutoButtonColor = false,
        Text = "‚úï",
        TextColor3 = Color3.new(1, 1, 1),
        Font = Font.GothamBlack,
        TextSize = 28
    })
    
    SafeCreate("UICorner", {
        CornerRadius = UDim.new(1, 0),
        Parent = self.CloseButton
    })
    
    SafeCreate("UIStroke", {
        Color = Color3.new(1, 1, 1),
        Thickness = 2,
        Transparency = 0.2,
        Parent = self.CloseButton
    })
    
    self.CloseButton.MouseButton1Click:Connect(function()
        self:Toggle()
    end)
    
    -- Sidebar for desktop
    if not self.IsMobile then
        self.Sidebar = SafeCreate("Frame", {
            Name = "Sidebar",
            Parent = self.Background,
            Position = UDim2.new(0, 0, 0, 94),
            Size = UDim2.new(0, 200, 1, -94),
            BackgroundColor3 = self.CurrentTheme.Surface2,
            BorderSizePixel = 0
        })
        
        if self.Config.RoundedCorners then
            SafeCreate("UICorner", {
                CornerRadius = UDim.new(0, 24),
                Parent = self.Sidebar
            })
        end
        
        self.SectionList = SafeCreate("ScrollingFrame", {
            Name = "SectionList",
            Parent = self.Sidebar,
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            ScrollBarThickness = 0,
            CanvasSize = UDim2.new(0, 0, 0, 0),
            AutomaticCanvasSize = Enum.AutomaticSize.Y
        })
        
        SafeCreate("UIListLayout", {
            SortOrder = Enum.SortOrder.LayoutOrder,
            Padding = UDim.new(0, 10),
            Parent = self.SectionList
        })
        
        SafeCreate("UIPadding", {
            PaddingTop = UDim.new(0, 20),
            PaddingLeft = UDim.new(0, 20),
            PaddingRight = UDim.new(0, 20),
            Parent = self.SectionList
        })
    end
    
    -- Content Area
    self.ContentArea = SafeCreate("Frame", {
        Name = "ContentArea",
        Parent = self.Background,
        Position = self.IsMobile and UDim2.new(0, 0, 0, 94) or UDim2.new(0, 204, 0, 94),
        Size = self.IsMobile and UDim2.new(1, 0, 1, -94) or UDim2.new(1, -204, 1, -94),
        BackgroundTransparency = 1
    })
    
    self.ContentScroller = SafeCreate("ScrollingFrame", {
        Name = "ContentScroller",
        Parent = self.ContentArea,
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        ScrollBarThickness = 6,
        ScrollBarImageColor3 = self.CurrentTheme.AccentColor,
        CanvasSize = UDim2.new(0, 0, 0, 0),
        AutomaticCanvasSize = Enum.AutomaticSize.Y,
        ScrollingDirection = Enum.ScrollingDirection.Y
    })
    
    SafeCreate("UIListLayout", {
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 25),
        Parent = self.ContentScroller
    })
    
    SafeCreate("UIPadding", {
        PaddingTop = UDim.new(0, 25),
        PaddingRight = UDim.new(0, 25),
        PaddingLeft = UDim.new(0, 25),
        PaddingBottom = UDim.new(0, 25),
        Parent = self.ContentScroller
    })
    
    -- FAB for mobile
    if self.IsMobile then
        self.FAB = SafeCreate("ImageButton", {
            Name = "FAB",
            Parent = self.ScreenGui,
            AnchorPoint = Vector2.new(1, 1),
            Position = UDim2.new(1, -35, 1, -35),
            Size = UDim2.new(0, 70, 0, 70),
            BackgroundColor3 = self.CurrentTheme.AccentColor,
            Image = "rbxassetid://10734947690",
            ImageColor3 = Color3.new(1, 1, 1),
            AutoButtonColor = false
        })
        
        SafeCreate("UICorner", {
            CornerRadius = UDim.new(1, 0),
            Parent = self.FAB
        })
        
        SafeCreate("UIStroke", {
            Color = Color3.new(1, 1, 1),
            Thickness = 3,
            Transparency = 0.2,
            Parent = self.FAB
        })
        
        self.FAB.MouseButton1Click:Connect(function()
            self:Toggle()
        end)
    end
end

-- Snow Effect
function Nova:CreateSnowEffect()
    if not self.Config.SnowEffect then return end
    
    local snowContainer = SafeCreate("Frame", {
        Name = "SnowContainer",
        Parent = self.ScreenGui,
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        ZIndex = 0
    })
    
    local snowflakeCount = self.IsMobile and 30 or 60
    
    for i = 1, snowflakeCount do
        local size = math.random(6, 18)
        local snow = SafeCreate("Frame", {
            Name = "SnowFlake_" .. i,
            Parent = snowContainer,
            Size = UDim2.new(0, size, 0, size),
            Position = UDim2.new(0, math.random(-100, 1200), 0, -math.random(20, 200)),
            BackgroundColor3 = Color3.new(1, 1, 1),
            BackgroundTransparency = math.random(5, 8) / 10,
            Rotation = math.random(0, 360)
        })
        
        SafeCreate("UICorner", {
            CornerRadius = UDim.new(1, 0),
            Parent = snow
        })
        
        table.insert(self.SnowParticles, {
            Instance = snow,
            Speed = math.random(15, 35) / 10,
            Drift = math.random(-8, 8) / 10,
            Spin = math.random(-5, 5)
        })
    end
    
    -- Snow animation
    self.SnowThread = task.spawn(function()
        while self.ScreenGui and self.ScreenGui.Parent do
            for _, snowData in ipairs(self.SnowParticles) do
                local snow = snowData.Instance
                if snow then
                    local currentPos = snow.Position
                    local newY = currentPos.Y.Offset + snowData.Speed
                    local newX = currentPos.X.Offset + snowData.Drift
                    
                    if newY > 1000 then
                        snow.Position = UDim2.new(0, math.random(-100, 1200), 0, -50)
                    else
                        snow.Position = UDim2.new(0, newX, 0, newY)
                    end
                    
                    snow.Rotation = snow.Rotation + snowData.Spin
                end
            end
            task.wait(0.03)
        end
    end)
end

-- Glow Effect
function Nova:CreateGlowEffect()
    local glow = SafeCreate("Frame", {
        Name = "Glow",
        Parent = self.Container,
        Size = UDim2.new(1, 60, 1, 60),
        Position = UDim2.new(0, -30, 0, -30),
        BackgroundTransparency = 1,
        ZIndex = -1
    })
    
    local gradient = SafeCreate("UIGradient", {
        Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, self.CurrentTheme.AccentColor),
            ColorSequenceKeypoint.new(0.3, self.CurrentTheme.AccentColor:Lerp(Color3.new(1, 1, 1), 0.5)),
            ColorSequenceKeypoint.new(0.7, self.CurrentTheme.AccentColor:Lerp(Color3.new(1, 1, 1), 0.5)),
            ColorSequenceKeypoint.new(1, self.CurrentTheme.AccentColor)
        }),
        Rotation = 45,
        Transparency = NumberSequence.new({
            NumberSequenceKeypoint.new(0, 0.9),
            NumberSequenceKeypoint.new(0.5, 0.2),
            NumberSequenceKeypoint.new(1, 0.9)
        }),
        Parent = glow
    })
    
    if self.Config.Animations then
        task.spawn(function()
            while glow and glow.Parent do
                CreateTween(glow, {Rotation = 360}, 20, EasingStyle.Linear)
                task.wait(20)
                glow.Rotation = 0
            end
        end)
    end
end

-- Shadow Effect
function Nova:CreateShadowEffect()
    local shadow = SafeCreate("ImageLabel", {
        Name = "Shadow",
        Parent = self.Container,
        Size = UDim2.new(1, 40, 1, 40),
        Position = UDim2.new(0, -20, 0, -20),
        BackgroundTransparency = 1,
        Image = "rbxassetid://5554236805",
        ImageColor3 = Color3.new(0, 0, 0),
        ImageTransparency = 0.8,
        ScaleType = Enum.ScaleType.Slice,
        SliceCenter = Rect.new(10, 10, 118, 118),
        ZIndex = -2
    })
end

-- Input Handling
function Nova:InitializeInput()
    if not self.IsMobile then
        local conn = UserInputService.InputBegan:Connect(function(input, processed)
            if not processed and input.KeyCode == self.Config.Keybind then
                self:Toggle()
            end
        end)
        table.insert(self.Connections, conn)
    end
end

-- Menu Control
function Nova:Toggle()
    self.IsOpen = not self.IsOpen
    
    if self.IsOpen then
        -- Show menu
        self.Container.Visible = true
        self.Container.Position = UDim2.new(0.5, 0, 0.5, -80)
        self.Container.BackgroundTransparency = 1
        
        CreateTween(self.Container, {
            Position = UDim2.new(0.5, 0, 0.5, 0),
            BackgroundTransparency = 0
        }, 0.6, EasingStyle.Back)
        
        CreateTween(self.Background, {
            BackgroundTransparency = self.Config.BackgroundTransparency
        }, 0.6)
        
        if self.FAB then
            CreateTween(self.FAB, {
                ImageTransparency = 0.7,
                BackgroundTransparency = 0.7
            }, 0.3)
        end
        
        -- Animate logo
        if self.Config.Animations then
            CreateTween(self.Logo, {
                Rotation = 360
            }, 1, EasingStyle.Quint)
            task.wait(1)
            self.Logo.Rotation = 0
        end
    else
        -- Hide menu
        CreateTween(self.Container, {
            Position = UDim2.new(0.5, 0, 0.5, -80),
            BackgroundTransparency = 1
        }, 0.4, EasingStyle.Quad)
        
        CreateTween(self.Background, {
            BackgroundTransparency = 1
        }, 0.4)
        
        if self.FAB then
            CreateTween(self.FAB, {
                ImageTransparency = 0,
                BackgroundTransparency = 0
            }, 0.3)
        end
        
        task.wait(0.4)
        self.Container.Visible = false
    end
end

-- Section Creation
function Nova:Section(name, icon)
    local sectionId = #self.Sections + 1
    local theme = self.CurrentTheme
    
    -- Create sidebar button (desktop only)
    local button, buttonText
    if not self.IsMobile then
        button = SafeCreate("TextButton", {
            Name = name .. "Button",
            Parent = self.SectionList,
            Size = UDim2.new(1, 0, 0, 52),
            BackgroundColor3 = theme.Surface2,
            AutoButtonColor = false,
            Text = "",
            LayoutOrder = sectionId
        })
        
        SafeCreate("UICorner", {
            CornerRadius = UDim.new(0, 14),
            Parent = button
        })
        
        SafeCreate("UIStroke", {
            Color = theme.Border,
            Thickness = 1,
            Transparency = 0.3,
            Parent = button
        })
        
        -- Icon
        local iconLabel = SafeCreate("TextLabel", {
            Parent = button,
            AnchorPoint = Vector2.new(0, 0.5),
            Position = UDim2.new(0, 18, 0.5, 0),
            Size = UDim2.new(0, 30, 0, 30),
            BackgroundTransparency = 1,
            Text = icon or "‚≠ê",
            TextColor3 = theme.SubText,
            Font = Font.GothamBold,
            TextSize = 20
        })
        
        buttonText = SafeCreate("TextLabel", {
            Parent = button,
            AnchorPoint = Vector2.new(0, 0.5),
            Position = UDim2.new(0, 60, 0.5, 0),
            Size = UDim2.new(1, -60, 1, 0),
            BackgroundTransparency = 1,
            Text = name,
            TextColor3 = theme.SubText,
            Font = Font.GothamMedium,
            TextSize = 16,
            TextXAlignment = Enum.TextXAlignment.Left
        })
    end
    
    -- Create content frame
    local contentFrame = SafeCreate("Frame", {
        Name = name .. "Content",
        Parent = self.ContentScroller,
        Size = UDim2.new(1, 0, 0, 0),
        BackgroundTransparency = 1,
        LayoutOrder = sectionId,
        Visible = sectionId == 1
    })
    
    local contentLayout = SafeCreate("UIListLayout", {
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 25)
    })
    contentLayout.Parent = contentFrame
    
    contentLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        if contentFrame then
            contentFrame.Size = UDim2.new(1, 0, 0, contentLayout.AbsoluteContentSize.Y)
        end
    end)
    
    -- Set first section as active
    if sectionId == 1 then
        self.ActiveSection = contentFrame
        if button then
            button.BackgroundColor3 = theme.AccentColor
            if buttonText then
                buttonText.TextColor3 = Color3.new(1, 1, 1)
            end
        end
    end
    
    -- Button click handler
    if button then
        button.MouseButton1Click:Connect(function()
            if self.ActiveSection then
                self.ActiveSection.Visible = false
            end
            
            -- Reset all buttons
            for _, btn in ipairs(self.SectionList:GetChildren()) do
                if btn:IsA("TextButton") then
                    local txt = btn:FindFirstChildWhichIsA("TextLabel", true)
                    if txt then
                        CreateTween(btn, {BackgroundColor3 = theme.Surface2})
                        CreateTween(txt, {TextColor3 = theme.SubText})
                    end
                end
            end
            
            -- Activate selected
            contentFrame.Visible = true
            self.ActiveSection = contentFrame
            
            if button then
                CreateTween(button, {BackgroundColor3 = theme.AccentColor})
                if buttonText then
                    CreateTween(buttonText, {TextColor3 = Color3.new(1, 1, 1)})
                end
            end
            
            -- Scroll to top
            self.ContentScroller.CanvasPosition = Vector2.new(0, 0)
        end)
        
        -- Hover effects
        button.MouseEnter:Connect(function()
            if contentFrame ~= self.ActiveSection then
                CreateTween(button, {BackgroundColor3 = theme.Hover})
            end
        end)
        
        button.MouseLeave:Connect(function()
            if contentFrame ~= self.ActiveSection then
                CreateTween(button, {BackgroundColor3 = theme.Surface2})
            end
        end)
    end
    
    -- Store section
    local sectionData = {
        Name = name,
        Button = button,
        Frame = contentFrame,
        ContainerWidgets = {}
    }
    
    table.insert(self.Sections, sectionData)
    
    -- Section API
    local api = {}
    local parentTheme = theme
    
    function api:Container(title, subtitle)
        local container = SafeCreate("Frame", {
            Parent = contentFrame,
            Size = UDim2.new(1, 0, 0, 0),
            BackgroundTransparency = 1,
            LayoutOrder = #contentFrame:GetChildren() + 1
        })
        
        local containerLayout = SafeCreate("UIListLayout", {
            SortOrder = Enum.SortOrder.LayoutOrder,
            Padding = UDim.new(0, 20)
        })
        containerLayout.Parent = container
        
        local containerWidgets = {}
        
        containerLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
            if container then
                container.Size = UDim2.new(1, 0, 0, containerLayout.AbsoluteContentSize.Y)
            end
        end)
        
        -- Container header
        if title then
            local titleFrame = SafeCreate("Frame", {
                Parent = container,
                Size = UDim2.new(1, 0, 0, subtitle and 70 or 50),
                BackgroundTransparency = 1,
                LayoutOrder = 0
            })
            
            local titleLabel = SafeCreate("TextLabel", {
                Parent = titleFrame,
                AnchorPoint = Vector2.new(0, 0),
                Position = UDim2.new(0, 0, 0, 0),
                Size = UDim2.new(1, 0, 0, 40),
                BackgroundTransparency = 1,
                Text = "  " .. title,
                TextColor3 = parentTheme.Text,
                Font = Font.GothamBold,
                TextSize = 22,
                TextXAlignment = Enum.TextXAlignment.Left
            })
            
            -- Accent line
            local accentLine = SafeCreate("Frame", {
                Parent = titleFrame,
                AnchorPoint = Vector2.new(0, 1),
                Position = UDim2.new(0, 0, 0, 40),
                Size = UDim2.new(0.3, 0, 0, 3),
                BackgroundColor3 = parentTheme.AccentColor,
                BorderSizePixel = 0
            })
            
            SafeCreate("UICorner", {
                CornerRadius = UDim.new(1, 0),
                Parent = accentLine
            })
            
            if subtitle then
                SafeCreate("TextLabel", {
                    Parent = titleFrame,
                    AnchorPoint = Vector2.new(0, 0),
                    Position = UDim2.new(0, 0, 0, 45),
                    Size = UDim2.new(1, 0, 0, 20),
                    BackgroundTransparency = 1,
                    Text = "  " .. subtitle,
                    TextColor3 = parentTheme.SubText,
                    Font = Font.Gotham,
                    TextSize = 14,
                    TextXAlignment = Enum.TextXAlignment.Left
                })
            end
        end
        
        local containerAPI = {}
        
        -- Button Widget
        function containerAPI:Button(text, callback, icon, color)
            local buttonFrame = SafeCreate("Frame", {
                Parent = container,
                Size = UDim2.new(1, 0, 0, 56),
                BackgroundTransparency = 1
            })
            
            local buttonWidget = SafeCreate("TextButton", {
                Parent = buttonFrame,
                Size = UDim2.new(1, 0, 0, 56),
                BackgroundColor3 = color or parentTheme.Surface,
                AutoButtonColor = false,
                Text = (icon or "‚ö°") .. "  " .. text,
                TextColor3 = parentTheme.Text,
                Font = Font.GothamMedium,
                TextSize = 16
            })
            
            SafeCreate("UICorner", {
                CornerRadius = UDim.new(0, 16),
                Parent = buttonWidget
            })
            
            SafeCreate("UIStroke", {
                Parent = buttonWidget,
                Color = parentTheme.Border,
                Thickness = 1,
                Transparency = 0.5
            })
            
            -- Hover effect
            buttonWidget.MouseEnter:Connect(function()
                CreateTween(buttonWidget, {
                    BackgroundColor3 = parentTheme.Hover,
                    TextColor3 = parentTheme.AccentColor
                }, 0.2)
            end)
            
            buttonWidget.MouseLeave:Connect(function()
                CreateTween(buttonWidget, {
                    BackgroundColor3 = color or parentTheme.Surface,
                    TextColor3 = parentTheme.Text
                }, 0.2)
            end)
            
            -- Click animation
            buttonWidget.MouseButton1Click:Connect(function()
                CreateTween(buttonWidget, {
                    BackgroundColor3 = parentTheme.AccentColor,
                    TextColor3 = Color3.new(1, 1, 1),
                    Size = UDim2.new(0.98, 0, 0, 56)
                }, 0.1)
                
                task.wait(0.1)
                
                CreateTween(buttonWidget, {
                    BackgroundColor3 = color or parentTheme.Surface,
                    TextColor3 = parentTheme.Text,
                    Size = UDim2.new(1, 0, 0, 56)
                }, 0.1)
                
                if callback then
                    local success, err = pcall(callback)
                    if not success and Nova.Debug then
                        warn("[Nova UI] Button error:", err)
                    end
                end
            end)
            
            local buttonObj = {
                Instance = buttonWidget,
                SetText = function(self, newText)
                    buttonWidget.Text = newText
                    return self
                end,
                SetColor = function(self, newColor)
                    buttonWidget.BackgroundColor3 = newColor
                    return self
                end,
                Destroy = function(self)
                    buttonWidget:Destroy()
                end
            }
            
            table.insert(containerWidgets, buttonObj)
            table.insert(self.WidgetInstances, buttonWidget)
            return buttonObj
        end
        
        -- Toggle Widget (FIXED - –Ω–µ—Ç self.Widgets)
        function containerAPI:Toggle(text, default, callback, icon)
            local toggleFrame = SafeCreate("Frame", {
                Parent = container,
                Size = UDim2.new(1, 0, 0, 50),
                BackgroundTransparency = 1
            })
            
            local label = SafeCreate("TextLabel", {
                Parent = toggleFrame,
                AnchorPoint = Vector2.new(0, 0.5),
                Position = UDim2.new(0, 0, 0.5, 0),
                Size = UDim2.new(0.7, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = (icon or "üîò") .. "  " .. text,
                TextColor3 = parentTheme.Text,
                Font = Font.GothamMedium,
                TextSize = 16,
                TextXAlignment = Enum.TextXAlignment.Left
            })
            
            local toggleButton = SafeCreate("TextButton", {
                Parent = toggleFrame,
                AnchorPoint = Vector2.new(1, 0.5),
                Position = UDim2.new(1, 0, 0.5, 0),
                Size = UDim2.new(0, 65, 0, 34),
                BackgroundColor3 = default and parentTheme.AccentColor or parentTheme.Surface,
                AutoButtonColor = false,
                Text = ""
            })
            
            SafeCreate("UICorner", {
                CornerRadius = UDim.new(1, 0),
                Parent = toggleButton
            })
            
            SafeCreate("UIStroke", {
                Parent = toggleButton,
                Color = parentTheme.Border,
                Thickness = 1
            })
            
            local toggleCircle = SafeCreate("Frame", {
                Parent = toggleButton,
                AnchorPoint = Vector2.new(default and 1 or 0, 0.5),
                Position = default and UDim2.new(1, -18, 0.5, 0) or UDim2.new(0, 18, 0.5, 0),
                Size = UDim2.new(0, 26, 0, 26),
                BackgroundColor3 = Color3.new(1, 1, 1)
            })
            
            SafeCreate("UICorner", {
                CornerRadius = UDim.new(1, 0),
                Parent = toggleCircle
            })
            
            SafeCreate("UIStroke", {
                Parent = toggleCircle,
                Color = parentTheme.AccentColor,
                Thickness = 2
            })
            
            local state = default or false
            
            toggleButton.MouseButton1Click:Connect(function()
                state = not state
                
                if state then
                    CreateTween(toggleButton, {BackgroundColor3 = parentTheme.AccentColor})
                    CreateTween(toggleCircle, {Position = UDim2.new(1, -18, 0.5, 0)})
                else
                    CreateTween(toggleButton, {BackgroundColor3 = parentTheme.Surface})
                    CreateTween(toggleCircle, {Position = UDim2.new(0, 18, 0.5, 0)})
                end
                
                if callback then
                    local success, err = pcall(callback, state)
                    if not success and Nova.Debug then
                        warn("[Nova UI] Toggle error:", err)
                    end
                end
            end)
            
            local toggleObj = {
                Instance = toggleButton,
                Set = function(self, value)
                    if type(value) == "boolean" and value ~= state then
                        state = value
                        toggleButton.MouseButton1Click:Fire()
                    end
                    return self
                end,
                Get = function(self)
                    return state
                end,
                Destroy = function(self)
                    toggleButton:Destroy()
                end
            }
            
            table.insert(containerWidgets, toggleObj)
            table.insert(self.WidgetInstances, toggleButton)
            return toggleObj
        end
        
        -- Slider Widget (FIXED)
        function containerAPI:Slider(text, min, max, default, callback, precision, icon)
            precision = precision or 0
            
            local sliderFrame = SafeCreate("Frame", {
                Parent = container,
                Size = UDim2.new(1, 0, 0, 85),
                BackgroundTransparency = 1
            })
            
            local topRow = SafeCreate("Frame", {
                Parent = sliderFrame,
                Size = UDim2.new(1, 0, 0, 30),
                BackgroundTransparency = 1
            })
            
            local label = SafeCreate("TextLabel", {
                Parent = topRow,
                AnchorPoint = Vector2.new(0, 0.5),
                Position = UDim2.new(0, 0, 0.5, 0),
                Size = UDim2.new(0.6, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = (icon or "üìä") .. "  " .. text,
                TextColor3 = parentTheme.Text,
                Font = Font.GothamMedium,
                TextSize = 16,
                TextXAlignment = Enum.TextXAlignment.Left
            })
            
            local valueLabel = SafeCreate("TextLabel", {
                Parent = topRow,
                AnchorPoint = Vector2.new(1, 0.5),
                Position = UDim2.new(1, 0, 0.5, 0),
                Size = UDim2.new(0.4, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = string.format("%." .. precision .. "f", default or min),
                TextColor3 = parentTheme.AccentColor,
                Font = Font.GothamBold,
                TextSize = 16,
                TextXAlignment = Enum.TextXAlignment.Right
            })
            
            local track = SafeCreate("Frame", {
                Parent = sliderFrame,
                Position = UDim2.new(0, 0, 0, 45),
                Size = UDim2.new(1, 0, 0, 10),
                BackgroundColor3 = parentTheme.Surface
            })
            
            SafeCreate("UICorner", {
                CornerRadius = UDim.new(1, 0),
                Parent = track
            })
            
            SafeCreate("UIStroke", {
                Parent = track,
                Color = parentTheme.Border,
                Thickness = 1
            })
            
            local fill = SafeCreate("Frame", {
                Parent = track,
                Size = UDim2.new(0, 0, 1, 0),
                BackgroundColor3 = parentTheme.AccentColor
            })
            
            SafeCreate("UICorner", {
                CornerRadius = UDim.new(1, 0),
                Parent = fill
            })
            
            local handle = SafeCreate("Frame", {
                Parent = track,
                AnchorPoint = Vector2.new(0.5, 0.5),
                Position = UDim2.new(0, 0, 0.5, 0),
                Size = UDim2.new(0, 28, 0, 28),
                BackgroundColor3 = Color3.new(1, 1, 1),
                ZIndex = 2
            })
            
            SafeCreate("UICorner", {
                CornerRadius = UDim.new(1, 0),
                Parent = handle
            })
            
            SafeCreate("UIStroke", {
                Parent = handle,
                Color = parentTheme.AccentColor,
                Thickness = 3
            })
            
            local value = math.clamp(default or min, min, max)
            local dragging = false
            
            local function updateSlider(mouseX)
                local absoluteX = track.AbsolutePosition.X
                local absoluteWidth = track.AbsoluteSize.X
                
                if not absoluteX or not absoluteWidth then return end
                
                local relativeX = math.clamp(mouseX - absoluteX, 0, absoluteWidth)
                local percentage = relativeX / absoluteWidth
                
                if precision == 0 then
                    value = math.floor(min + (max - min) * percentage)
                else
                    value = min + (max - min) * percentage
                    value = math.floor(value * (10 ^ precision)) / (10 ^ precision)
                end
                
                fill.Size = UDim2.new(percentage, 0, 1, 0)
                handle.Position = UDim2.new(percentage, 0, 0.5, 0)
                valueLabel.Text = string.format("%." .. precision .. "f", value)
                
                if callback then
                    local success, err = pcall(callback, value)
                    if not success and Nova.Debug then
                        warn("[Nova UI] Slider error:", err)
                    end
                end
            end
            
            -- Set initial value
            local initialPercentage = (value - min) / (max - min)
            fill.Size = UDim2.new(initialPercentage, 0, 1, 0)
            handle.Position = UDim2.new(initialPercentage, 0, 0.5, 0)
            
            -- Input handlers
            local function beginDrag()
                dragging = true
            end
            
            local function endDrag()
                dragging = false
            end
            
            handle.InputBegan:Connect(function(input)
                if input.UserInputType == UserInputType.MouseButton1 or 
                   input.UserInputType == UserInputType.Touch then
                    beginDrag()
                end
            end)
            
            handle.InputEnded:Connect(function(input)
                if input.UserInputType == UserInputType.MouseButton1 or 
                   input.UserInputType == UserInputType.Touch then
                    endDrag()
                end
            end)
            
            track.InputBegan:Connect(function(input)
                if input.UserInputType == UserInputType.MouseButton1 or 
                   input.UserInputType == UserInputType.Touch then
                    beginDrag()
                    updateSlider(input.Position.X)
                end
            end)
            
            local conn = UserInputService.InputChanged:Connect(function(input)
                if dragging and (input.UserInputType == UserInputType.MouseMovement or 
                   input.UserInputType == UserInputType.Touch) then
                    updateSlider(input.Position.X)
                end
            end)
            
            table.insert(self.Connections, conn)
            
            local sliderObj = {
                Instance = sliderFrame,
                Set = function(self, newValue)
                    value = math.clamp(newValue, min, max)
                    local percentage = (value - min) / (max - min)
                    fill.Size = UDim2.new(percentage, 0, 1, 0)
                    handle.Position = UDim2.new(percentage, 0, 0.5, 0)
                    valueLabel.Text = string.format("%." .. precision .. "f", value)
                    return self
                end,
                Get = function(self)
                    return value
                end,
                Destroy = function(self)
                    if conn then
                        conn:Disconnect()
                    end
                    sliderFrame:Destroy()
                end
            }
            
            table.insert(containerWidgets, sliderObj)
            table.insert(self.WidgetInstances, sliderFrame)
            return sliderObj
        end
        
        -- Dropdown Widget (FIXED)
        function containerAPI:Dropdown(text, options, default, callback, icon)
            local dropdownFrame = SafeCreate("Frame", {
                Parent = container,
                Size = UDim2.new(1, 0, 0, 56),
                BackgroundTransparency = 1
            })
            
            local label = SafeCreate("TextLabel", {
                Parent = dropdownFrame,
                AnchorPoint = Vector2.new(0, 0.5),
                Position = UDim2.new(0, 0, 0.5, 0),
                Size = UDim2.new(0.3, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = (icon or "üìã") .. "  " .. text,
                TextColor3 = parentTheme.Text,
                Font = Font.GothamMedium,
                TextSize = 16,
                TextXAlignment = Enum.TextXAlignment.Left
            })
            
            local dropdownButton = SafeCreate("TextButton", {
                Parent = dropdownFrame,
                AnchorPoint = Vector2.new(1, 0.5),
                Position = UDim2.new(1, 0, 0.5, 0),
                Size = UDim2.new(0.7, 0, 1, 0),
                BackgroundColor3 = parentTheme.Surface,
                AutoButtonColor = false,
                Text = default or "Select...",
                TextColor3 = parentTheme.SubText,
                Font = Font.GothamMedium,
                TextSize = 15
            })
            
            SafeCreate("UICorner", {
                CornerRadius = UDim.new(0, 16),
                Parent = dropdownButton
            })
            
            SafeCreate("UIStroke", {
                Parent = dropdownButton,
                Color = parentTheme.Border,
                Thickness = 1
            })
            
            local dropdownList = SafeCreate("Frame", {
                Parent = self.ScreenGui,
                Size = UDim2.new(0, 220, 0, 0),
                BackgroundColor3 = parentTheme.Surface2,
                Visible = false,
                ZIndex = 1000,
                ClipsDescendants = true
            })
            
            SafeCreate("UICorner", {
                CornerRadius = UDim.new(0, 16),
                Parent = dropdownList
            })
            
            SafeCreate("UIStroke", {
                Parent = dropdownList,
                Color = parentTheme.AccentColor,
                Thickness = 2
            })
            
            local listLayout = SafeCreate("UIListLayout", {
                Parent = dropdownList,
                SortOrder = Enum.SortOrder.LayoutOrder,
                Padding = UDim.new(0, 8)
            })
            
            SafeCreate("UIPadding", {
                Parent = dropdownList,
                PaddingTop = UDim.new(0, 12),
                PaddingBottom = UDim.new(0, 12),
                PaddingLeft = UDim.new(0, 12),
                PaddingRight = UDim.new(0, 12)
            })
            
            local selected = default
            local isOpen = false
            
            local function updateList()
                for _, child in ipairs(dropdownList:GetChildren()) do
                    if child:IsA("TextButton") then
                        child:Destroy()
                    end
                end
                
                for i, option in ipairs(options) do
                    local optionText = tostring(option)
                    local optionButton = SafeCreate("TextButton", {
                        Parent = dropdownList,
                        Size = UDim2.new(1, 0, 0, 42),
                        BackgroundColor3 = parentTheme.Surface2,
                        AutoButtonColor = false,
                        Text = optionText,
                        TextColor3 = parentTheme.Text,
                        Font = Font.Gotham,
                        TextSize = 14,
                        LayoutOrder = i
                    })
                    
                    SafeCreate("UICorner", {
                        CornerRadius = UDim.new(0, 10),
                        Parent = optionButton
                    })
                    
                    if optionText == selected then
                        optionButton.BackgroundColor3 = parentTheme.AccentColor
                        optionButton.TextColor3 = Color3.new(1, 1, 1)
                    end
                    
                    optionButton.MouseEnter:Connect(function()
                        if optionText ~= selected then
                            CreateTween(optionButton, {BackgroundColor3 = parentTheme.Hover}, 0.2)
                        end
                    end)
                    
                    optionButton.MouseLeave:Connect(function()
                        if optionText ~= selected then
                            CreateTween(optionButton, {BackgroundColor3 = parentTheme.Surface2}, 0.2)
                        end
                    end)
                    
                    optionButton.MouseButton1Click:Connect(function()
                        selected = option
                        dropdownButton.Text = optionText
                        dropdownButton.TextColor3 = parentTheme.AccentColor
                        isOpen = false
                        dropdownList.Visible = false
                        
                        if callback then
                            local success, err = pcall(callback, option)
                            if not success and Nova.Debug then
                                warn("[Nova UI] Dropdown error:", err)
                            end
                        end
                    end)
                end
                
                local height = math.min(#options * 50, 300)
                dropdownList.Size = UDim2.new(0, 220, 0, height)
            end
            
            dropdownButton.MouseButton1Click:Connect(function()
                isOpen = not isOpen
                
                if isOpen then
                    local buttonPos = dropdownButton.AbsolutePosition
                    local buttonSize = dropdownButton.AbsoluteSize
                    
                    dropdownList.Position = UDim2.new(
                        0, buttonPos.X,
                        0, buttonPos.Y + buttonSize.Y + 8
                    )
                    
                    updateList()
                    dropdownList.Visible = true
                    CreateTween(dropdownList, {Size = UDim2.new(0, 220, 0, math.min(#options * 50, 300))}, 0.3)
                else
                    CreateTween(dropdownList, {Size = UDim2.new(0, 220, 0, 0)}, 0.2)
                    task.wait(0.2)
                    dropdownList.Visible = false
                end
            end)
            
            -- Close dropdown when clicking outside
            local dropdownConn
            dropdownConn = UserInputService.InputBegan:Connect(function(input)
                if isOpen and input.UserInputType == UserInputType.MouseButton1 then
                    local mousePos = input.Position
                    local listPos = dropdownList.AbsolutePosition
                    local listSize = dropdownList.AbsoluteSize
                    
                    if mousePos.X < listPos.X or mousePos.X > listPos.X + listSize.X or
                       mousePos.Y < listPos.Y or mousePos.Y > listPos.Y + listSize.Y then
                        isOpen = false
                        CreateTween(dropdownList, {Size = UDim2.new(0, 220, 0, 0)}, 0.2)
                        task.wait(0.2)
                        dropdownList.Visible = false
                    end
                end
            end)
            
            table.insert(self.Connections, dropdownConn)
            updateList()
            
            local dropdownObj = {
                Instance = dropdownButton,
                SetOptions = function(self, newOptions)
                    if type(newOptions) == "table" then
                        options = newOptions
                        updateList()
                    end
                    return self
                end,
                Set = function(self, value)
                    selected = value
                    dropdownButton.Text = tostring(value)
                    dropdownButton.TextColor3 = parentTheme.AccentColor
                    return self
                end,
                Get = function(self)
                    return selected
                end,
                Destroy = function(self)
                    if dropdownConn then
                        dropdownConn:Disconnect()
                    end
                    dropdownList:Destroy()
                    dropdownButton:Destroy()
                end
            }
            
            table.insert(containerWidgets, dropdownObj)
            table.insert(self.WidgetInstances, dropdownButton)
            return dropdownObj
        end
        
        -- Textbox Widget (FIXED)
        function containerAPI:Textbox(text, placeholder, callback, defaultValue, icon)
            local textboxFrame = SafeCreate("Frame", {
                Parent = container,
                Size = UDim2.new(1, 0, 0, 56),
                BackgroundTransparency = 1
            })
            
            local label = SafeCreate("TextLabel", {
                Parent = textboxFrame,
                AnchorPoint = Vector2.new(0, 0.5),
                Position = UDim2.new(0, 0, 0.5, 0),
                Size = UDim2.new(0.3, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = (icon or "üìù") .. "  " .. text,
                TextColor3 = parentTheme.Text,
                Font = Font.GothamMedium,
                TextSize = 16,
                TextXAlignment = Enum.TextXAlignment.Left
            })
            
            local textbox = SafeCreate("TextBox", {
                Parent = textboxFrame,
                AnchorPoint = Vector2.new(1, 0.5),
                Position = UDim2.new(1, 0, 0.5, 0),
                Size = UDim2.new(0.7, 0, 1, 0),
                BackgroundColor3 = parentTheme.Surface,
                PlaceholderText = placeholder or "Enter text...",
                Text = defaultValue or "",
                TextColor3 = parentTheme.Text,
                Font = Font.Gotham,
                TextSize = 15,
                ClearTextOnFocus = false
            })
            
            SafeCreate("UICorner", {
                CornerRadius = UDim.new(0, 16),
                Parent = textbox
            })
            
            SafeCreate("UIStroke", {
                Parent = textbox,
                Color = parentTheme.Border,
                Thickness = 1
            })
            
            if callback then
                textbox.FocusLost:Connect(function(enterPressed)
                    local success, err = pcall(callback, textbox.Text, enterPressed)
                    if not success and Nova.Debug then
                        warn("[Nova UI] Textbox error:", err)
                    end
                end)
            end
            
            local textboxObj = {
                Instance = textbox,
                SetText = function(self, value)
                    textbox.Text = value
                    return self
                end,
                GetText = function(self)
                    return textbox.Text
                end,
                SetCallback = function(self, newCallback)
                    if newCallback then
                        textbox.FocusLost:Connect(newCallback)
                    end
                    return self
                end,
                Destroy = function(self)
                    textbox:Destroy()
                end
            }
            
            table.insert(containerWidgets, textboxObj)
            table.insert(self.WidgetInstances, textbox)
            return textboxObj
        end
        
        -- Label Widget
        function containerAPI:Label(text, color, size, align)
            local labelFrame = SafeCreate("Frame", {
                Parent = container,
                Size = UDim2.new(1, 0, 0, size or 40),
                BackgroundTransparency = 1
            })
            
            local labelWidget = SafeCreate("TextLabel", {
                Parent = labelFrame,
                Size = UDim2.new(1, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = text,
                TextColor3 = color or parentTheme.Text,
                Font = Font.Gotham,
                TextSize = size or 16,
                TextXAlignment = align or Enum.TextXAlignment.Left,
                TextWrapped = true
            })
            
            return labelWidget
        end
        
        -- Divider
        function containerAPI:Divider(color)
            local divider = SafeCreate("Frame", {
                Parent = container,
                Size = UDim2.new(1, 0, 0, 2),
                BackgroundColor3 = color or parentTheme.Border,
                BackgroundTransparency = 0.5,
                BorderSizePixel = 0
            })
            
            SafeCreate("UICorner", {
                CornerRadius = UDim.new(1, 0),
                Parent = divider
            })
            
            return divider
        end
        
        -- Store container widgets reference
        sectionData.ContainerWidgets[#sectionData.ContainerWidgets + 1] = containerWidgets
        
        return containerAPI
    end
    
    -- Direct widget methods
    function api:Button(text, callback, icon, color)
        local container = api:Container()
        return container and container:Button(text, callback, icon, color)
    end
    
    function api:Toggle(text, default, callback, icon)
        local container = api:Container()
        return container and container:Toggle(text, default, callback, icon)
    end
    
    function api:Slider(text, min, max, default, callback, precision, icon)
        local container = api:Container()
        return container and container:Slider(text, min, max, default, callback, precision, icon)
    end
    
    function api:Dropdown(text, options, default, callback, icon)
        local container = api:Container()
        return container and container:Dropdown(text, options, default, callback, icon)
    end
    
    function api:Textbox(text, placeholder, callback, defaultValue, icon)
        local container = api:Container()
        return container and container:Textbox(text, placeholder, callback, defaultValue, icon)
    end
    
    function api:Label(text, color, size, align)
        local container = api:Container()
        return container and container:Label(text, color, size, align)
    end
    
    function api:Divider(color)
        local container = api:Container()
        return container and container:Divider(color)
    end
    
    return api
end

-- Apply Theme
function Nova:ApplyTheme()
    if not self.CurrentTheme then return end
    
    local theme = self.CurrentTheme
    
    -- Update UI elements
    if self.Background then
        self.Background.BackgroundColor3 = theme.Background
    end
    
    if self.Header then
        self.Header.BackgroundColor3 = theme.Surface
    end
    
    if self.Title then
        self.Title.TextColor3 = theme.Text
    end
    
    if self.Logo then
        self.Logo.TextColor3 = theme.AccentColor
    end
    
    if self.CloseButton then
        self.CloseButton.BackgroundColor3 = theme.Warning
    end
    
    if self.Sidebar then
        self.Sidebar.BackgroundColor3 = theme.Surface2
    end
    
    if self.FAB then
        self.FAB.BackgroundColor3 = theme.AccentColor
    end
    
    -- Update section buttons
    for _, section in ipairs(self.Sections) do
        if section.Button then
            local textLabel = section.Button:FindFirstChildWhichIsA("TextLabel", true)
            if textLabel then
                if section.Frame == self.ActiveSection then
                    section.Button.BackgroundColor3 = theme.AccentColor
                    textLabel.TextColor3 = Color3.new(1, 1, 1)
                else
                    section.Button.BackgroundColor3 = theme.Surface2
                    textLabel.TextColor3 = theme.SubText
                end
            end
        end
    end
end

-- Cleanup
function Nova:Destroy()
    -- Stop animations
    if self.SnowThread then
        task.cancel(self.SnowThread)
    end
    
    -- Disconnect all connections
    for _, conn in ipairs(self.Connections) do
        if typeof(conn) == "RBXScriptConnection" then
            pcall(conn.Disconnect, conn)
        end
    end
    
    -- Destroy all widget instances
    for _, widget in ipairs(self.WidgetInstances) do
        if widget and widget.Destroy then
            pcall(widget.Destroy, widget)
        end
    end
    
    -- Destroy screen gui
    if self.ScreenGui then
        pcall(self.ScreenGui.Destroy, self.ScreenGui)
    end
    
    -- Remove from active menus
    for i, menu in ipairs(Nova.ActiveMenus) do
        if menu == self then
            table.remove(Nova.ActiveMenus, i)
            break
        end
    end
    
    -- Clear tables
    table.clear(self.Connections)
    table.clear(self.Sections)
    table.clear(self.WidgetInstances)
    table.clear(self.SnowParticles)
    
    -- Clear self
    setmetatable(self, nil)
    for k in pairs(self) do
        self[k] = nil
    end
    
    print("[Nova UI] Menu destroyed")
end

-- Global cleanup
function Nova.CleanupAll()
    for _, menu in ipairs(Nova.ActiveMenus) do
        if menu and menu.Destroy then
            pcall(menu.Destroy, menu)
        end
    end
    table.clear(Nova.ActiveMenus)
    print("[Nova UI] All menus cleaned up")
end

return Nova
