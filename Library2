
local ModMenuLib = {}

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local Lighting = game:GetService("Lighting")
local HttpService = game:GetService("HttpService")
local CoreGui = game:GetService("CoreGui")
local StarterGui = game:GetService("StarterGui")

-- Player
local LocalPlayer = Players.LocalPlayer

-- Generate unique ID
local MENU_ID = "ModMenu_" .. HttpService:GenerateGUID(false):sub(1, 8)

-- Configuration
local CONFIG = {
    MenuColor = Color3.fromRGB(28, 28, 35),
    AccentColor = Color3.fromRGB(0, 170, 255),
    TextColor = Color3.fromRGB(240, 240, 245),
    SecondaryColor = Color3.fromRGB(40, 40, 48),
    Font = Enum.Font.GothamMedium,
    TitleFont = Enum.Font.GothamBold,
    Transparency = 0.08,
    CornerRadius = 10
}

-- Menu variables
ModMenuLib.Menu = nil
ModMenuLib.Folder = nil
ModMenuLib.SettingsGUI = nil
ModMenuLib.OpenButton = nil
ModMenuLib.Connections = {}
ModMenuLib.EnabledFeatures = {}
ModMenuLib.ESPItems = {}
ModMenuLib.AimItems = {}
ModMenuLib.VisualItems = {}
ModMenuLib.ActiveDropdown = nil
ModMenuLib.Sections = {}
ModMenuLib.CurrentSection = nil

-- Utility functions
local function CreateDraggable(frame, handle)
    local dragging = false
    local dragInput, dragStart, startPos
    
    local function Update(input)
        local delta = input.Position - dragStart
        frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
    
    handle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    handle.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input == dragInput) then
            Update(input)
        end
    end)
end

local function CreateRippleEffect(button)
    local ripple = Instance.new("Frame")
    ripple.Name = "Ripple"
    ripple.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    ripple.BackgroundTransparency = 0.8
    ripple.Size = UDim2.new(0, 0, 0, 0)
    ripple.Position = UDim2.new(0.5, 0, 0.5, 0)
    ripple.AnchorPoint = Vector2.new(0.5, 0.5)
    ripple.ZIndex = 10
    ripple.Parent = button
    
    local mousePos = UserInputService:GetMouseLocation()
    local buttonPos = button.AbsolutePosition
    local relativePos = Vector2.new(mousePos.X - buttonPos.X, mousePos.Y - buttonPos.Y)
    
    ripple.Position = UDim2.new(0, relativePos.X, 0, relativePos.Y)
    
    local tween = TweenService:Create(ripple, TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
        Size = UDim2.new(2, 0, 2, 0),
        BackgroundTransparency = 1
    })
    
    tween:Play()
    tween.Completed:Connect(function()
        ripple:Destroy()
    end)
end

-- Background floating text with different movements
local function CreateFloatingText(parent, text, position, index)
    local label = Instance.new("TextLabel")
    label.Name = "FloatingText_" .. index
    label.Text = text
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextTransparency = 0.85
    label.Font = Enum.Font.GothamBold
    label.TextSize = 24
    label.BackgroundTransparency = 1
    label.Size = UDim2.new(0, 150, 0, 40)
    label.Position = position
    label.ZIndex = 0
    label.Parent = parent
    
    -- Different movement patterns based on index
    local patterns = {
        {speedX = 0.02, speedY = 0.015, radiusX = 80, radiusY = 60, offsetX = 0, offsetY = 0},  -- Top Left
        {speedX = -0.025, speedY = 0.018, radiusX = 90, radiusY = 70, offsetX = math.pi/3, offsetY = math.pi/4},  -- Top Right
        {speedX = 0.018, speedY = -0.022, radiusX = 70, radiusY = 80, offsetX = math.pi/2, offsetY = math.pi/3},  -- Bottom Left
        {speedX = -0.015, speedY = -0.02, radiusX = 85, radiusY = 65, offsetX = math.pi, offsetY = math.pi/2},  -- Bottom Right
        {speedX = 0.03, speedY = 0.025, radiusX = 100, radiusY = 80, offsetX = math.pi/4, offsetY = math.pi/6}  -- Center
    }
    
    local pattern = patterns[index] or patterns[1]
    local time = 0
    local centerX, centerY
    
    local connection = RunService.RenderStepped:Connect(function(delta)
        time = time + delta
        
        if not centerX then
            centerX = label.AbsolutePosition.X + label.AbsoluteSize.X/2
            centerY = label.AbsolutePosition.Y + label.AbsoluteSize.Y/2
        end
        
        -- Complex elliptical movement
        local x = centerX + math.cos(time * pattern.speedX + pattern.offsetX) * pattern.radiusX
        local y = centerY + math.sin(time * pattern.speedY + pattern.offsetY) * pattern.radiusY
        
        label.Position = UDim2.new(0, x, 0, y)
        
        -- Smooth transparency wave
        label.TextTransparency = 0.7 + math.sin(time * 2) * 0.2
        
        -- Slight rotation
        label.Rotation = math.sin(time * 1.5) * 3
    end)
    
    return {label = label, connection = connection}
end

-- UI Components with proper layout
function ModMenuLib:CreateButton(parent, text, callback)
    local buttonFrame = Instance.new("Frame")
    buttonFrame.Name = "ButtonFrame_" .. text:gsub("%s+", "_")
    buttonFrame.BackgroundTransparency = 1
    buttonFrame.Size = UDim2.new(1, -20, 0, 42)
    buttonFrame.Parent = parent
    
    local button = Instance.new("TextButton")
    button.Name = "Button"
    button.Text = text
    button.TextColor3 = CONFIG.TextColor
    button.Font = CONFIG.Font
    button.TextSize = 14
    button.BackgroundColor3 = CONFIG.SecondaryColor
    button.BorderSizePixel = 0
    button.Size = UDim2.new(1, 0, 1, 0)
    button.AutoButtonColor = false
    button.Parent = buttonFrame
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, CONFIG.CornerRadius)
    corner.Parent = button
    
    local stroke = Instance.new("UIStroke")
    stroke.Color = CONFIG.AccentColor
    stroke.Thickness = 1
    stroke.Transparency = 0.7
    stroke.Parent = button
    
    button.MouseEnter:Connect(function()
        TweenService:Create(button, TweenInfo.new(0.2), {
            BackgroundColor3 = Color3.fromRGB(50, 50, 58)
        }):Play()
        TweenService:Create(stroke, TweenInfo.new(0.2), {
            Transparency = 0.3
        }):Play()
    end)
    
    button.MouseLeave:Connect(function()
        TweenService:Create(button, TweenInfo.new(0.2), {
            BackgroundColor3 = CONFIG.SecondaryColor
        }):Play()
        TweenService:Create(stroke, TweenInfo.new(0.2), {
            Transparency = 0.7
        }):Play()
    end)
    
    button.MouseButton1Click:Connect(function()
        CreateRippleEffect(button)
        callback()
    end)
    
    button.TouchTap:Connect(function()
        CreateRippleEffect(button)
        callback()
    end)
    
    return buttonFrame
end

function ModMenuLib:CreateToggle(parent, text, default, callback)
    local toggleFrame = Instance.new("Frame")
    toggleFrame.Name = "Toggle_" .. text:gsub("%s+", "_")
    toggleFrame.BackgroundTransparency = 1
    toggleFrame.Size = UDim2.new(1, -20, 0, 42)
    toggleFrame.Parent = parent
    
    local label = Instance.new("TextLabel")
    label.Name = "Label"
    label.Text = text
    label.TextColor3 = CONFIG.TextColor
    label.Font = CONFIG.Font
    label.TextSize = 14
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.BackgroundTransparency = 1
    label.Size = UDim2.new(0.7, 0, 1, 0)
    label.Position = UDim2.new(0, 0, 0, 0)
    label.Parent = toggleFrame
    
    local toggleButton = Instance.new("TextButton")
    toggleButton.Name = "ToggleButton"
    toggleButton.Text = ""
    toggleButton.BackgroundColor3 = default and CONFIG.AccentColor or CONFIG.SecondaryColor
    toggleButton.Size = UDim2.new(0, 48, 0, 26)
    toggleButton.Position = UDim2.new(1, -48, 0.5, -13)
    toggleButton.AutoButtonColor = false
    toggleButton.Parent = toggleFrame
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 13)
    corner.Parent = toggleButton
    
    local toggleCircle = Instance.new("Frame")
    toggleCircle.Name = "ToggleCircle"
    toggleCircle.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    toggleCircle.Size = UDim2.new(0, 20, 0, 20)
    toggleCircle.Position = default and UDim2.new(1, -24, 0.5, -10) or UDim2.new(0, 4, 0.5, -10)
    toggleCircle.Parent = toggleButton
    
    local corner2 = Instance.new("UICorner")
    corner2.CornerRadius = UDim.new(1, 0)
    corner2.Parent = toggleCircle
    
    local isToggled = default
    
    local function UpdateToggle()
        local tweenInfo = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
        local tween = TweenService:Create(toggleCircle, tweenInfo, {
            Position = isToggled and UDim2.new(1, -24, 0.5, -10) or UDim2.new(0, 4, 0.5, -10)
        })
        
        TweenService:Create(toggleButton, tweenInfo, {
            BackgroundColor3 = isToggled and CONFIG.AccentColor or CONFIG.SecondaryColor
        }):Play()
        
        tween:Play()
        callback(isToggled)
    end
    
    toggleButton.MouseButton1Click:Connect(function()
        isToggled = not isToggled
        UpdateToggle()
    end)
    
    toggleButton.TouchTap:Connect(function()
        isToggled = not isToggled
        UpdateToggle()
    end)
    
    UpdateToggle()
    
    return {
        Set = function(value)
            isToggled = value
            UpdateToggle()
        end,
        Get = function()
            return isToggled
        end
    }
end

function ModMenuLib:CreateSlider(parent, text, min, max, default, callback)
    local sliderFrame = Instance.new("Frame")
    sliderFrame.Name = "Slider_" .. text:gsub("%s+", "_")
    sliderFrame.BackgroundTransparency = 1
    sliderFrame.Size = UDim2.new(1, -20, 0, 62)
    sliderFrame.Parent = parent
    
    local label = Instance.new("TextLabel")
    label.Name = "Label"
    label.Text = text .. ": " .. default
    label.TextColor3 = CONFIG.TextColor
    label.Font = CONFIG.Font
    label.TextSize = 14
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.BackgroundTransparency = 1
    label.Size = UDim2.new(1, 0, 0, 22)
    label.Position = UDim2.new(0, 0, 0, 0)
    label.Parent = sliderFrame
    
    local sliderBack = Instance.new("Frame")
    sliderBack.Name = "SliderBack"
    sliderBack.BackgroundColor3 = CONFIG.SecondaryColor
    sliderBack.Size = UDim2.new(1, 0, 0, 6)
    sliderBack.Position = UDim2.new(0, 0, 0, 32)
    sliderBack.Parent = sliderFrame
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(1, 0)
    corner.Parent = sliderBack
    
    local sliderFill = Instance.new("Frame")
    sliderFill.Name = "SliderFill"
    sliderFill.BackgroundColor3 = CONFIG.AccentColor
    sliderFill.Size = UDim2.new((default - min) / (max - min), 0, 1, 0)
    sliderFill.Position = UDim2.new(0, 0, 0, 0)
    sliderFill.Parent = sliderBack
    
    local corner2 = Instance.new("UICorner")
    corner2.CornerRadius = UDim.new(1, 0)
    corner2.Parent = sliderFill
    
    local sliderButton = Instance.new("TextButton")
    sliderButton.Name = "SliderButton"
    sliderButton.Text = ""
    sliderButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    sliderButton.Size = UDim2.new(0, 18, 0, 18)
    sliderButton.Position = UDim2.new((default - min) / (max - min), -9, 0.5, -9)
    sliderButton.ZIndex = 2
    sliderButton.AutoButtonColor = false
    sliderButton.Parent = sliderBack
    
    local corner3 = Instance.new("UICorner")
    corner3.CornerRadius = UDim.new(1, 0)
    corner3.Parent = sliderButton
    
    local isDragging = false
    local currentValue = default
    
    local function UpdateSlider(value)
        local normalized = math.clamp((value - min) / (max - min), 0, 1)
        
        TweenService:Create(sliderFill, TweenInfo.new(0.1), {
            Size = UDim2.new(normalized, 0, 1, 0)
        }):Play()
        
        TweenService:Create(sliderButton, TweenInfo.new(0.1), {
            Position = UDim2.new(normalized, -9, 0.5, -9)
        }):Play()
        
        label.Text = text .. ": " .. math.floor(value)
        currentValue = value
        callback(value)
    end
    
    local function CalculateValue(input)
        local relativeX = (input.Position.X - sliderBack.AbsolutePosition.X) / sliderBack.AbsoluteSize.X
        local value = min + (relativeX * (max - min))
        return math.clamp(math.floor(value), min, max)
    end
    
    sliderButton.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            isDragging = true
        end
    end)
    
    sliderButton.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            isDragging = false
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if isDragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local value = CalculateValue(input)
            UpdateSlider(value)
        end
    end)
    
    sliderBack.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseButton1 then
            local value = CalculateValue(input)
            UpdateSlider(value)
            isDragging = true
        end
    end)
    
    sliderBack.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseButton1 then
            isDragging = false
        end
    end)
    
    UpdateSlider(default)
    
    return {
        Set = function(value)
            UpdateSlider(value)
        end,
        Get = function()
            return currentValue
        end
    }
end

function ModMenuLib:CreateDropdown(parent, text, options, default, callback, isPlayerList)
    local dropdownFrame = Instance.new("Frame")
    dropdownFrame.Name = "Dropdown_" .. text:gsub("%s+", "_")
    dropdownFrame.BackgroundTransparency = 1
    dropdownFrame.Size = UDim2.new(1, -20, 0, 42)
    dropdownFrame.ClipsDescendants = true
    dropdownFrame.Parent = parent
    
    local label = Instance.new("TextLabel")
    label.Name = "Label"
    label.Text = text
    label.TextColor3 = CONFIG.TextColor
    label.Font = CONFIG.Font
    label.TextSize = 14
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.BackgroundTransparency = 1
    label.Size = UDim2.new(0.5, 0, 1, 0)
    label.Position = UDim2.new(0, 0, 0, 0)
    label.Parent = dropdownFrame
    
    local dropdownButton = Instance.new("TextButton")
    dropdownButton.Name = "DropdownButton"
    dropdownButton.Text = options[default] or options[1] or "Select..."
    dropdownButton.TextColor3 = CONFIG.TextColor
    dropdownButton.Font = CONFIG.Font
    dropdownButton.TextSize = 12
    dropdownButton.BackgroundColor3 = CONFIG.SecondaryColor
    dropdownButton.Size = UDim2.new(0.45, 0, 1, 0)
    dropdownButton.Position = UDim2.new(0.55, 0, 0, 0)
    dropdownButton.AutoButtonColor = false
    dropdownButton.Parent = dropdownFrame
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, CONFIG.CornerRadius)
    corner.Parent = dropdownButton
    
    local dropdownList = Instance.new("ScrollingFrame")
    dropdownList.Name = "DropdownList"
    dropdownList.BackgroundColor3 = CONFIG.MenuColor
    dropdownList.BorderSizePixel = 0
    dropdownList.Size = UDim2.new(0.45, 0, 0, 0)
    dropdownList.Position = UDim2.new(0.55, 0, 1, 5)
    dropdownList.Visible = false
    dropdownList.ZIndex = 100
    dropdownList.ScrollBarThickness = 3
    dropdownList.Parent = parent.Parent
    
    local listLayout = Instance.new("UIListLayout")
    listLayout.Padding = UDim.new(0, 2)
    listLayout.Parent = dropdownList
    
    local padding = Instance.new("UIPadding")
    padding.PaddingTop = UDim.new(0, 5)
    padding.PaddingBottom = UDim.new(0, 5)
    padding.PaddingLeft = UDim.new(0, 2)
    padding.PaddingRight = UDim.new(0, 2)
    padding.Parent = dropdownList
    
    local isOpen = false
    local selectedIndex = default or 1
    
    local function CloseAllDropdowns()
        if self.ActiveDropdown and self.ActiveDropdown ~= dropdownList then
            TweenService:Create(self.ActiveDropdown, TweenInfo.new(0.2), {
                Size = UDim2.new(0.45, 0, 0, 0)
            }):Play()
            
            task.wait(0.2)
            if self.ActiveDropdown then
                self.ActiveDropdown.Visible = false
            end
        end
        self.ActiveDropdown = dropdownList
    end
    
    local function ToggleDropdown()
        CloseAllDropdowns()
        isOpen = not isOpen
        
        if isOpen then
            dropdownList.Visible = true
            dropdownList.ZIndex = 100
        end
        
        local targetSize = isOpen and UDim2.new(0.45, 0, 0, math.min(#options * 32, 160)) or UDim2.new(0.45, 0, 0, 0)
        TweenService:Create(dropdownList, TweenInfo.new(0.3), {
            Size = targetSize
        }):Play()
        
        if not isOpen then
            task.wait(0.3)
            dropdownList.Visible = false
        end
    end
    
    local function CreateOptionButtons()
        dropdownList:ClearAllChildren()
        
        for i, option in pairs(options) do
            local optionButton = Instance.new("TextButton")
            optionButton.Name = "Option_" .. i
            optionButton.Text = option
            optionButton.TextColor3 = CONFIG.TextColor
            optionButton.Font = CONFIG.Font
            optionButton.TextSize = 12
            optionButton.BackgroundColor3 = CONFIG.SecondaryColor
            optionButton.BackgroundTransparency = 1
            optionButton.Size = UDim2.new(1, -4, 0, 30)
            optionButton.AutoButtonColor = false
            optionButton.ZIndex = 101
            optionButton.Parent = dropdownList
            
            local corner = Instance.new("UICorner")
            corner.CornerRadius = UDim.new(0, 4)
            corner.Parent = optionButton
            
            optionButton.MouseEnter:Connect(function()
                TweenService:Create(optionButton, TweenInfo.new(0.2), {
                    BackgroundTransparency = 0.7
                }):Play()
            end)
            
            optionButton.MouseLeave:Connect(function()
                TweenService:Create(optionButton, TweenInfo.new(0.2), {
                    BackgroundTransparency = 1
                }):Play()
            end)
            
            optionButton.MouseButton1Click:Connect(function()
                dropdownButton.Text = option
                selectedIndex = i
                ToggleDropdown()
                callback(i, option)
            end)
            
            optionButton.TouchTap:Connect(function()
                dropdownButton.Text = option
                selectedIndex = i
                ToggleDropdown()
                callback(i, option)
            end)
        end
    end
    
    CreateOptionButtons()
    
    dropdownButton.MouseButton1Click:Connect(ToggleDropdown)
    dropdownButton.TouchTap:Connect(ToggleDropdown)
    
    local function CloseDropdown(input)
        if isOpen and input.UserInputType == Enum.UserInputType.MouseButton1 then
            local mousePos = input.Position
            local dropdownPos = dropdownList.AbsolutePosition
            local dropdownSize = dropdownList.AbsoluteSize
            
            if mousePos.X < dropdownPos.X or mousePos.X > dropdownPos.X + dropdownSize.X or
               mousePos.Y < dropdownPos.Y or mousePos.Y > dropdownPos.Y + dropdownSize.Y then
                ToggleDropdown()
            end
        end
    end
    
    table.insert(self.Connections, UserInputService.InputBegan:Connect(CloseDropdown))
    
    return {
        Set = function(index)
            if options[index] then
                dropdownButton.Text = options[index]
                selectedIndex = index
                callback(index, options[index])
            end
        end,
        Get = function()
            return selectedIndex
        end,
        UpdateOptions = function(newOptions)
            options = newOptions
            CreateOptionButtons()
        end
    }
end

function ModMenuLib:CreateColorPicker(parent, text, defaultColor, callback)
    local colorFrame = Instance.new("Frame")
    colorFrame.Name = "ColorPicker_" .. text:gsub("%s+", "_")
    colorFrame.BackgroundTransparency = 1
    colorFrame.Size = UDim2.new(1, -20, 0, 52)
    colorFrame.Parent = parent
    
    local label = Instance.new("TextLabel")
    label.Name = "Label"
    label.Text = text
    label.TextColor3 = CONFIG.TextColor
    label.Font = CONFIG.Font
    label.TextSize = 14
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.BackgroundTransparency = 1
    label.Size = UDim2.new(0.5, 0, 0, 22)
    label.Position = UDim2.new(0, 0, 0, 0)
    label.Parent = colorFrame
    
    local colorPreview = Instance.new("TextButton")
    colorPreview.Name = "ColorPreview"
    colorPreview.Text = ""
    colorPreview.BackgroundColor3 = defaultColor
    colorPreview.Size = UDim2.new(0, 36, 0, 36)
    colorPreview.Position = UDim2.new(0.5, 0, 0, 16)
    colorPreview.AutoButtonColor = false
    colorPreview.Parent = colorFrame
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, CONFIG.CornerRadius)
    corner.Parent = colorPreview
    
    local stroke = Instance.new("UIStroke")
    stroke.Color = Color3.fromRGB(255, 255, 255)
    stroke.Thickness = 2
    stroke.Parent = colorPreview
    
    local pickerFrame = Instance.new("Frame")
    pickerFrame.Name = "ColorPickerFrame"
    pickerFrame.BackgroundColor3 = CONFIG.MenuColor
    pickerFrame.BorderSizePixel = 0
    pickerFrame.Size = UDim2.new(0, 220, 0, 180)
    pickerFrame.Position = UDim2.new(0.5, 0, 1, 10)
    pickerFrame.Visible = false
    pickerFrame.ZIndex = 100
    pickerFrame.Parent = parent.Parent
    
    local corner2 = Instance.new("UICorner")
    corner2.CornerRadius = UDim.new(0, CONFIG.CornerRadius)
    corner2.Parent = pickerFrame
    
    local stroke2 = Instance.new("UIStroke")
    stroke2.Color = CONFIG.AccentColor
    stroke2.Thickness = 1
    stroke2.Parent = pickerFrame
    
    local colorGrid = {
        {Color3.fromRGB(255, 50, 50), Color3.fromRGB(255, 100, 50), Color3.fromRGB(255, 150, 50)},
        {Color3.fromRGB(50, 255, 50), Color3.fromRGB(100, 255, 100), Color3.fromRGB(150, 255, 150)},
        {Color3.fromRGB(50, 50, 255), Color3.fromRGB(100, 100, 255), Color3.fromRGB(150, 150, 255)},
        {Color3.fromRGB(255, 50, 255), Color3.fromRGB(255, 255, 50), Color3.fromRGB(50, 255, 255)},
        {Color3.fromRGB(255, 255, 255), Color3.fromRGB(200, 200, 200), Color3.fromRGB(100, 100, 100)}
    }
    
    local isOpen = false
    local currentColor = defaultColor
    
    local function OpenPicker()
        if isOpen then return end
        isOpen = true
        pickerFrame.Visible = true
        pickerFrame.ZIndex = 100
        
        pickerFrame:ClearAllChildren()
        
        for row, colors in pairs(colorGrid) do
            for col, color in pairs(colors) do
                local colorButton = Instance.new("TextButton")
                colorButton.Name = "Color_" .. row .. "_" .. col
                colorButton.Text = ""
                colorButton.BackgroundColor3 = color
                colorButton.Size = UDim2.new(0, 40, 0, 40)
                colorButton.Position = UDim2.new(0, (col-1) * 45 + 15, 0, (row-1) * 45 + 15)
                colorButton.AutoButtonColor = false
                colorButton.ZIndex = 101
                colorButton.Parent = pickerFrame
                
                local corner = Instance.new("UICorner")
                corner.CornerRadius = UDim.new(0, 6)
                corner.Parent = colorButton
                
                local stroke = Instance.new("UIStroke")
                stroke.Color = Color3.fromRGB(255, 255, 255)
                stroke.Thickness = 1
                stroke.Transparency = 0.5
                stroke.Parent = colorButton
                
                colorButton.MouseEnter:Connect(function()
                    TweenService:Create(stroke, TweenInfo.new(0.2), {
                        Transparency = 0
                    }):Play()
                end)
                
                colorButton.MouseLeave:Connect(function()
                    TweenService:Create(stroke, TweenInfo.new(0.2), {
                        Transparency = 0.5
                    }):Play()
                end)
                
                colorButton.MouseButton1Click:Connect(function()
                    currentColor = color
                    colorPreview.BackgroundColor3 = color
                    pickerFrame.Visible = false
                    isOpen = false
                    callback(color)
                end)
                
                colorButton.TouchTap:Connect(function()
                    currentColor = color
                    colorPreview.BackgroundColor3 = color
                    pickerFrame.Visible = false
                    isOpen = false
                    callback(color)
                end)
            end
        end
    end
    
    local function ClosePicker(input)
        if isOpen and input.UserInputType == Enum.UserInputType.MouseButton1 then
            local mousePos = input.Position
            local pickerPos = pickerFrame.AbsolutePosition
            local pickerSize = pickerFrame.AbsoluteSize
            
            if mousePos.X < pickerPos.X or mousePos.X > pickerPos.X + pickerSize.X or
               mousePos.Y < pickerPos.Y or mousePos.Y > pickerPos.Y + pickerSize.Y then
                pickerFrame.Visible = false
                isOpen = false
            end
        end
    end
    
    colorPreview.MouseButton1Click:Connect(OpenPicker)
    colorPreview.TouchTap:Connect(OpenPicker)
    
    table.insert(self.Connections, UserInputService.InputBegan:Connect(ClosePicker))
    
    return {
        Set = function(color)
            currentColor = color
            colorPreview.BackgroundColor3 = color
            callback(color)
        end,
        Get = function()
            return currentColor
        end
    }
end

function ModMenuLib:CreateLabel(parent, text, size, isTitle)
    local label = Instance.new("TextLabel")
    label.Name = "Label_" .. text:gsub("%s+", "_")
    label.Text = text
    label.TextColor3 = CONFIG.TextColor
    label.Font = isTitle and CONFIG.TitleFont or CONFIG.Font
    label.TextSize = size or 16
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.BackgroundTransparency = 1
    label.Size = UDim2.new(1, -20, 0, size or 30)
    label.Parent = parent
    
    return label
end

-- ESP System
function ModMenuLib:CreateESP(player, settings)
    if not player or not player.Character then return end
    
    local espFolder = Instance.new("Folder")
    espFolder.Name = "ESP_" .. player.Name
    espFolder.Parent = self.Folder
    
    local character = player.Character
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    local humanoid = character:FindFirstChild("Humanoid")
    
    if not humanoidRootPart or not humanoid then return end
    
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "ESPBillboard"
    billboard.Size = UDim2.new(0, 150, 0, 80)
    billboard.StudsOffset = Vector3.new(0, 3.5, 0)
    billboard.AlwaysOnTop = true
    billboard.MaxDistance = settings.MaxDistance or 500
    billboard.Enabled = true
    billboard.Parent = espFolder
    
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Name = "Name"
    nameLabel.Text = player.Name
    nameLabel.TextColor3 = settings.NameColor or Color3.fromRGB(255, 255, 255)
    nameLabel.Font = CONFIG.Font
    nameLabel.TextSize = 12
    nameLabel.BackgroundTransparency = 1
    nameLabel.Size = UDim2.new(1, 0, 0, 18)
    nameLabel.Parent = billboard
    
    local distanceLabel = Instance.new("TextLabel")
    distanceLabel.Name = "Distance"
    distanceLabel.Text = "0m"
    distanceLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    distanceLabel.Font = CONFIG.Font
    distanceLabel.TextSize = 10
    distanceLabel.BackgroundTransparency = 1
    distanceLabel.Size = UDim2.new(1, 0, 0, 14)
    distanceLabel.Parent = billboard
    
    local healthBarBack = Instance.new("Frame")
    healthBarBack.Name = "HealthBarBack"
    healthBarBack.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    healthBarBack.Size = UDim2.new(1, 0, 0, 6)
    healthBarBack.Parent = billboard
    
    local healthBar = Instance.new("Frame")
    healthBar.Name = "HealthBar"
    healthBar.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
    healthBar.Size = UDim2.new(0.5, 0, 1, 0)
    healthBar.Parent = healthBarBack
    
    if settings.BoxESP then
        local boxAdornment = Instance.new("BoxHandleAdornment")
        boxAdornment.Name = "BoxESP"
        boxAdornment.Adornee = humanoidRootPart
        boxAdornment.Size = Vector3.new(4, 6, 2)
        boxAdornment.Color3 = settings.BoxColor or CONFIG.AccentColor
        boxAdornment.Transparency = 0.6
        boxAdornment.AlwaysOnTop = true
        boxAdornment.ZIndex = 1
        boxAdornment.Parent = espFolder
    end
    
    if settings.TracerESP then
        local tracer = Instance.new("LineHandleAdornment")
        tracer.Name = "Tracer"
        tracer.Adornee = humanoidRootPart
        tracer.Length = 50
        tracer.Thickness = 1.5
        tracer.Color3 = settings.TracerColor or Color3.fromRGB(255, 100, 100)
        tracer.Transparency = 0.8
        tracer.Parent = espFolder
    end
    
    local espData = {
        Player = player,
        Folder = espFolder,
        LastUpdate = tick(),
        Update = function()
            if not player or not player.Character then return false end
            
            local now = tick()
            if now - espData.LastUpdate < 0.1 then return true end
            espData.LastUpdate = now
            
            local char = player.Character
            local hrp = char:FindFirstChild("HumanoidRootPart")
            local hum = char:FindFirstChild("Humanoid")
            
            if not hrp or not hum then return false end
            
            if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                local distance = (hrp.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
                distanceLabel.Text = math.floor(distance) .. "m"
                billboard.Enabled = distance <= (settings.MaxDistance or 500)
            end
            
            local healthPercent = hum.Health / hum.MaxHealth
            healthBar.Size = UDim2.new(healthPercent, 0, 1, 0)
            healthBar.BackgroundColor3 = Color3.fromRGB(
                255 * (1 - healthPercent),
                255 * healthPercent,
                0
            )
            
            return true
        end,
        Destroy = function()
            espFolder:Destroy()
        end
    }
    
    self.ESPItems[player] = espData
    return espData
end

function ModMenuLib:UpdateESP()
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            local espData = self.ESPItems[player]
            
            if self.EnabledFeatures.ESP and player.Character then
                if not espData then
                    espData = self:CreateESP(player, self.ESPSettings or {})
                end
                
                if espData then
                    espData:Update()
                end
            elseif espData then
                espData:Destroy()
                self.ESPItems[player] = nil
            end
        end
    end
    
    for player, espData in pairs(self.ESPItems) do
        if not player or not player.Parent then
            espData:Destroy()
            self.ESPItems[player] = nil
        end
    end
end

-- Notification system
function ModMenuLib:ShowNotification(text, color)
    if not self.Menu then return end
    
    local notification = Instance.new("TextLabel")
    notification.Name = "Notification"
    notification.Text = text
    notification.TextColor3 = Color3.fromRGB(255, 255, 255)
    notification.Font = CONFIG.Font
    notification.TextSize = 14
    notification.BackgroundColor3 = color or CONFIG.AccentColor
    notification.BackgroundTransparency = 0.3
    notification.Size = UDim2.new(0, 200, 0, 40)
    notification.Position = UDim2.new(0.5, -100, 1, -50)
    notification.AnchorPoint = Vector2.new(0.5, 0)
    notification.Parent = self.Menu
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, CONFIG.CornerRadius)
    corner.Parent = notification
    
    local stroke = Instance.new("UIStroke")
    stroke.Color = Color3.fromRGB(255, 255, 255)
    stroke.Thickness = 1
    stroke.Parent = notification
    
    notification.Position = UDim2.new(0.5, -100, 1, 10)
    TweenService:Create(notification, TweenInfo.new(0.3), {
        Position = UDim2.new(0.5, -100, 1, -50)
    }):Play()
    
    task.delay(3, function()
        if notification then
            TweenService:Create(notification, TweenInfo.new(0.3), {
                Position = UDim2.new(0.5, -100, 1, 10),
                BackgroundTransparency = 1,
                TextTransparency = 1
            }):Play()
            
            task.wait(0.3)
            if notification then
                notification:Destroy()
            end
        end
    end)
end

-- Main Menu Creation
function ModMenuLib:CreateMenu(title)
    -- Cleanup existing menu
    self:DestroyMenu()
    
    -- Create main folder with unique name
    self.Folder = Instance.new("Folder")
    self.Folder.Name = MENU_ID
    self.Folder.Parent = CoreGui
    
    -- Create open button in StarterGui
    local openGui = Instance.new("ScreenGui")
    openGui.Name = MENU_ID .. "_OpenButton"
    openGui.ResetOnSpawn = false
    openGui.ZIndexBehavior = Enum.ZIndexBehavior.Global
    openGui.DisplayOrder = 9999
    openGui.Parent = StarterGui
    
    self.OpenButton = Instance.new("TextButton")
    self.OpenButton.Name = "OpenMenuButton"
    self.OpenButton.Text = "☰"
    self.OpenButton.TextColor3 = CONFIG.TextColor
    self.OpenButton.Font = Enum.Font.GothamBold
    self.OpenButton.TextSize = 24
    self.OpenButton.BackgroundColor3 = CONFIG.AccentColor
    self.OpenButton.Size = UDim2.new(0, 50, 0, 50)
    self.OpenButton.Position = UDim2.new(0, 20, 0.5, -25)
    self.OpenButton.ZIndex = 10000
    self.OpenButton.AutoButtonColor = false
    self.OpenButton.Parent = openGui
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(1, 0)
    corner.Parent = self.OpenButton
    
    local stroke = Instance.new("UIStroke")
    stroke.Color = Color3.fromRGB(255, 255, 255)
    stroke.Thickness = 2
    stroke.Parent = self.OpenButton
    
    CreateDraggable(self.OpenButton, self.OpenButton)
    
    -- Create main menu
    self.Menu = Instance.new("ScreenGui")
    self.Menu.Name = MENU_ID .. "_GUI"
    self.Menu.ResetOnSpawn = false
    self.Menu.ZIndexBehavior = Enum.ZIndexBehavior.Global
    self.Menu.DisplayOrder = 9998
    self.Menu.Enabled = false  -- Initially hidden
    self.Menu.Parent = self.Folder
    
    -- Background blur
    local blur = Instance.new("BlurEffect")
    blur.Name = "MenuBlur"
    blur.Size = 5
    blur.Enabled = false
    blur.Parent = Lighting
    
    -- Main container
    local mainContainer = Instance.new("Frame")
    mainContainer.Name = "MainContainer"
    mainContainer.BackgroundColor3 = CONFIG.MenuColor
    mainContainer.BackgroundTransparency = CONFIG.Transparency
    mainContainer.Size = UDim2.new(0, 500, 0, 400)
    mainContainer.Position = UDim2.new(0.5, -250, 0.5, -200)
    mainContainer.Parent = self.Menu
    
    local corner2 = Instance.new("UICorner")
    corner2.CornerRadius = UDim.new(0, CONFIG.CornerRadius)
    corner2.Parent = mainContainer
    
    local stroke2 = Instance.new("UIStroke")
    stroke2.Color = CONFIG.AccentColor
    stroke2.Thickness = 2
    stroke2.Parent = mainContainer
    
    -- Title bar
    local titleBar = Instance.new("Frame")
    titleBar.Name = "TitleBar"
    titleBar.BackgroundColor3 = CONFIG.AccentColor
    titleBar.Size = UDim2.new(1, 0, 0, 40)
    titleBar.Position = UDim2.new(0, 0, 0, 0)
    titleBar.Parent = mainContainer
    
    local corner3 = Instance.new("UICorner")
    corner3.CornerRadius = UDim.new(0, CONFIG.CornerRadius, 0, 0)
    corner3.Parent = titleBar
    
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Name = "Title"
    titleLabel.Text = title or "Modern Mod Menu"
    titleLabel.TextColor3 = CONFIG.TextColor
    titleLabel.Font = CONFIG.TitleFont
    titleLabel.TextSize = 18
    titleLabel.BackgroundTransparency = 1
    titleLabel.Size = UDim2.new(0.6, 0, 1, 0)
    titleLabel.Position = UDim2.new(0, 15, 0, 0)
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.Parent = titleBar
    
    -- Settings button
    local settingsButton = Instance.new("TextButton")
    settingsButton.Name = "SettingsButton"
    settingsButton.Text = "⚙"
    settingsButton.TextColor3 = CONFIG.TextColor
    settingsButton.Font = Enum.Font.GothamBold
    settingsButton.TextSize = 18
    settingsButton.BackgroundTransparency = 1
    settingsButton.Size = UDim2.new(0, 40, 1, 0)
    settingsButton.Position = UDim2.new(0.7, 0, 0, 0)
    settingsButton.Parent = titleBar
    
    -- Close button
    local closeButton = Instance.new("TextButton")
    closeButton.Name = "CloseButton"
    closeButton.Text = "×"
    closeButton.TextColor3 = CONFIG.TextColor
    closeButton.Font = Enum.Font.GothamBold
    closeButton.TextSize = 26
    closeButton.BackgroundTransparency = 1
    closeButton.Size = UDim2.new(0, 40, 1, 0)
    closeButton.Position = UDim2.new(1, -40, 0, 0)
    closeButton.Parent = titleBar
    
    -- Main content area with tabs
    local contentArea = Instance.new("Frame")
    contentArea.Name = "ContentArea"
    contentArea.BackgroundTransparency = 1
    contentArea.Size = UDim2.new(1, 0, 1, -40)
    contentArea.Position = UDim2.new(0, 0, 0, 40)
    contentArea.Parent = mainContainer
    
    -- Tabs container
    local tabsContainer = Instance.new("Frame")
    tabsContainer.Name = "TabsContainer"
    tabsContainer.BackgroundColor3 = CONFIG.SecondaryColor
    tabsContainer.Size = UDim2.new(0, 120, 1, 0)
    tabsContainer.Position = UDim2.new(0, 0, 0, 0)
    tabsContainer.Parent = contentArea
    
    local corner4 = Instance.new("UICorner")
    corner4.CornerRadius = UDim.new(0, 0, 0, CONFIG.CornerRadius)
    corner4.Parent = tabsContainer
    
    -- Tabs scrolling
    local tabsScrolling = Instance.new("ScrollingFrame")
    tabsScrolling.Name = "TabsScrolling"
    tabsScrolling.BackgroundTransparency = 1
    tabsScrolling.Size = UDim2.new(1, 0, 1, 0)
    tabsScrolling.Position = UDim2.new(0, 0, 0, 0)
    tabsScrolling.ScrollingDirection = Enum.ScrollingDirection.Y
    tabsScrolling.ScrollBarThickness = 3
    tabsScrolling.Parent = tabsContainer
    
    local tabsLayout = Instance.new("UIListLayout")
    tabsLayout.Padding = UDim.new(0, 5)
    tabsLayout.Parent = tabsScrolling
    
    local tabsPadding = Instance.new("UIPadding")
    tabsPadding.PaddingTop = UDim.new(0, 10)
    tabsPadding.PaddingLeft = UDim.new(0, 5)
    tabsPadding.PaddingRight = UDim.new(0, 5)
    tabsPadding.PaddingBottom = UDim.new(0, 10)
    tabsPadding.Parent = tabsScrolling
    
    -- Content scrolling
    local contentScrolling = Instance.new("ScrollingFrame")
    contentScrolling.Name = "ContentScrolling"
    contentScrolling.BackgroundTransparency = 1
    contentScrolling.Size = UDim2.new(1, -120, 1, 0)
    contentScrolling.Position = UDim2.new(0, 120, 0, 0)
    contentScrolling.ScrollingDirection = Enum.ScrollingDirection.Y
    contentScrolling.ScrollBarThickness = 3
    contentScrolling.Parent = contentArea
    
    local contentLayout = Instance.new("UIListLayout")
    contentLayout.Padding = UDim.new(0, 10)
    contentLayout.Parent = contentScrolling
    
    local contentPadding = Instance.new("UIPadding")
    contentPadding.PaddingLeft = UDim.new(0, 10)
    contentPadding.PaddingRight = UDim.new(0, 10)
    contentPadding.PaddingTop = UDim.new(0, 10)
    contentPadding.PaddingBottom = UDim.new(0, 10)
    contentPadding.Parent = contentScrolling
    
    -- Create floating background text
    local floatingTexts = {}
    local positions = {
        UDim2.new(0, 30, 0, 30),      -- Top Left
        UDim2.new(1, -180, 0, 30),    -- Top Right
        UDim2.new(0, 30, 1, -70),     -- Bottom Left
        UDim2.new(1, -180, 1, -70),   -- Bottom Right
        UDim2.new(0.5, -75, 0.5, -20) -- Center
    }
    
    for i, pos in ipairs(positions) do
        local textData = CreateFloatingText(mainContainer, "Фатима♥️", pos, i)
        table.insert(floatingTexts, textData)
    end
    
    -- Store references
    self.MenuComponents = {
        MainContainer = mainContainer,
        TitleBar = titleBar,
        TabsScrolling = tabsScrolling,
        ContentScrolling = contentScrolling,
        BlurEffect = blur,
        FloatingTexts = floatingTexts,
        SettingsGUI = nil
    }
    
    -- Menu visibility toggle
    local function ToggleMenu()
        self.Menu.Enabled = not self.Menu.Enabled
        blur.Enabled = self.Menu.Enabled
        
        if self.Menu.Enabled then
            TweenService:Create(self.OpenButton, TweenInfo.new(0.3), {
                BackgroundTransparency = 0.5,
                TextTransparency = 0.5
            }):Play()
        else
            TweenService:Create(self.OpenButton, TweenInfo.new(0.3), {
                BackgroundTransparency = 0,
                TextTransparency = 0
            }):Play()
        end
    end
    
    self.OpenButton.MouseButton1Click:Connect(ToggleMenu)
    self.OpenButton.TouchTap:Connect(ToggleMenu)
    
    closeButton.MouseButton1Click:Connect(function()
        self.Menu.Enabled = false
        blur.Enabled = false
        TweenService:Create(self.OpenButton, TweenInfo.new(0.3), {
            BackgroundTransparency = 0,
            TextTransparency = 0
        }):Play()
    end)
    
    closeButton.TouchTap:Connect(function()
        self.Menu.Enabled = false
        blur.Enabled = false
        TweenService:Create(self.OpenButton, TweenInfo.new(0.3), {
            BackgroundTransparency = 0,
            TextTransparency = 0
        }):Play()
    end)
    
    -- Settings button opens settings menu
    settingsButton.MouseButton1Click:Connect(function()
        self:OpenSettingsMenu()
    end)
    
    settingsButton.TouchTap:Connect(function()
        self:OpenSettingsMenu()
    end)
    
    CreateDraggable(mainContainer, titleBar)
    
    -- Setup default sections
    self:AddSection("Home", function(container)
        self:CreateLabel(container, "Welcome to Mod Menu", 22, true)
        self:CreateLabel(container, "Select a section from the left", 16)
        self:CreateLabel(container, "Or open settings for more options", 16)
        
        self:CreateButton(container, "Quick ESP Toggle", function()
            self.EnabledFeatures.ESP = not self.EnabledFeatures.ESP
            if self.EnabledFeatures.ESP then
                self:ShowNotification("ESP Enabled", Color3.fromRGB(0, 255, 0))
            else
                self:ShowNotification("ESP Disabled", Color3.fromRGB(255, 0, 0))
            end
        end)
        
        self:CreateButton(container, "Quick Aimbot Toggle", function()
            self.EnabledFeatures.Aimbot = not self.EnabledFeatures.Aimbot
            if self.EnabledFeatures.Aimbot then
                self:ShowNotification("Aimbot Enabled", Color3.fromRGB(0, 255, 0))
            else
                self:ShowNotification("Aimbot Disabled", Color3.fromRGB(255, 0, 0))
            end
        end)
        
        self:CreateButton(container, "Test Notification", function()
            self:ShowNotification("Test Notification!", Color3.fromRGB(0, 170, 255))
        end)
    end)
    
    self:AddSection("Player", function(container)
        self:CreateLabel(container, "Player Settings", 20, true)
        
        self:CreateSlider(container, "Walk Speed", 16, 100, 16, function(value)
            if LocalPlayer.Character then
                local humanoid = LocalPlayer.Character:FindFirstChild("Humanoid")
                if humanoid then
                    humanoid.WalkSpeed = value
                end
            end
        end)
        
        self:CreateSlider(container, "Jump Power", 50, 200, 50, function(value)
            if LocalPlayer.Character then
                local humanoid = LocalPlayer.Character:FindFirstChild("Humanoid")
                if humanoid then
                    humanoid.JumpPower = value
                end
            end
        end)
        
        self:CreateButton(container, "Reset Character", function()
            if LocalPlayer.Character then
                LocalPlayer.Character:BreakJoints()
                self:ShowNotification("Character Reset", Color3.fromRGB(255, 150, 0))
            end
        end)
        
        self:CreateToggle(container, "Anti-AFK", false, function(state)
            if state then
                local con = LocalPlayer.Idled:Connect(function()
                    VirtualUser:CaptureController()
                    VirtualUser:ClickButton2(Vector2.new())
                end)
                table.insert(self.Connections, con)
                self:ShowNotification("Anti-AFK Enabled", Color3.fromRGB(0, 255, 0))
            end
        end)
        
        self:CreateButton(container, "Teleport to Spawn", function()
            local spawn = workspace:FindFirstChild("SpawnLocation") or workspace:FindFirstChildOfClass("SpawnLocation")
            if spawn and LocalPlayer.Character then
                LocalPlayer.Character:SetPrimaryPartCFrame(spawn.CFrame)
                self:ShowNotification("Teleported to Spawn", Color3.fromRGB(0, 200, 255))
            end
        end)
    end)
    
    self:AddSection("Visual", function(container)
        self:CreateLabel(container, "Visual Settings", 20, true)
        
        self:CreateToggle(container, "Fullbright", false, function(state)
            if state then
                Lighting.GlobalShadows = false
                Lighting.Brightness = 2
                Lighting.ClockTime = 12
                self:ShowNotification("Fullbright Enabled", Color3.fromRGB(255, 255, 150))
            else
                Lighting.GlobalShadows = true
                Lighting.Brightness = 1
                self:ShowNotification("Fullbright Disabled", Color3.fromRGB(150, 150, 150))
            end
        end)
        
        self:CreateSlider(container, "Brightness", 0, 5, 1, function(value)
            Lighting.Brightness = value
        end)
        
        self:CreateSlider(container, "Camera FOV", 70, 120, 70, function(value)
            workspace.CurrentCamera.FieldOfView = value
        end)
        
        self:CreateColorPicker(container, "Ambient Color", Lighting.Ambient, function(color)
            Lighting.Ambient = color
        end)
        
        self:CreateToggle(container, "No Fog", false, function(state)
            if state then
                Lighting.FogEnd = 100000
            else
                Lighting.FogEnd = 1000
            end
        end)
    end)
    
    -- Set first section as active
    if #self.Sections > 0 then
        self:SwitchSection(self.Sections[1])
    end
    
    return self.Menu
end

function ModMenuLib:AddSection(name, contentCallback)
    local section = {
        Name = name,
        Callback = contentCallback,
        TabButton = nil
    }
    
    table.insert(self.Sections, section)
    
    -- Create tab button if menu exists
    if self.MenuComponents and self.MenuComponents.TabsScrolling then
        self:CreateTabButton(section)
    end
    
    return section
end

function ModMenuLib:CreateTabButton(section)
    local tabButton = Instance.new("TextButton")
    tabButton.Name = "Tab_" .. section.Name
    tabButton.Text = section.Name
    tabButton.TextColor3 = CONFIG.TextColor
    tabButton.Font = CONFIG.Font
    tabButton.TextSize = 14
    tabButton.BackgroundColor3 = CONFIG.SecondaryColor
    tabButton.BackgroundTransparency = 0.8
    tabButton.Size = UDim2.new(1, -10, 0, 38)
    tabButton.AutoButtonColor = false
    tabButton.Parent = self.MenuComponents.TabsScrolling
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = tabButton
    
    section.TabButton = tabButton
    
    tabButton.MouseButton1Click:Connect(function()
        self:SwitchSection(section)
    end)
    
    tabButton.TouchTap:Connect(function()
        self:SwitchSection(section)
    end)
end

function ModMenuLib:SwitchSection(section)
    if self.CurrentSection and self.CurrentSection.TabButton then
        TweenService:Create(self.CurrentSection.TabButton, TweenInfo.new(0.2), {
            BackgroundTransparency = 0.8
        }):Play()
    end
    
    self.CurrentSection = section
    
    if section.TabButton then
        TweenService:Create(section.TabButton, TweenInfo.new(0.2), {
            BackgroundTransparency = 0.2
        }):Play()
    end
    
    -- Clear and populate content
    local content = self.MenuComponents.ContentScrolling
    content:ClearAllChildren()
    
    if section.Callback then
        section.Callback(content)
    end
end

function ModMenuLib:OpenSettingsMenu()
    if self.MenuComponents.SettingsGUI then
        self.MenuComponents.SettingsGUI.Enabled = not self.MenuComponents.SettingsGUI.Enabled
        return
    end
    
    -- Create settings GUI
    local settingsGui = Instance.new("ScreenGui")
    settingsGui.Name = MENU_ID .. "_Settings"
    settingsGui.ResetOnSpawn = false
    settingsGui.ZIndexBehavior = Enum.ZIndexBehavior.Global
    settingsGui.DisplayOrder = 9997
    settingsGui.Parent = self.Folder
    
    local settingsContainer = Instance.new("Frame")
    settingsContainer.Name = "SettingsContainer"
    settingsContainer.BackgroundColor3 = CONFIG.MenuColor
    settingsContainer.BackgroundTransparency = CONFIG.Transparency
    settingsContainer.Size = UDim2.new(0, 550, 0, 400)
    settingsContainer.Position = UDim2.new(0.5, -275, 0.5, -200)
    settingsContainer.Parent = settingsGui
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, CONFIG.CornerRadius)
    corner.Parent = settingsContainer
    
    local stroke = Instance.new("UIStroke")
    stroke.Color = CONFIG.AccentColor
    stroke.Thickness = 2
    stroke.Parent = settingsContainer
    
    -- Settings title bar
    local settingsTitleBar = Instance.new("Frame")
    settingsTitleBar.Name = "SettingsTitleBar"
    settingsTitleBar.BackgroundColor3 = CONFIG.AccentColor
    settingsTitleBar.Size = UDim2.new(1, 0, 0, 40)
    settingsTitleBar.Position = UDim2.new(0, 0, 0, 0)
    settingsTitleBar.Parent = settingsContainer
    
    local corner2 = Instance.new("UICorner")
    corner2.CornerRadius = UDim.new(0, CONFIG.CornerRadius, 0, 0)
    corner2.Parent = settingsTitleBar
    
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Name = "Title"
    titleLabel.Text = "Settings"
    titleLabel.TextColor3 = CONFIG.TextColor
    titleLabel.Font = CONFIG.TitleFont
    titleLabel.TextSize = 18
    titleLabel.BackgroundTransparency = 1
    titleLabel.Size = UDim2.new(0.8, 0, 1, 0)
    titleLabel.Position = UDim2.new(0, 15, 0, 0)
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.Parent = settingsTitleBar
    
    local closeSettingsButton = Instance.new("TextButton")
    closeSettingsButton.Name = "CloseSettings"
    closeSettingsButton.Text = "×"
    closeSettingsButton.TextColor3 = CONFIG.TextColor
    closeSettingsButton.Font = Enum.Font.GothamBold
    closeSettingsButton.TextSize = 26
    closeSettingsButton.BackgroundTransparency = 1
    closeSettingsButton.Size = UDim2.new(0, 40, 1, 0)
    closeSettingsButton.Position = UDim2.new(1, -40, 0, 0)
    closeSettingsButton.Parent = settingsTitleBar
    
    -- Settings tabs
    local settingsTabsContainer = Instance.new("Frame")
    settingsTabsContainer.Name = "SettingsTabsContainer"
    settingsTabsContainer.BackgroundColor3 = CONFIG.SecondaryColor
    settingsTabsContainer.Size = UDim2.new(0, 120, 1, -40)
    settingsTabsContainer.Position = UDim2.new(0, 0, 0, 40)
    settingsTabsContainer.Parent = settingsContainer
    
    local corner3 = Instance.new("UICorner")
    corner3.CornerRadius = UDim.new(0, 0, 0, CONFIG.CornerRadius)
    corner3.Parent = settingsTabsContainer
    
    local settingsTabsScrolling = Instance.new("ScrollingFrame")
    settingsTabsScrolling.Name = "SettingsTabsScrolling"
    settingsTabsScrolling.BackgroundTransparency = 1
    settingsTabsScrolling.Size = UDim2.new(1, 0, 1, 0)
    settingsTabsScrolling.Position = UDim2.new(0, 0, 0, 0)
    settingsTabsScrolling.ScrollingDirection = Enum.ScrollingDirection.Y
    settingsTabsScrolling.ScrollBarThickness = 3
    settingsTabsScrolling.Parent = settingsTabsContainer
    
    local settingsTabsLayout = Instance.new("UIListLayout")
    settingsTabsLayout.Padding = UDim.new(0, 5)
    settingsTabsLayout.Parent = settingsTabsScrolling
    
    local settingsTabsPadding = Instance.new("UIPadding")
    settingsTabsPadding.PaddingTop = UDim.new(0, 10)
    settingsTabsPadding.PaddingLeft = UDim.new(0, 5)
    settingsTabsPadding.PaddingRight = UDim.new(0, 5)
    settingsTabsPadding.Parent = settingsTabsScrolling
    
    -- Settings content
    local settingsContent = Instance.new("ScrollingFrame")
    settingsContent.Name = "SettingsContent"
    settingsContent.BackgroundTransparency = 1
    settingsContent.Size = UDim2.new(1, -120, 1, -40)
    settingsContent.Position = UDim2.new(0, 120, 0, 40)
    settingsContent.ScrollingDirection = Enum.ScrollingDirection.Y
    settingsContent.ScrollBarThickness = 3
    settingsContent.Parent = settingsContainer
    
    local settingsContentLayout = Instance.new("UIListLayout")
    settingsContentLayout.Padding = UDim.new(0, 10)
    settingsContentLayout.Parent = settingsContent
    
    local settingsContentPadding = Instance.new("UIPadding")
    settingsContentPadding.PaddingLeft = UDim.new(0, 10)
    settingsContentPadding.PaddingRight = UDim.new(0, 10)
    settingsContentPadding.PaddingTop = UDim.new(0, 10)
    settingsContentPadding.PaddingBottom = UDim.new(0, 10)
    settingsContentPadding.Parent = settingsContent
    
    self.MenuComponents.SettingsGUI = settingsGui
    self.MenuComponents.SettingsContent = settingsContent
    
    -- Create settings tabs
    local settingsTabs = {
        {Name = "ESP", Callback = function() self:CreateESPSettings(settingsContent) end},
        {Name = "Aimbot", Callback = function() self:CreateAimbotSettings(settingsContent) end},
        {Name = "Misc", Callback = function() self:CreateMiscSettings(settingsContent) end},
        {Name = "Menu", Callback = function() self:CreateMenuSettings(settingsContent) end}
    }
    
    local activeSettingsTab = nil
    
    for i, tab in pairs(settingsTabs) do
        local tabButton = Instance.new("TextButton")
        tabButton.Name = "SettingsTab_" .. tab.Name
        tabButton.Text = tab.Name
        tabButton.TextColor3 = CONFIG.TextColor
        tabButton.Font = CONFIG.Font
        tabButton.TextSize = 14
        tabButton.BackgroundColor3 = CONFIG.SecondaryColor
        tabButton.BackgroundTransparency = 0.8
        tabButton.Size = UDim2.new(1, -10, 0, 38)
        tabButton.AutoButtonColor = false
        tabButton.Parent = settingsTabsScrolling
        
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 6)
        corner.Parent = tabButton
        
        tabButton.MouseButton1Click:Connect(function()
            if activeSettingsTab then
                TweenService:Create(activeSettingsTab, TweenInfo.new(0.2), {
                    BackgroundTransparency = 0.8
                }):Play()
            end
            
            activeSettingsTab = tabButton
            TweenService:Create(tabButton, TweenInfo.new(0.2), {
                BackgroundTransparency = 0.2
            }):Play()
            
            settingsContent:ClearAllChildren()
            tab.Callback()
        end)
        
        tabButton.TouchTap:Connect(function()
            if activeSettingsTab then
                TweenService:Create(activeSettingsTab, TweenInfo.new(0.2), {
                    BackgroundTransparency = 0.8
                }):Play()
            end
            
            activeSettingsTab = tabButton
            TweenService:Create(tabButton, TweenInfo.new(0.2), {
                BackgroundTransparency = 0.2
            }):Play()
            
            settingsContent:ClearAllChildren()
            tab.Callback()
        end)
        
        if i == 1 then
            activeSettingsTab = tabButton
            TweenService:Create(tabButton, TweenInfo.new(0.2), {
                BackgroundTransparency = 0.2
            }):Play()
            settingsContent:ClearAllChildren()
            tab.Callback()
        end
    end
    
    closeSettingsButton.MouseButton1Click:Connect(function()
        settingsGui.Enabled = false
    end)
    
    closeSettingsButton.TouchTap:Connect(function()
        settingsGui.Enabled = false
    end)
    
    CreateDraggable(settingsContainer, settingsTitleBar)
    
    settingsGui.Enabled = true
end

function ModMenuLib:CreateESPSettings(container)
    self:CreateLabel(container, "ESP Settings", 20, true)
    
    local espToggle = self:CreateToggle(container, "Enable ESP", false, function(state)
        self.EnabledFeatures.ESP = state
        if state then
            self.ESPSettings = self.ESPSettings or {}
            self:ShowNotification("ESP Enabled", Color3.fromRGB(0, 255, 0))
        else
            self:ShowNotification("ESP Disabled", Color3.fromRGB(255, 0, 0))
        end
    end)
    
    self:CreateToggle(container, "Box ESP", true, function(state)
        if not self.ESPSettings then return end
        self.ESPSettings.BoxESP = state
    end)
    
    self:CreateToggle(container, "Tracer ESP", true, function(state)
        if not self.ESPSettings then return end
        self.ESPSettings.TracerESP = state
    end)
    
    self:CreateToggle(container, "Show Names", true, function(state)
        if not self.ESPSettings then return end
        self.ESPSettings.ShowNames = state
    end)
    
    self:CreateToggle(container, "Show Health", true, function(state)
        if not self.ESPSettings then return end
        self.ESPSettings.ShowHealth = state
    end)
    
    self:CreateColorPicker(container, "ESP Color", CONFIG.AccentColor, function(color)
        if not self.ESPSettings then return end
        self.ESPSettings.Color = color
    end)
    
    self:CreateSlider(container, "Max Distance", 50, 1000, 300, function(value)
        if not self.ESPSettings then return end
        self.ESPSettings.MaxDistance = value
    end)
    
    local espTypes = {"Enemies Only", "Team Only", "All Players"}
    self:CreateDropdown(container, "ESP Target", espTypes, 1, function(index, option)
        if not self.ESPSettings then return end
        self.ESPSettings.TargetType = option
    end)
end

function ModMenuLib:CreateAimbotSettings(container)
    self:CreateLabel(container, "Aimbot Settings", 20, true)
    
    self:CreateToggle(container, "Enable Aimbot", false, function(state)
        self.EnabledFeatures.Aimbot = state
        self:ShowNotification(state and "Aimbot Enabled" or "Aimbot Disabled",
            state and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0))
    end)
    
    self:CreateToggle(container, "Silent Aim", false, function(state)
        self.EnabledFeatures.SilentAim = state
    end)
    
    self:CreateToggle(container, "Auto Shoot", false, function(state)
        self.EnabledFeatures.AutoShoot = state
    end)
    
    local boneOptions = {"Head", "UpperTorso", "HumanoidRootPart"}
    self:CreateDropdown(container, "Aim Bone", boneOptions, 1, function(index, option)
        self.EnabledFeatures.AimbotBone = option
    end)
    
    self:CreateSlider(container, "Aimbot FOV", 10, 300, 100, function(value)
        self.EnabledFeatures.AimbotFOV = value
    end)
    
    self:CreateSlider(container, "Smoothness", 0.1, 1, 0.3, function(value)
        self.EnabledFeatures.AimbotSmoothness = value
    end)
end

function ModMenuLib:CreateMiscSettings(container)
    self:CreateLabel(container, "Misc Settings", 20, true)
    
    self:CreateToggle(container, "Fly", false, function(state)
        self.EnabledFeatures.Fly = state
        self:ShowNotification(state and "Fly Enabled" or "Fly Disabled",
            state and Color3.fromRGB(0, 255, 255) or Color3.fromRGB(255, 100, 100))
    end)
    
    self:CreateToggle(container, "NoClip", false, function(state)
        self.EnabledFeatures.NoClip = state
        self:ShowNotification(state and "NoClip Enabled" or "NoClip Disabled",
            state and Color3.fromRGB(0, 255, 255) or Color3.fromRGB(255, 100, 100))
    end)
    
    self:CreateToggle(container, "Auto Respawn", false, function(state)
        self.EnabledFeatures.AutoRespawn = state
    end)
    
    self:CreateSlider(container, "Gravity", 0, 196.2, 196.2, function(value)
        workspace.Gravity = value
    end)
    
    self:CreateButton(container, "Save Settings", function()
        self:SaveSettings()
        self:ShowNotification("Settings Saved", Color3.fromRGB(0, 255, 0))
    end)
    
    self:CreateButton(container, "Load Settings", function()
        self:LoadSettings()
        self:ShowNotification("Settings Loaded", Color3.fromRGB(0, 200, 255))
    end)
end

function ModMenuLib:CreateMenuSettings(container)
    self:CreateLabel(container, "Menu Settings", 20, true)
    
    self:CreateColorPicker(container, "Accent Color", CONFIG.AccentColor, function(color)
        CONFIG.AccentColor = color
        if self.MenuComponents then
            self.MenuComponents.TitleBar.BackgroundColor3 = color
            self.MenuComponents.MainContainer.UIStroke.Color = color
        end
        if self.OpenButton then
            self.OpenButton.BackgroundColor3 = color
        end
        self:ShowNotification("Accent Color Updated", color)
    end)
    
    self:CreateColorPicker(container, "Text Color", CONFIG.TextColor, function(color)
        CONFIG.TextColor = color
        self:ShowNotification("Text Color Updated", color)
    end)
    
    self:CreateSlider(container, "Menu Transparency", 0, 0.5, CONFIG.Transparency, function(value)
        CONFIG.Transparency = value
        if self.MenuComponents then
            self.MenuComponents.MainContainer.BackgroundTransparency = value
        end
    end)
    
    self:CreateSlider(container, "UI Scale", 0.8, 1.2, 1, function(value)
        if self.MenuComponents then
            local scale = value
            self.MenuComponents.MainContainer.Size = UDim2.new(0, 500 * scale, 0, 400 * scale)
            self.MenuComponents.MainContainer.Position = UDim2.new(0.5, -250 * scale, 0.5, -200 * scale)
        end
    end)
    
    self:CreateButton(container, "Hide Menu Button", function()
        if self.OpenButton then
            self.OpenButton.Visible = not self.OpenButton.Visible
            self:ShowNotification(self.OpenButton.Visible and "Menu Button Shown" or "Menu Button Hidden",
                self.OpenButton.Visible and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 100, 100))
        end
    end)
    
    self:CreateButton(container, "Reset All Settings", function()
        self:ResetSettings()
        self:ShowNotification("All Settings Reset", Color3.fromRGB(255, 150, 0))
    end)
end

-- Main loop for features
function ModMenuLib:StartMainLoop()
    local lastUpdate = tick()
    
    local mainConnection = RunService.RenderStepped:Connect(function()
        local now = tick()
        if now - lastUpdate < 0.033 then return end
        lastUpdate = now
        
        -- Update ESP if enabled
        if self.EnabledFeatures.ESP then
            self:UpdateESP()
        end
        
        -- Auto Respawn
        if self.EnabledFeatures.AutoRespawn and LocalPlayer.Character then
            local humanoid = LocalPlayer.Character:FindFirstChild("Humanoid")
            if humanoid and humanoid.Health <= 0 then
                LocalPlayer.Character:BreakJoints()
            end
        end
    end)
    
    table.insert(self.Connections, mainConnection)
end

-- Settings Management
function ModMenuLib:SaveSettings()
    local settings = {
        AccentColor = CONFIG.AccentColor,
        TextColor = CONFIG.TextColor,
        Transparency = CONFIG.Transparency,
        EnabledFeatures = self.EnabledFeatures,
        ESPSettings = self.ESPSettings
    }
    
    self.SavedSettings = settings
end

function ModMenuLib:LoadSettings()
    if self.SavedSettings then
        CONFIG.AccentColor = self.SavedSettings.AccentColor or CONFIG.AccentColor
        CONFIG.TextColor = self.SavedSettings.TextColor or CONFIG.TextColor
        CONFIG.Transparency = self.SavedSettings.Transparency or CONFIG.Transparency
        self.EnabledFeatures = self.SavedSettings.EnabledFeatures or {}
        self.ESPSettings = self.SavedSettings.ESPSettings or {}
    end
end

function ModMenuLib:ResetSettings()
    CONFIG = {
        MenuColor = Color3.fromRGB(28, 28, 35),
        AccentColor = Color3.fromRGB(0, 170, 255),
        TextColor = Color3.fromRGB(240, 240, 245),
        SecondaryColor = Color3.fromRGB(40, 40, 48),
        Font = Enum.Font.GothamMedium,
        TitleFont = Enum.Font.GothamBold,
        Transparency = 0.08,
        CornerRadius = 10
    }
    
    self.EnabledFeatures = {}
    self.ESPSettings = nil
    
    if self.MenuComponents then
        self.MenuComponents.TitleBar.BackgroundColor3 = CONFIG.AccentColor
        self.MenuComponents.MainContainer.UIStroke.Color = CONFIG.AccentColor
        self.MenuComponents.MainContainer.BackgroundTransparency = CONFIG.Transparency
    end
    
    if self.OpenButton then
        self.OpenButton.BackgroundColor3 = CONFIG.AccentColor
    end
end

-- Cleanup
function ModMenuLib:DestroyMenu()
    for _, connection in pairs(self.Connections) do
        if connection then
            connection:Disconnect()
        end
    end
    
    for player, espData in pairs(self.ESPItems) do
        espData:Destroy()
    end
    self.ESPItems = {}
    
    if self.MenuComponents and self.MenuComponents.FloatingTexts then
        for _, textData in pairs(self.MenuComponents.FloatingTexts) do
            if textData.connection then
                textData.connection:Disconnect()
            end
            if textData.label then
                textData.label:Destroy()
            end
        end
    end
    
    if Lighting:FindFirstChild("MenuBlur") then
        Lighting.MenuBlur:Destroy()
    end
    
    if self.Menu then
        self.Menu:Destroy()
        self.Menu = nil
    end
    
    if self.OpenButton and self.OpenButton.Parent then
        self.OpenButton.Parent:Destroy()
        self.OpenButton = nil
    end
    
    if self.Folder then
        self.Folder:Destroy()
        self.Folder = nil
    end
    
    self.Connections = {}
    self.MenuComponents = nil
    self.Sections = {}
    self.CurrentSection = nil
end

-- Initialize function
function ModMenuLib:Init(title)
    self:DestroyMenu()
    
    -- Create menu
    self:CreateMenu(title or "Modern Mod Menu")
    
    -- Start main loop
    self:StartMainLoop()
    
    return self
end

-- Export the library
return ModMenuLib
