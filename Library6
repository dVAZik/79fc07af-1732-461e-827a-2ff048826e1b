--[[
    Nova UI Library v5.2 - Ultimate Premium Edition
    Premium Mod Menu Framework for Roblox
    Author: Nova Team
    License: MIT
    Design: Luxury Premium with Enhanced Features
    Optimized for PC & Mobile
--]]

-- Services
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local Lighting = game:GetService("Lighting")
local StarterGui = game:GetService("StarterGui")

-- Cache frequently used enums
local EasingStyle = Enum.EasingStyle
local EasingDirection = Enum.EasingDirection
local UserInputType = Enum.UserInputType
local Font = Enum.Font
local KeyCode = Enum.KeyCode

-- Library Table
local Nova = {
    Version = "5.2",
    Debug = false,
    Themes = {},
    ActiveMenus = {},
    Connections = {},
    WidgetInstances = {},
    EnabledFeatures = {},
    ESPSettings = {},
    ESPItems = {},
    FloatingTexts = {}
}

Nova.__index = Nova

-- Enhanced Colors Palette
local NEW_YEAR_COLORS = {
    Gold = Color3.fromRGB(255, 215, 0),
    Silver = Color3.fromRGB(192, 192, 192),
    Red = Color3.fromRGB(220, 20, 60),
    Green = Color3.fromRGB(46, 204, 113),
    Blue = Color3.fromRGB(52, 152, 219),
    Purple = Color3.fromRGB(155, 89, 182),
    White = Color3.fromRGB(255, 255, 255),
    DarkBlue = Color3.fromRGB(20, 25, 40),
    Cyan = Color3.fromRGB(0, 255, 255),
    Pink = Color3.fromRGB(255, 105, 180),
    Orange = Color3.fromRGB(255, 140, 0),
    DarkPurple = Color3.fromRGB(28, 28, 35),
    LightBlue = Color3.fromRGB(0, 170, 255),
    LightGray = Color3.fromRGB(240, 240, 245)
}

-- Premium Themes
Nova.Themes = {
    GoldenNewYear = {
        Name = "Golden New Year",
        AccentColor = NEW_YEAR_COLORS.Gold,
        SecondaryColor = NEW_YEAR_COLORS.Silver,
        Background = Color3.fromRGB(15, 15, 25),
        Surface = Color3.fromRGB(28, 28, 42),
        Surface2 = Color3.fromRGB(38, 38, 55),
        Text = NEW_YEAR_COLORS.White,
        SubText = Color3.fromRGB(170, 170, 200),
        Border = NEW_YEAR_COLORS.Gold,
        Hover = Color3.fromRGB(48, 48, 68),
        Shadow = Color3.new(0, 0, 0),
        Glow = Color3.fromRGB(255, 215, 0, 0.12),
        Success = NEW_YEAR_COLORS.Green,
        Warning = NEW_YEAR_COLORS.Red,
        Info = NEW_YEAR_COLORS.Cyan,
        Gradient = ColorSequence.new({
            ColorSequenceKeypoint.new(0, NEW_YEAR_COLORS.Gold),
            ColorSequenceKeypoint.new(0.5, NEW_YEAR_COLORS.Orange),
            ColorSequenceKeypoint.new(1, NEW_YEAR_COLORS.Gold)
        })
    },
    ModernElegant = {
        Name = "Modern Elegant",
        AccentColor = NEW_YEAR_COLORS.LightBlue,
        SecondaryColor = NEW_YEAR_COLORS.DarkPurple,
        Background = Color3.fromRGB(20, 20, 28),
        Surface = Color3.fromRGB(28, 28, 35),
        Surface2 = Color3.fromRGB(40, 40, 48),
        Text = NEW_YEAR_COLORS.LightGray,
        SubText = Color3.fromRGB(180, 180, 200),
        Border = NEW_YEAR_COLORS.LightBlue,
        Hover = Color3.fromRGB(50, 50, 58),
        Shadow = Color3.new(0, 0, 0),
        Glow = Color3.fromRGB(0, 170, 255, 0.12),
        Success = NEW_YEAR_COLORS.Green,
        Warning = NEW_YEAR_COLORS.Red,
        Info = NEW_YEAR_COLORS.Cyan,
        Gradient = ColorSequence.new({
            ColorSequenceKeypoint.new(0, NEW_YEAR_COLORS.LightBlue),
            ColorSequenceKeypoint.new(0.5, NEW_YEAR_COLORS.Cyan),
            ColorSequenceKeypoint.new(1, NEW_YEAR_COLORS.LightBlue)
        })
    },
    WinterWonderland = {
        Name = "Winter Wonderland",
        AccentColor = NEW_YEAR_COLORS.Cyan,
        SecondaryColor = NEW_YEAR_COLORS.Blue,
        Background = Color3.fromRGB(10, 15, 28),
        Surface = Color3.fromRGB(22, 30, 48),
        Surface2 = Color3.fromRGB(32, 42, 62),
        Text = Color3.fromRGB(240, 245, 255),
        SubText = Color3.fromRGB(160, 180, 210),
        Border = NEW_YEAR_COLORS.Cyan,
        Hover = Color3.fromRGB(42, 55, 78),
        Shadow = Color3.new(0, 0, 0),
        Glow = Color3.fromRGB(0, 255, 255, 0.12),
        Success = Color3.fromRGB(0, 255, 127),
        Warning = Color3.fromRGB(255, 100, 0),
        Info = NEW_YEAR_COLORS.Blue,
        Gradient = ColorSequence.new({
            ColorSequenceKeypoint.new(0, NEW_YEAR_COLORS.Cyan),
            ColorSequenceKeypoint.new(0.5, NEW_YEAR_COLORS.Blue),
            ColorSequenceKeypoint.new(1, NEW_YEAR_COLORS.Cyan)
        })
    }
}

local DEFAULT_CONFIG = {
    Theme = "GoldenNewYear",
    BackgroundTransparency = 0.08,
    BlurEnabled = true,
    Keybind = KeyCode.RightShift,
    GlowEffect = true,
    Animations = true,
    SnowEffect = true,
    SoundEffects = false,
    RoundedCorners = true,
    ShadowEffect = true,
    EnableGradients = true,
    EnableNotifications = true,
    EnableRippleEffects = true,
    EnableFloatingText = true,
    MenuWidth = 780,
    MenuHeight = 660,
    MobileWidth = 360,
    MobileHeight = 540
}

-- Utility Functions
local function SafeCreate(class, props)
    local obj = Instance.new(class)
    
    for prop, value in pairs(props) do
        if prop ~= "Parent" and prop ~= "Children" and prop ~= "LayoutOrder" and prop ~= "ZIndex" then
            local success, err = pcall(function()
                obj[prop] = value
            end)
            if not success and Nova.Debug then
                warn("[Nova UI] Failed to set", prop, "on", class, ":", err)
            end
        end
    end
    
    if props.Parent then
        obj.Parent = props.Parent
    end
    
    if props.Children then
        for _, child in ipairs(props.Children) do
            if child then
                child.Parent = obj
            end
        end
    end
    
    if props.LayoutOrder then
        obj.LayoutOrder = props.LayoutOrder
    end
    
    if props.ZIndex then
        obj.ZIndex = props.ZIndex
    end
    
    return obj
end

local function CreateTween(obj, props, duration, easingStyle, easingDirection)
    if not obj or not props then return nil end
    
    local tweenInfo = TweenInfo.new(
        duration or 0.25,
        easingStyle or EasingStyle.Quint,
        easingDirection or EasingDirection.Out,
        0,
        false,
        0
    )
    
    local tweenObj = TweenService:Create(obj, tweenInfo, props)
    tweenObj:Play()
    return tweenObj
end

local function GenerateId()
    return HttpService:GenerateGUID(false):sub(1, 8)
end

local function IsMobile()
    return UserInputService.TouchEnabled
end

-- Ripple Effect (from Library8_1)
local function CreateRippleEffect(button, color)
    if not button then return end
    
    local ripple = Instance.new("Frame")
    ripple.Name = "Ripple"
    ripple.BackgroundColor3 = color or Color3.fromRGB(255, 255, 255)
    ripple.BackgroundTransparency = 0.8
    ripple.Size = UDim2.new(0, 0, 0, 0)
    ripple.Position = UDim2.new(0.5, 0, 0.5, 0)
    ripple.AnchorPoint = Vector2.new(0.5, 0.5)
    ripple.ZIndex = 10
    ripple.Parent = button
    
    local mousePos = UserInputService:GetMouseLocation()
    local buttonPos = button.AbsolutePosition
    local relativePos = Vector2.new(mousePos.X - buttonPos.X, mousePos.Y - buttonPos.Y)
    
    ripple.Position = UDim2.new(0, relativePos.X, 0, relativePos.Y)
    
    local tween = TweenService:Create(ripple, TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
        Size = UDim2.new(2, 0, 2, 0),
        BackgroundTransparency = 1
    })
    
    tween:Play()
    tween.Completed:Connect(function()
        ripple:Destroy()
    end)
end

-- Create draggable window (from Library8_1)
local function CreateDraggable(frame, handle)
    local dragging = false
    local dragInput, dragStart, startPos
    
    local function Update(input)
        local delta = input.Position - dragStart
        frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
    
    handle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    handle.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input == dragInput) then
            Update(input)
        end
    end)
end

-- Floating text effect (from Library8_1)
local function CreateFloatingText(parent, text, position, index)
    local label = Instance.new("TextLabel")
    label.Name = "FloatingText_" .. index
    label.Text = text
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextTransparency = 0.85
    label.Font = Enum.Font.GothamBold
    label.TextSize = 24
    label.BackgroundTransparency = 1
    label.Size = UDim2.new(0, 150, 0, 40)
    label.Position = position
    label.ZIndex = 0
    label.Parent = parent
    
    local patterns = {
        {speedX = 0.02, speedY = 0.015, radiusX = 80, radiusY = 60, offsetX = 0, offsetY = 0},
        {speedX = -0.025, speedY = 0.018, radiusX = 90, radiusY = 70, offsetX = math.pi/3, offsetY = math.pi/4},
        {speedX = 0.018, speedY = -0.022, radiusX = 70, radiusY = 80, offsetX = math.pi/2, offsetY = math.pi/3},
        {speedX = -0.015, speedY = -0.02, radiusX = 85, radiusY = 65, offsetX = math.pi, offsetY = math.pi/2},
        {speedX = 0.03, speedY = 0.025, radiusX = 100, radiusY = 80, offsetX = math.pi/4, offsetY = math.pi/6}
    }
    
    local pattern = patterns[index] or patterns[1]
    local time = 0
    local centerX, centerY
    
    local connection = RunService.RenderStepped:Connect(function(delta)
        if not label or not label.Parent then
            connection:Disconnect()
            return
        end
        
        time = time + delta
        
        if not centerX then
            centerX = label.AbsolutePosition.X + label.AbsoluteSize.X/2
            centerY = label.AbsolutePosition.Y + label.AbsoluteSize.Y/2
        end
        
        local x = centerX + math.cos(time * pattern.speedX + pattern.offsetX) * pattern.radiusX
        local y = centerY + math.sin(time * pattern.speedY + pattern.offsetY) * pattern.radiusY
        
        label.Position = UDim2.new(0, x, 0, y)
        label.TextTransparency = 0.7 + math.sin(time * 2) * 0.2
        label.Rotation = math.sin(time * 1.5) * 3
    end)
    
    return {label = label, connection = connection}
end

-- Notification system (improved from Library8_1)
function Nova:ShowNotification(text, color, duration)
    if not self.Config.EnableNotifications or not self.ScreenGui then return end
    
    local notification = SafeCreate("TextLabel", {
        Name = "Notification",
        Parent = self.ScreenGui,
        Text = text,
        TextColor3 = Color3.fromRGB(255, 255, 255),
        Font = Font.GothamMedium,
        TextSize = 14,
        BackgroundColor3 = color or self.CurrentTheme.AccentColor,
        BackgroundTransparency = 0.3,
        Size = UDim2.new(0, 200, 0, 40),
        Position = UDim2.new(0.5, -100, 1, -50),
        AnchorPoint = Vector2.new(0.5, 0),
        ZIndex = 9999
    })
    
    SafeCreate("UICorner", {
        CornerRadius = UDim.new(0, 10),
        Parent = notification
    })
    
    SafeCreate("UIStroke", {
        Color = Color3.fromRGB(255, 255, 255),
        Thickness = 1,
        Parent = notification
    })
    
    notification.Position = UDim2.new(0.5, -100, 1, 10)
    CreateTween(notification, {
        Position = UDim2.new(0.5, -100, 1, -50)
    }, 0.3)
    
    task.delay(duration or 3, function()
        if notification then
            CreateTween(notification, {
                Position = UDim2.new(0.5, -100, 1, 10),
                BackgroundTransparency = 1,
                TextTransparency = 1
            }, 0.3)
            
            task.wait(0.3)
            if notification then
                notification:Destroy()
            end
        end
    end)
end

-- Main Constructor
function Nova.new(menuName, config)
    menuName = menuName or "NovaUI"
    
    -- Cleanup old menus
    for _, child in ipairs(CoreGui:GetChildren()) do
        if child:IsA("ScreenGui") and child.Name:find(menuName) then
            child:Destroy()
        end
    end
    
    local self = setmetatable({}, Nova)
    
    self.MenuName = menuName .. "_" .. GenerateId()
    self.Sections = {}
    self.ActiveSection = nil
    self.Config = config and table.clone(config) or table.clone(DEFAULT_CONFIG)
    self.CurrentTheme = Nova.Themes[self.Config.Theme] or Nova.Themes.GoldenNewYear
    self.IsMobile = IsMobile()
    self.IsOpen = false
    self.Connections = {}
    self.WidgetInstances = {}
    self.SnowParticles = {}
    self.FloatingTexts = {}
    self.EnabledFeatures = {}
    self.ESPSettings = {}
    self.ESPItems = {}
    
    -- Initialize
    local success, err = pcall(function()
        self:InitializeUI()
        self:InitializeInput()
        self:ApplyTheme()
        
        if self.Config.GlowEffect then
            self:CreateGlowEffect()
        end
        
        if self.Config.SnowEffect then
            self:CreateSnowEffect()
        end
        
        if self.Config.ShadowEffect then
            self:CreateShadowEffect()
        end
        
        if self.Config.EnableFloatingText then
            self:CreateFloatingTexts()
        end
        
        self:SetupBackgroundBlur()
    end)
    
    if not success then
        warn("[Nova UI] Initialization error:", err)
        return nil
    end
    
    table.insert(Nova.ActiveMenus, self)
    print("[Nova UI] Ultimate Premium menu created:", self.MenuName)
    return self
end

-- Enhanced UI Initialization
function Nova:InitializeUI()
    -- Main ScreenGui
    self.ScreenGui = SafeCreate("ScreenGui", {
        Name = self.MenuName,
        Parent = CoreGui,
        ResetOnSpawn = false,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling,
        DisplayOrder = 999,
        IgnoreGuiInset = true
    })
    
    -- Calculate sizes based on device
    local width = self.IsMobile and self.Config.MobileWidth or self.Config.MenuWidth
    local height = self.IsMobile and self.Config.MobileHeight or self.Config.MenuHeight
    
    -- Main Container
    self.Container = SafeCreate("Frame", {
        Name = "Container",
        Parent = self.ScreenGui,
        AnchorPoint = Vector2.new(0.5, 0.5),
        Position = UDim2.new(0.5, 0, 0.5, 0),
        Size = UDim2.new(0, width, 0, height),
        BackgroundTransparency = 1,
        Visible = false,
        Active = true
    })
    
    -- Make draggable
    CreateDraggable(self.Container, self.Container)
    
    -- Background
    self.Background = SafeCreate("Frame", {
        Name = "Background",
        Parent = self.Container,
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundColor3 = self.CurrentTheme.Background,
        BackgroundTransparency = 1,
        ClipsDescendants = true
    })
    
    if self.Config.RoundedCorners then
        SafeCreate("UICorner", {
            CornerRadius = UDim.new(0, 20),
            Parent = self.Background
        })
    end
    
    SafeCreate("UIStroke", {
        Color = self.CurrentTheme.AccentColor,
        Thickness = 2,
        Transparency = 0.4,
        Parent = self.Background
    })
    
    -- Background gradient
    if self.Config.EnableGradients then
        SafeCreate("UIGradient", {
            Color = self.CurrentTheme.Gradient,
            Rotation = 45,
            Transparency = NumberSequence.new(0.9),
            Parent = self.Background
        })
    end
    
    -- Luxury Header
    self.Header = SafeCreate("Frame", {
        Name = "Header",
        Parent = self.Background,
        Size = UDim2.new(1, 0, 0, 75),
        BackgroundColor3 = self.CurrentTheme.Surface,
        BorderSizePixel = 0
    })
    
    if self.Config.RoundedCorners then
        local headerCorner = SafeCreate("UICorner", {
            CornerRadius = UDim.new(0, 20, 0, 0),
            Parent = self.Header
        })
    end
    
    -- Header gradient
    if self.Config.EnableGradients then
        SafeCreate("UIGradient", {
            Color = ColorSequence.new({
                ColorSequenceKeypoint.new(0, self.CurrentTheme.Surface),
                ColorSequenceKeypoint.new(1, self.CurrentTheme.Surface:Lerp(self.CurrentTheme.AccentColor, 0.1))
            }),
            Rotation = 90,
            Parent = self.Header
        })
    end
    
    -- Logo
    self.Logo = SafeCreate("TextLabel", {
        Name = "Logo",
        Parent = self.Header,
        AnchorPoint = Vector2.new(0, 0.5),
        Position = UDim2.new(0, 20, 0.5, 0),
        Size = UDim2.new(0, 42, 0, 42),
        BackgroundTransparency = 1,
        Text = "üéÑ",
        TextColor3 = self.CurrentTheme.AccentColor,
        Font = Font.GothamBlack,
        TextSize = 30,
        TextStrokeColor3 = Color3.new(1, 1, 1),
        TextStrokeTransparency = 0.7
    })
    
    -- Title
    self.Title = SafeCreate("TextLabel", {
        Name = "Title",
        Parent = self.Header,
        AnchorPoint = Vector2.new(0, 0.5),
        Position = UDim2.new(0, 75, 0.5, -8),
        Size = UDim2.new(0.4, 0, 0, 30),
        BackgroundTransparency = 1,
        Text = "NOVA PREMIUM",
        TextColor3 = self.CurrentTheme.Text,
        Font = Font.GothamBold,
        TextSize = 22,
        TextXAlignment = Enum.TextXAlignment.Left
    })
    
    SafeCreate("TextLabel", {
        Parent = self.Header,
        AnchorPoint = Vector2.new(0, 0),
        Position = UDim2.new(0, 75, 0, 45),
        Size = UDim2.new(0.4, 0, 0, 18),
        BackgroundTransparency = 1,
        Text = "Ultimate v" .. self.Version,
        TextColor3 = self.CurrentTheme.SubText,
        Font = Font.GothamMedium,
        TextSize = 13,
        TextXAlignment = Enum.TextXAlignment.Left
    })
    
    -- Settings button
    self.SettingsButton = SafeCreate("TextButton", {
        Name = "SettingsButton",
        Parent = self.Header,
        AnchorPoint = Vector2.new(1, 0.5),
        Position = UDim2.new(1, -80, 0.5, 0),
        Size = UDim2.new(0, 36, 0, 36),
        BackgroundColor3 = self.CurrentTheme.Surface2,
        AutoButtonColor = false,
        Text = "‚öô",
        TextColor3 = self.CurrentTheme.Text,
        Font = Font.GothamBold,
        TextSize = 18
    })
    
    SafeCreate("UICorner", {
        CornerRadius = UDim.new(1, 0),
        Parent = self.SettingsButton
    })
    
    self.SettingsButton.MouseButton1Click:Connect(function()
        self:OpenSettingsMenu()
    end)
    
    -- Enhanced Close Button
    self.CloseButton = SafeCreate("TextButton", {
        Name = "CloseButton",
        Parent = self.Header,
        AnchorPoint = Vector2.new(1, 0.5),
        Position = UDim2.new(1, -20, 0.5, 0),
        Size = UDim2.new(0, 42, 0, 42),
        BackgroundColor3 = self.CurrentTheme.Warning,
        AutoButtonColor = false,
        Text = "√ó",
        TextColor3 = Color3.new(1, 1, 1),
        Font = Font.GothamBlack,
        TextSize = 26
    })
    
    SafeCreate("UICorner", {
        CornerRadius = UDim.new(1, 0),
        Parent = self.CloseButton
    })
    
    SafeCreate("UIStroke", {
        Color = Color3.new(1, 1, 1),
        Thickness = 1.5,
        Transparency = 0.2,
        Parent = self.CloseButton
    })
    
    self.CloseButton.MouseButton1Click:Connect(function()
        self:Toggle()
    end)
    
    -- Sidebar for desktop
    if not self.IsMobile then
        self.Sidebar = SafeCreate("Frame", {
            Name = "Sidebar",
            Parent = self.Background,
            Position = UDim2.new(0, 0, 0, 79),
            Size = UDim2.new(0, 180, 1, -79),
            BackgroundColor3 = self.CurrentTheme.Surface2,
            BorderSizePixel = 0
        })
        
        if self.Config.RoundedCorners then
            SafeCreate("UICorner", {
                CornerRadius = UDim.new(0, 0, 0, 20),
                Parent = self.Sidebar
            })
        end
        
        self.SectionList = SafeCreate("ScrollingFrame", {
            Name = "SectionList",
            Parent = self.Sidebar,
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            ScrollBarThickness = 3,
            ScrollBarImageColor3 = self.CurrentTheme.AccentColor,
            CanvasSize = UDim2.new(0, 0, 0, 0),
            AutomaticCanvasSize = Enum.AutomaticSize.Y
        })
        
        SafeCreate("UIListLayout", {
            SortOrder = Enum.SortOrder.LayoutOrder,
            Padding = UDim.new(0, 8),
            Parent = self.SectionList
        })
        
        SafeCreate("UIPadding", {
            PaddingTop = UDim.new(0, 15),
            PaddingLeft = UDim.new(0, 15),
            PaddingRight = UDim.new(0, 15),
            Parent = self.SectionList
        })
    end
    
    -- Content Area
    self.ContentArea = SafeCreate("Frame", {
        Name = "ContentArea",
        Parent = self.Background,
        Position = self.IsMobile and UDim2.new(0, 0, 0, 79) or UDim2.new(0, 184, 0, 79),
        Size = self.IsMobile and UDim2.new(1, 0, 1, -79) or UDim2.new(1, -184, 1, -79),
        BackgroundTransparency = 1
    })
    
    self.ContentScroller = SafeCreate("ScrollingFrame", {
        Name = "ContentScroller",
        Parent = self.ContentArea,
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        ScrollBarThickness = 5,
        ScrollBarImageColor3 = self.CurrentTheme.AccentColor,
        ScrollBarImageTransparency = 0.5,
        CanvasSize = UDim2.new(0, 0, 0, 0),
        AutomaticCanvasSize = Enum.AutomaticSize.Y,
        ScrollingDirection = Enum.ScrollingDirection.Y
    })
    
    SafeCreate("UIListLayout", {
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 20),
        Parent = self.ContentScroller
    })
    
    SafeCreate("UIPadding", {
        PaddingTop = UDim.new(0, 20),
        PaddingRight = UDim.new(0, 20),
        PaddingLeft = UDim.new(0, 20),
        PaddingBottom = UDim.new(0, 20),
        Parent = self.ContentScroller
    })
    
    -- Create open button in StarterGui (like Library8_1)
    self.OpenButton = SafeCreate("TextButton", {
        Name = "OpenMenuButton",
        Parent = StarterGui,
        Text = "‚ò∞",
        TextColor3 = self.CurrentTheme.Text,
        Font = Font.GothamBold,
        TextSize = 24,
        BackgroundColor3 = self.CurrentTheme.AccentColor,
        Size = UDim2.new(0, 50, 0, 50),
        Position = UDim2.new(0, 20, 0.5, -25),
        ZIndex = 10000,
        AutoButtonColor = false,
        Active = true
    })
    
    SafeCreate("UICorner", {
        CornerRadius = UDim.new(1, 0),
        Parent = self.OpenButton
    })
    
    SafeCreate("UIStroke", {
        Color = Color3.fromRGB(255, 255, 255),
        Thickness = 2,
        Parent = self.OpenButton
    })
    
    CreateDraggable(self.OpenButton, self.OpenButton)
    
    self.OpenButton.MouseButton1Click:Connect(function()
        self:Toggle()
    end)
    
    self.OpenButton.TouchTap:Connect(function()
        self:Toggle()
    end)
end

-- Setup background blur
function Nova:SetupBackgroundBlur()
    if self.Config.BlurEnabled then
        local blur = Instance.new("BlurEffect")
        blur.Name = "MenuBlur"
        blur.Size = 5
        blur.Enabled = false
        blur.Parent = Lighting
        
        self.BlurEffect = blur
    end
end

-- Floating texts (from Library8_1)
function Nova:CreateFloatingTexts()
    if not self.Config.EnableFloatingText then return end
    
    local positions = {
        UDim2.new(0, 30, 0, 30),
        UDim2.new(1, -180, 0, 30),
        UDim2.new(0, 30, 1, -70),
        UDim2.new(1, -180, 1, -70),
        UDim2.new(0.5, -75, 0.5, -20)
    }
    
    for i, pos in ipairs(positions) do
        local textData = CreateFloatingText(self.Background, "NOVA", pos, i)
        table.insert(self.FloatingTexts, textData)
    end
end

-- Snow Effect
function Nova:CreateSnowEffect()
    if not self.Config.SnowEffect then return end
    
    local snowContainer = SafeCreate("Frame", {
        Name = "SnowContainer",
        Parent = self.ScreenGui,
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        ZIndex = 0
    })
    
    local snowflakeCount = self.IsMobile and 25 or 45
    
    for i = 1, snowflakeCount do
        local size = math.random(4, 12)
        local snow = SafeCreate("Frame", {
            Name = "SnowFlake_" .. i,
            Parent = snowContainer,
            Size = UDim2.new(0, size, 0, size),
            Position = UDim2.new(0, math.random(-50, 800), 0, -math.random(20, 150)),
            BackgroundColor3 = Color3.new(1, 1, 1),
            BackgroundTransparency = math.random(6, 9) / 10,
            Rotation = math.random(0, 360)
        })
        
        SafeCreate("UICorner", {
            CornerRadius = UDim.new(1, 0),
            Parent = snow
        })
        
        table.insert(self.SnowParticles, {
            Instance = snow,
            Speed = math.random(10, 25) / 10,
            Drift = math.random(-5, 5) / 10,
            Spin = math.random(-3, 3)
        })
    end
    
    -- Snow animation
    self.SnowThread = task.spawn(function()
        while self.ScreenGui and self.ScreenGui.Parent do
            for _, snowData in ipairs(self.SnowParticles) do
                local snow = snowData.Instance
                if snow then
                    local currentPos = snow.Position
                    local newY = currentPos.Y.Offset + snowData.Speed
                    local newX = currentPos.X.Offset + snowData.Drift
                    
                    if newY > 800 then
                        snow.Position = UDim2.new(0, math.random(-50, 800), 0, -30)
                    else
                        snow.Position = UDim2.new(0, newX, 0, newY)
                    end
                    
                    snow.Rotation = snow.Rotation + snowData.Spin
                end
            end
            task.wait(0.04)
        end
    end)
end

-- Glow Effect
function Nova:CreateGlowEffect()
    local glow = SafeCreate("Frame", {
        Name = "Glow",
        Parent = self.Container,
        Size = UDim2.new(1, 40, 1, 40),
        Position = UDim2.new(0, -20, 0, -20),
        BackgroundTransparency = 1,
        ZIndex = -1
    })
    
    SafeCreate("UIGradient", {
        Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, self.CurrentTheme.AccentColor),
            ColorSequenceKeypoint.new(0.5, self.CurrentTheme.AccentColor:Lerp(Color3.new(1, 1, 1), 0.4)),
            ColorSequenceKeypoint.new(1, self.CurrentTheme.AccentColor)
        }),
        Rotation = 45,
        Transparency = NumberSequence.new({
            NumberSequenceKeypoint.new(0, 0.95),
            NumberSequenceKeypoint.new(0.5, 0.15),
            NumberSequenceKeypoint.new(1, 0.95)
        }),
        Parent = glow
    })
    
    if self.Config.Animations then
        task.spawn(function()
            while glow and glow.Parent do
                CreateTween(glow, {Rotation = 360}, 18, EasingStyle.Linear)
                task.wait(18)
                glow.Rotation = 0
            end
        end)
    end
end

-- Shadow Effect
function Nova:CreateShadowEffect()
    local shadow = SafeCreate("ImageLabel", {
        Name = "Shadow",
        Parent = self.Container,
        Size = UDim2.new(1, 30, 1, 30),
        Position = UDim2.new(0, -15, 0, -15),
        BackgroundTransparency = 1,
        Image = "rbxassetid://5554236805",
        ImageColor3 = Color3.new(0, 0, 0),
        ImageTransparency = 0.85,
        ScaleType = Enum.ScaleType.Slice,
        SliceCenter = Rect.new(10, 10, 118, 118),
        ZIndex = -2
    })
end

-- Input Handling
function Nova:InitializeInput()
    if not self.IsMobile then
        local conn = UserInputService.InputBegan:Connect(function(input, processed)
            if not processed and input.KeyCode == self.Config.Keybind then
                self:Toggle()
            end
        end)
        table.insert(self.Connections, conn)
    end
    
    -- Close on background click
    local backgroundConn = UserInputService.InputBegan:Connect(function(input)
        if self.IsOpen and input.UserInputType == UserInputType.MouseButton1 then
            local mousePos = UserInputService:GetMouseLocation()
            local containerPos = self.Container.AbsolutePosition
            local containerSize = self.Container.AbsoluteSize
            
            -- Check if click is outside container
            if mousePos.X < containerPos.X or mousePos.X > containerPos.X + containerSize.X or
               mousePos.Y < containerPos.Y or mousePos.Y > containerPos.Y + containerSize.Y then
                self:Toggle()
            end
        end
    end)
    table.insert(self.Connections, backgroundConn)
end

-- Menu Control
function Nova:Toggle()
    self.IsOpen = not self.IsOpen
    
    if self.IsOpen then
        -- Show menu
        self.Container.Visible = true
        self.Container.Position = UDim2.new(0.5, 0, 0.5, -60)
        self.Container.BackgroundTransparency = 1
        
        if self.BlurEffect then
            self.BlurEffect.Enabled = true
        end
        
        CreateTween(self.Container, {
            Position = UDim2.new(0.5, 0, 0.5, 0),
            BackgroundTransparency = 0
        }, 0.5, EasingStyle.Back)
        
        CreateTween(self.Background, {
            BackgroundTransparency = self.Config.BackgroundTransparency
        }, 0.5)
        
        CreateTween(self.OpenButton, {
            BackgroundTransparency = 0.5,
            TextTransparency = 0.5
        }, 0.3)
        
        -- Animate logo
        if self.Config.Animations then
            CreateTween(self.Logo, {
                Rotation = 360,
                TextColor3 = self.CurrentTheme.AccentColor:Lerp(Color3.new(1, 1, 1), 0.5)
            }, 0.8, EasingStyle.Quint)
            task.wait(0.8)
            self.Logo.Rotation = 0
            CreateTween(self.Logo, {
                TextColor3 = self.CurrentTheme.AccentColor
            }, 0.3)
        end
    else
        -- Hide menu
        if self.BlurEffect then
            self.BlurEffect.Enabled = false
        end
        
        CreateTween(self.Container, {
            Position = UDim2.new(0.5, 0, 0.5, -60),
            BackgroundTransparency = 1
        }, 0.35, EasingStyle.Quad)
        
        CreateTween(self.Background, {
            BackgroundTransparency = 1
        }, 0.35)
        
        CreateTween(self.OpenButton, {
            BackgroundTransparency = 0,
            TextTransparency = 0
        }, 0.25)
        
        task.wait(0.35)
        self.Container.Visible = false
    end
end

-- Settings Menu (new function)
function Nova:OpenSettingsMenu()
    if self.SettingsGUI then
        self.SettingsGUI.Enabled = not self.SettingsGUI.Enabled
        return
    end
    
    -- Create settings GUI
    local settingsGui = SafeCreate("ScreenGui", {
        Name = self.MenuName .. "_Settings",
        Parent = CoreGui,
        ResetOnSpawn = false,
        ZIndexBehavior = Enum.ZIndexBehavior.Global,
        DisplayOrder = 9997
    })
    
    local settingsContainer = SafeCreate("Frame", {
        Name = "SettingsContainer",
        Parent = settingsGui,
        BackgroundColor3 = self.CurrentTheme.Surface,
        BackgroundTransparency = self.Config.BackgroundTransparency,
        Size = UDim2.new(0, 550, 0, 400),
        Position = UDim2.new(0.5, -275, 0.5, -200)
    })
    
    SafeCreate("UICorner", {
        CornerRadius = UDim.new(0, 20),
        Parent = settingsContainer
    })
    
    SafeCreate("UIStroke", {
        Color = self.CurrentTheme.AccentColor,
        Thickness = 2,
        Parent = settingsContainer
    })
    
    -- Settings title bar
    local settingsTitleBar = SafeCreate("Frame", {
        Name = "SettingsTitleBar",
        BackgroundColor3 = self.CurrentTheme.AccentColor,
        Size = UDim2.new(1, 0, 0, 40),
        Position = UDim2.new(0, 0, 0, 0),
        Parent = settingsContainer
    })
    
    SafeCreate("UICorner", {
        CornerRadius = UDim.new(0, 20, 0, 0),
        Parent = settingsTitleBar
    })
    
    local titleLabel = SafeCreate("TextLabel", {
        Name = "Title",
        Text = "Settings",
        TextColor3 = self.CurrentTheme.Text,
        Font = Font.GothamBold,
        TextSize = 18,
        BackgroundTransparency = 1,
        Size = UDim2.new(0.8, 0, 1, 0),
        Position = UDim2.new(0, 15, 0, 0),
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = settingsTitleBar
    })
    
    local closeSettingsButton = SafeCreate("TextButton", {
        Name = "CloseSettings",
        Text = "√ó",
        TextColor3 = self.CurrentTheme.Text,
        Font = Font.GothamBold,
        TextSize = 26,
        BackgroundTransparency = 1,
        Size = UDim2.new(0, 40, 1, 0),
        Position = UDim2.new(1, -40, 0, 0),
        Parent = settingsTitleBar
    })
    
    -- Settings content
    local settingsContent = SafeCreate("ScrollingFrame", {
        Name = "SettingsContent",
        BackgroundTransparency = 1,
        Size = UDim2.new(1, -40, 1, -60),
        Position = UDim2.new(0, 20, 0, 50),
        ScrollingDirection = Enum.ScrollingDirection.Y,
        ScrollBarThickness = 3,
        Parent = settingsContainer
    })
    
    local settingsContentLayout = SafeCreate("UIListLayout", {
        Padding = UDim.new(0, 10),
        Parent = settingsContent
    })
    
    local settingsContentPadding = SafeCreate("UIPadding", {
        PaddingLeft = UDim.new(0, 10),
        PaddingRight = UDim.new(0, 10),
        PaddingTop = UDim.new(0, 10),
        PaddingBottom = UDim.new(0, 10),
        Parent = settingsContent
    })
    
    self.SettingsGUI = settingsGui
    self.SettingsGUI.Enabled = true
    
    -- Create settings options
    self:CreateSettingsContent(settingsContent)
    
    closeSettingsButton.MouseButton1Click:Connect(function()
        settingsGui.Enabled = false
    end)
    
    closeSettingsButton.TouchTap:Connect(function()
        settingsGui.Enabled = false
    end)
    
    CreateDraggable(settingsContainer, settingsTitleBar)
end

function Nova:CreateSettingsContent(container)
    local theme = self.CurrentTheme
    
    -- Theme selector
    local themeLabel = SafeCreate("TextLabel", {
        Text = "Theme",
        TextColor3 = theme.Text,
        Font = Font.GothamMedium,
        TextSize = 16,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 25),
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = container
    })
    
    local themeButtonsFrame = SafeCreate("Frame", {
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 40),
        Parent = container
    })
    
    local themeNames = {"GoldenNewYear", "ModernElegant", "WinterWonderland"}
    
    for i, themeName in ipairs(themeNames) do
        local themeBtn = SafeCreate("TextButton", {
            Text = Nova.Themes[themeName].Name,
            TextColor3 = theme.Text,
            Font = Font.Gotham,
            TextSize = 12,
            BackgroundColor3 = Nova.Themes[themeName].AccentColor,
            Size = UDim2.new(0.3, -5, 1, 0),
            Position = UDim2.new((i-1) * 0.33, 0, 0, 0),
            AutoButtonColor = false,
            Parent = themeButtonsFrame
        })
        
        SafeCreate("UICorner", {
            CornerRadius = UDim.new(0, 8),
            Parent = themeBtn
        })
        
        themeBtn.MouseButton1Click:Connect(function()
            self.Config.Theme = themeName
            self.CurrentTheme = Nova.Themes[themeName]
            self:ApplyTheme()
            self:ShowNotification("Theme changed to " .. Nova.Themes[themeName].Name, theme.AccentColor)
        end)
    end
    
    -- Toggle settings
    local function CreateSettingToggle(text, configKey, default)
        local toggleFrame = SafeCreate("Frame", {
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 0, 36),
            Parent = container
        })
        
        local label = SafeCreate("TextLabel", {
            Text = text,
            TextColor3 = theme.Text,
            Font = Font.Gotham,
            TextSize = 14,
            BackgroundTransparency = 1,
            Size = UDim2.new(0.7, 0, 1, 0),
            Position = UDim2.new(0, 0, 0, 0),
            TextXAlignment = Enum.TextXAlignment.Left,
            Parent = toggleFrame
        })
        
        local toggleButton = SafeCreate("TextButton", {
            Text = "",
            BackgroundColor3 = self.Config[configKey] and theme.AccentColor or theme.Surface2,
            Size = UDim2.new(0, 48, 0, 26),
            Position = UDim2.new(1, -48, 0.5, -13),
            AutoButtonColor = false,
            Parent = toggleFrame
        })
        
        SafeCreate("UICorner", {
            CornerRadius = UDim.new(1, 0),
            Parent = toggleButton
        })
        
        local toggleCircle = SafeCreate("Frame", {
            BackgroundColor3 = Color3.new(1, 1, 1),
            Size = UDim2.new(0, 20, 0, 20),
            Position = self.Config[configKey] and UDim2.new(1, -24, 0.5, -10) or UDim2.new(0, 4, 0.5, -10),
            Parent = toggleButton
        })
        
        SafeCreate("UICorner", {
            CornerRadius = UDim.new(1, 0),
            Parent = toggleCircle
        })
        
        toggleButton.MouseButton1Click:Connect(function()
            self.Config[configKey] = not self.Config[configKey]
            
            if configKey == "Animations" and self.Config.Animations then
                CreateTween(toggleButton, {BackgroundColor3 = theme.AccentColor})
                CreateTween(toggleCircle, {Position = UDim2.new(1, -24, 0.5, -10)})
            else
                CreateTween(toggleButton, {BackgroundColor3 = self.Config[configKey] and theme.AccentColor or theme.Surface2})
                CreateTween(toggleCircle, {Position = self.Config[configKey] and UDim2.new(1, -24, 0.5, -10) or UDim2.new(0, 4, 0.5, -10)})
            end
            
            self:ShowNotification(text .. " " .. (self.Config[configKey] and "Enabled" or "Disabled"), 
                self.Config[configKey] and theme.Success or theme.Warning)
        end)
    end
    
    CreateSettingToggle("Animations", "Animations", true)
    CreateSettingToggle("Glow Effect", "GlowEffect", true)
    CreateSettingToggle("Snow Effect", "SnowEffect", true)
    CreateSettingToggle("Shadow Effect", "ShadowEffect", true)
    CreateSettingToggle("Notifications", "EnableNotifications", true)
    CreateSettingToggle("Ripple Effects", "EnableRippleEffects", true)
    CreateSettingToggle("Floating Text", "EnableFloatingText", true)
    
    -- Keybind setting
    local keybindFrame = SafeCreate("Frame", {
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 36),
        Parent = container
    })
    
    SafeCreate("TextLabel", {
        Text = "Toggle Keybind",
        TextColor3 = theme.Text,
        Font = Font.Gotham,
        TextSize = 14,
        BackgroundTransparency = 1,
        Size = UDim2.new(0.7, 0, 1, 0),
        Position = UDim2.new(0, 0, 0, 0),
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = keybindFrame
    })
    
    local keybindButton = SafeCreate("TextButton", {
        Text = tostring(self.Config.Keybind):gsub("Enum.KeyCode.", ""),
        TextColor3 = theme.Text,
        Font = Font.Gotham,
        TextSize = 12,
        BackgroundColor3 = theme.Surface2,
        Size = UDim2.new(0.25, 0, 0.7, 0),
        Position = UDim2.new(0.75, 0, 0.15, 0),
        AutoButtonColor = false,
        Parent = keybindFrame
    })
    
    SafeCreate("UICorner", {
        CornerRadius = UDim.new(0, 6),
        Parent = keybindButton
    })
    
    local listening = false
    keybindButton.MouseButton1Click:Connect(function()
        if not listening then
            listening = true
            keybindButton.Text = "Press any key..."
            keybindButton.BackgroundColor3 = theme.AccentColor
            
            local conn
            conn = UserInputService.InputBegan:Connect(function(input)
                if input.KeyCode ~= Enum.KeyCode.Unknown then
                    self.Config.Keybind = input.KeyCode
                    keybindButton.Text = tostring(input.KeyCode):gsub("Enum.KeyCode.", "")
                    keybindButton.BackgroundColor3 = theme.Surface2
                    listening = false
                    conn:Disconnect()
                    self:ShowNotification("Keybind set to " .. keybindButton.Text, theme.Success)
                end
            end)
        end
    end)
    
    -- Reset button
    local resetButton = SafeCreate("TextButton", {
        Text = "Reset All Settings",
        TextColor3 = Color3.new(1, 1, 1),
        Font = Font.GothamMedium,
        TextSize = 14,
        BackgroundColor3 = theme.Warning,
        Size = UDim2.new(1, 0, 0, 40),
        AutoButtonColor = false,
        Parent = container
    })
    
    SafeCreate("UICorner", {
        CornerRadius = UDim.new(0, 10),
        Parent = resetButton
    })
    
    resetButton.MouseButton1Click:Connect(function()
        for k, v in pairs(DEFAULT_CONFIG) do
            self.Config[k] = v
        end
        self.CurrentTheme = Nova.Themes[self.Config.Theme]
        self:ApplyTheme()
        self:ShowNotification("Settings reset to default", theme.Info)
    end)
end

-- Section Creation
function Nova:Section(name, icon)
    local sectionId = #self.Sections + 1
    local theme = self.CurrentTheme
    
    -- Create sidebar button (desktop only)
    local button, buttonText
    if not self.IsMobile then
        button = SafeCreate("TextButton", {
            Name = name .. "Button",
            Parent = self.SectionList,
            Size = UDim2.new(1, 0, 0, 46),
            BackgroundColor3 = theme.Surface2,
            AutoButtonColor = false,
            Text = "",
            LayoutOrder = sectionId
        })
        
        SafeCreate("UICorner", {
            CornerRadius = UDim.new(0, 12),
            Parent = button
        })
        
        SafeCreate("UIStroke", {
            Color = theme.Border,
            Thickness = 1,
            Transparency = 0.3,
            Parent = button
        })
        
        -- Icon
        local iconLabel = SafeCreate("TextLabel", {
            Parent = button,
            AnchorPoint = Vector2.new(0, 0.5),
            Position = UDim2.new(0, 12, 0.5, 0),
            Size = UDim2.new(0, 26, 0, 26),
            BackgroundTransparency = 1,
            Text = icon or "‚≠ê",
            TextColor3 = theme.SubText,
            Font = Font.GothamBold,
            TextSize = 18
        })
        
        buttonText = SafeCreate("TextLabel", {
            Parent = button,
            AnchorPoint = Vector2.new(0, 0.5),
            Position = UDim2.new(0, 48, 0.5, 0),
            Size = UDim2.new(1, -48, 1, 0),
            BackgroundTransparency = 1,
            Text = name,
            TextColor3 = theme.SubText,
            Font = Font.GothamMedium,
            TextSize = 15,
            TextXAlignment = Enum.TextXAlignment.Left
        })
    end
    
    -- Create content frame
    local contentFrame = SafeCreate("Frame", {
        Name = name .. "Content",
        Parent = self.ContentScroller,
        Size = UDim2.new(1, 0, 0, 0),
        BackgroundTransparency = 1,
        LayoutOrder = sectionId,
        Visible = sectionId == 1
    })
    
    local contentLayout = SafeCreate("UIListLayout", {
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 20)
    })
    contentLayout.Parent = contentFrame
    
    contentLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        if contentFrame then
            contentFrame.Size = UDim2.new(1, 0, 0, contentLayout.AbsoluteContentSize.Y)
        end
    end)
    
    -- Set first section as active
    if sectionId == 1 then
        self.ActiveSection = contentFrame
        if button then
            button.BackgroundColor3 = theme.AccentColor
            if buttonText then
                buttonText.TextColor3 = Color3.new(1, 1, 1)
            end
        end
    end
    
    -- Button click handler
    if button then
        button.MouseButton1Click:Connect(function()
            if self.ActiveSection then
                self.ActiveSection.Visible = false
            end
            
            -- Reset all buttons
            for _, btn in ipairs(self.SectionList:GetChildren()) do
                if btn:IsA("TextButton") then
                    local txt = btn:FindFirstChildWhichIsA("TextLabel", true)
                    if txt then
                        CreateTween(btn, {BackgroundColor3 = theme.Surface2})
                        CreateTween(txt, {TextColor3 = theme.SubText})
                    end
                end
            end
            
            -- Activate selected
            contentFrame.Visible = true
            self.ActiveSection = contentFrame
            
            if button then
                CreateTween(button, {BackgroundColor3 = theme.AccentColor})
                if buttonText then
                    CreateTween(buttonText, {TextColor3 = Color3.new(1, 1, 1)})
                end
            end
            
            -- Scroll to top
            self.ContentScroller.CanvasPosition = Vector2.new(0, 0)
        end)
        
        -- Hover effects
        button.MouseEnter:Connect(function()
            if contentFrame ~= self.ActiveSection then
                CreateTween(button, {BackgroundColor3 = theme.Hover})
            end
        end)
        
        button.MouseLeave:Connect(function()
            if contentFrame ~= self.ActiveSection then
                CreateTween(button, {BackgroundColor3 = theme.Surface2})
            end
        end)
    end
    
    -- Store section
    local sectionData = {
        Name = name,
        Button = button,
        Frame = contentFrame,
        ContainerWidgets = {}
    }
    
    table.insert(self.Sections, sectionData)
    
    -- Section API
    local api = {}
    
    function api:Container(title, subtitle)
        local container = SafeCreate("Frame", {
            Parent = contentFrame,
            Size = UDim2.new(1, 0, 0, 0),
            BackgroundTransparency = 1,
            LayoutOrder = #contentFrame:GetChildren() + 1
        })
        
        local containerLayout = SafeCreate("UIListLayout", {
            SortOrder = Enum.SortOrder.LayoutOrder,
            Padding = UDim.new(0, 16)
        })
        containerLayout.Parent = container
        
        containerLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
            if container then
                container.Size = UDim2.new(1, 0, 0, containerLayout.AbsoluteContentSize.Y)
            end
        end)
        
        -- Container header
        if title then
            local titleFrame = SafeCreate("Frame", {
                Parent = container,
                Size = UDim2.new(1, 0, 0, subtitle and 60 or 42),
                BackgroundTransparency = 1,
                LayoutOrder = 0
            })
            
            local titleLabel = SafeCreate("TextLabel", {
                Parent = titleFrame,
                AnchorPoint = Vector2.new(0, 0),
                Position = UDim2.new(0, 0, 0, 0),
                Size = UDim2.new(1, 0, 0, 30),
                BackgroundTransparency = 1,
                Text = "  " .. title,
                TextColor3 = theme.Text,
                Font = Font.GothamBold,
                TextSize = 20,
                TextXAlignment = Enum.TextXAlignment.Left
            })
            
            -- Accent line
            local accentLine = SafeCreate("Frame", {
                Parent = titleFrame,
                AnchorPoint = Vector2.new(0, 1),
                Position = UDim2.new(0, 0, 0, 32),
                Size = UDim2.new(0.25, 0, 0, 2),
                BackgroundColor3 = theme.AccentColor,
                BorderSizePixel = 0
            })
            
            SafeCreate("UICorner", {
                CornerRadius = UDim.new(1, 0),
                Parent = accentLine
            })
            
            if subtitle then
                SafeCreate("TextLabel", {
                    Parent = titleFrame,
                    AnchorPoint = Vector2.new(0, 0),
                    Position = UDim2.new(0, 0, 0, 38),
                    Size = UDim2.new(1, 0, 0, 18),
                    BackgroundTransparency = 1,
                    Text = "  " .. subtitle,
                    TextColor3 = theme.SubText,
                    Font = Font.Gotham,
                    TextSize = 13,
                    TextXAlignment = Enum.TextXAlignment.Left
                })
            end
        end
        
        local containerAPI = {}
        local containerWidgets = {}
        
        -- Button Widget (improved with ripple effect)
        function containerAPI:Button(text, callback, icon, color)
            local buttonFrame = SafeCreate("Frame", {
                Parent = container,
                Size = UDim2.new(1, 0, 0, 50),
                BackgroundTransparency = 1
            })
            
            local buttonWidget = SafeCreate("TextButton", {
                Parent = buttonFrame,
                Size = UDim2.new(1, 0, 0, 50),
                BackgroundColor3 = color or theme.Surface,
                AutoButtonColor = false,
                Text = (icon or "‚ö°") .. "  " .. text,
                TextColor3 = theme.Text,
                Font = Font.GothamMedium,
                TextSize = 15
            })
            
            SafeCreate("UICorner", {
                CornerRadius = UDim.new(0, 14),
                Parent = buttonWidget
            })
            
            SafeCreate("UIStroke", {
                Parent = buttonWidget,
                Color = theme.Border,
                Thickness = 1,
                Transparency = 0.4
            })
            
            -- Hover effect
            buttonWidget.MouseEnter:Connect(function()
                CreateTween(buttonWidget, {
                    BackgroundColor3 = theme.Hover,
                    TextColor3 = theme.AccentColor
                }, 0.15)
            end)
            
            buttonWidget.MouseLeave:Connect(function()
                CreateTween(buttonWidget, {
                    BackgroundColor3 = color or theme.Surface,
                    TextColor3 = theme.Text
                }, 0.15)
            end)
            
            -- Click animation with ripple
            buttonWidget.MouseButton1Click:Connect(function()
                if self.Config.EnableRippleEffects then
                    CreateRippleEffect(buttonWidget, theme.AccentColor)
                end
                
                CreateTween(buttonWidget, {
                    BackgroundColor3 = theme.AccentColor,
                    TextColor3 = Color3.new(1, 1, 1),
                    Size = UDim2.new(0.98, 0, 0, 50)
                }, 0.1)
                
                task.wait(0.1)
                
                CreateTween(buttonWidget, {
                    BackgroundColor3 = color or theme.Surface,
                    TextColor3 = theme.Text,
                    Size = UDim2.new(1, 0, 0, 50)
                }, 0.1)
                
                if callback then
                    local success, err = pcall(callback)
                    if not success and Nova.Debug then
                        warn("[Nova UI] Button error:", err)
                    end
                end
            end)
            
            local buttonObj = {
                Instance = buttonWidget,
                SetText = function(self, newText)
                    buttonWidget.Text = newText
                    return self
                end,
                SetColor = function(self, newColor)
                    buttonWidget.BackgroundColor3 = newColor
                    return self
                end,
                Destroy = function(self)
                    buttonWidget:Destroy()
                end
            }
            
            table.insert(Nova.containerWidgets, buttonObj)
            table.insert(Nova.WidgetInstances, buttonWidget)
            return buttonObj
        end
        
        -- Toggle Widget
        function containerAPI:Toggle(text, default, callback, icon)
            local toggleFrame = SafeCreate("Frame", {
                Parent = container,
                Size = UDim2.new(1, 0, 0, 46),
                BackgroundTransparency = 1
            })
            
            local label = SafeCreate("TextLabel", {
                Parent = toggleFrame,
                AnchorPoint = Vector2.new(0, 0.5),
                Position = UDim2.new(0, 0, 0.5, 0),
                Size = UDim2.new(0.7, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = (icon or "üîò") .. "  " .. text,
                TextColor3 = theme.Text,
                Font = Font.GothamMedium,
                TextSize = 15,
                TextXAlignment = Enum.TextXAlignment.Left
            })
            
            local toggleButton = SafeCreate("TextButton", {
                Parent = toggleFrame,
                AnchorPoint = Vector2.new(1, 0.5),
                Position = UDim2.new(1, 0, 0.5, 0),
                Size = UDim2.new(0, 60, 0, 30),
                BackgroundColor3 = default and theme.AccentColor or theme.Surface,
                AutoButtonColor = false,
                Text = ""
            })
            
            SafeCreate("UICorner", {
                CornerRadius = UDim.new(1, 0),
                Parent = toggleButton
            })
            
            SafeCreate("UIStroke", {
                Parent = toggleButton,
                Color = theme.Border,
                Thickness = 1
            })
            
            local toggleCircle = SafeCreate("Frame", {
                Parent = toggleButton,
                AnchorPoint = Vector2.new(default and 1 or 0, 0.5),
                Position = default and UDim2.new(1, -16, 0.5, 0) or UDim2.new(0, 16, 0.5, 0),
                Size = UDim2.new(0, 22, 0, 22),
                BackgroundColor3 = Color3.new(1, 1, 1)
            })
            
            SafeCreate("UICorner", {
                CornerRadius = UDim.new(1, 0),
                Parent = toggleCircle
            })
            
            SafeCreate("UIStroke", {
                Parent = toggleCircle,
                Color = theme.AccentColor,
                Thickness = 2
            })
            
            local state = default or false
            
            toggleButton.MouseButton1Click:Connect(function()
                state = not state
                
                if state then
                    CreateTween(toggleButton, {BackgroundColor3 = theme.AccentColor})
                    CreateTween(toggleCircle, {Position = UDim2.new(1, -16, 0.5, 0)})
                else
                    CreateTween(toggleButton, {BackgroundColor3 = theme.Surface})
                    CreateTween(toggleCircle, {Position = UDim2.new(0, 16, 0.5, 0)})
                end
                
                if callback then
                    local success, err = pcall(callback, state)
                    if not success and Nova.Debug then
                        warn("[Nova UI] Toggle error:", err)
                    end
                end
            end)
            
            local toggleObj = {
                Instance = toggleButton,
                Set = function(self, value)
                    if type(value) == "boolean" and value ~= state then
                        toggleButton.MouseButton1Click:Fire()
                    end
                    return self
                end,
                Get = function(self)
                    return state
                end,
                Destroy = function(self)
                    toggleButton:Destroy()
                end
            }
            
            table.insert(Nova.containerWidgets, toggleObj)
            table.insert(Nova.WidgetInstances, toggleButton)
            return toggleObj
        end
        
        -- Slider Widget
        function containerAPI:Slider(text, min, max, default, callback, precision, icon)
            precision = precision or 0
            
            local sliderFrame = SafeCreate("Frame", {
                Parent = container,
                Size = UDim2.new(1, 0, 0, 78),
                BackgroundTransparency = 1
            })
            
            local topRow = SafeCreate("Frame", {
                Parent = sliderFrame,
                Size = UDim2.new(1, 0, 0, 26),
                BackgroundTransparency = 1
            })
            
            local label = SafeCreate("TextLabel", {
                Parent = topRow,
                AnchorPoint = Vector2.new(0, 0.5),
                Position = UDim2.new(0, 0, 0.5, 0),
                Size = UDim2.new(0.6, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = (icon or "üìä") .. "  " .. text,
                TextColor3 = theme.Text,
                Font = Font.GothamMedium,
                TextSize = 15,
                TextXAlignment = Enum.TextXAlignment.Left
            })
            
            local valueLabel = SafeCreate("TextLabel", {
                Parent = topRow,
                AnchorPoint = Vector2.new(1, 0.5),
                Position = UDim2.new(1, 0, 0.5, 0),
                Size = UDim2.new(0.4, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = string.format("%." .. precision .. "f", default or min),
                TextColor3 = theme.AccentColor,
                Font = Font.GothamBold,
                TextSize = 15,
                TextXAlignment = Enum.TextXAlignment.Right
            })
            
            local track = SafeCreate("Frame", {
                Parent = sliderFrame,
                Position = UDim2.new(0, 0, 0, 40),
                Size = UDim2.new(1, 0, 0, 8),
                BackgroundColor3 = theme.Surface
            })
            
            SafeCreate("UICorner", {
                CornerRadius = UDim.new(1, 0),
                Parent = track
            })
            
            SafeCreate("UIStroke", {
                Parent = track,
                Color = theme.Border,
                Thickness = 1
            })
            
            local fill = SafeCreate("Frame", {
                Parent = track,
                Size = UDim2.new(0, 0, 1, 0),
                BackgroundColor3 = theme.AccentColor
            })
            
            SafeCreate("UICorner", {
                CornerRadius = UDim.new(1, 0),
                Parent = fill
            })
            
            local handle = SafeCreate("Frame", {
                Parent = track,
                AnchorPoint = Vector2.new(0.5, 0.5),
                Position = UDim2.new(0, 0, 0.5, 0),
                Size = UDim2.new(0, 24, 0, 24),
                BackgroundColor3 = Color3.new(1, 1, 1),
                ZIndex = 2
            })
            
            SafeCreate("UICorner", {
                CornerRadius = UDim.new(1, 0),
                Parent = handle
            })
            
            SafeCreate("UIStroke", {
                Parent = handle,
                Color = theme.AccentColor,
                Thickness = 2.5
            })
            
            local value = math.clamp(default or min, min, max)
            local dragging = false
            
            local function updateSlider(mouseX)
                local absoluteX = track.AbsolutePosition.X
                local absoluteWidth = track.AbsoluteSize.X
                
                if not absoluteX or not absoluteWidth then return end
                
                local relativeX = math.clamp(mouseX - absoluteX, 0, absoluteWidth)
                local percentage = relativeX / absoluteWidth
                
                if precision == 0 then
                    value = math.floor(min + (max - min) * percentage)
                else
                    value = min + (max - min) * percentage
                    value = math.floor(value * (10 ^ precision)) / (10 ^ precision)
                end
                
                fill.Size = UDim2.new(percentage, 0, 1, 0)
                handle.Position = UDim2.new(percentage, 0, 0.5, 0)
                valueLabel.Text = string.format("%." .. precision .. "f", value)
                
                if callback then
                    local success, err = pcall(callback, value)
                    if not success and Nova.Debug then
                        warn("[Nova UI] Slider error:", err)
                    end
                end
            end
            
            -- Set initial value
            local initialPercentage = (value - min) / (max - min)
            fill.Size = UDim2.new(initialPercentage, 0, 1, 0)
            handle.Position = UDim2.new(initialPercentage, 0, 0.5, 0)
            
            -- Input handlers
            local function beginDrag()
                dragging = true
            end
            
            local function endDrag()
                dragging = false
            end
            
            local function onInputBegan(input)
                if input.UserInputType == UserInputType.MouseButton1 or 
                   input.UserInputType == UserInputType.Touch then
                    beginDrag()
                    if input.UserInputType == UserInputType.Touch then
                        updateSlider(input.Position.X)
                    end
                end
            end
            
            local function onInputEnded(input)
                if input.UserInputType == UserInputType.MouseButton1 or 
                   input.UserInputType == UserInputType.Touch then
                    endDrag()
                end
            end
            
            handle.InputBegan:Connect(onInputBegan)
            handle.InputEnded:Connect(onInputEnded)
            
            track.InputBegan:Connect(function(input)
                if input.UserInputType == UserInputType.MouseButton1 or 
                   input.UserInputType == UserInputType.Touch then
                    beginDrag()
                    updateSlider(input.Position.X)
                end
            end)
            
            track.InputEnded:Connect(onInputEnded)
            
            local conn = UserInputService.InputChanged:Connect(function(input)
                if dragging and (input.UserInputType == UserInputType.MouseMovement or 
                   input.UserInputType == UserInputType.Touch) then
                    updateSlider(input.Position.X)
                end
            end)
            
            table.insert(self.Connections, conn)
            
            local sliderObj = {
                Instance = sliderFrame,
                Set = function(self, newValue)
                    value = math.clamp(newValue, min, max)
                    local percentage = (value - min) / (max - min)
                    fill.Size = UDim2.new(percentage, 0, 1, 0)
                    handle.Position = UDim2.new(percentage, 0, 0.5, 0)
                    valueLabel.Text = string.format("%." .. precision .. "f", value)
                    return self
                end,
                Get = function(self)
                    return value
                end,
                Destroy = function(self)
                    if conn then
                        conn:Disconnect()
                    end
                    sliderFrame:Destroy()
                end
            }
            
            table.insert(containerWidgets, sliderObj)
            table.insert(self.WidgetInstances, sliderFrame)
            return sliderObj
        end
        
        -- Dropdown Widget (FIXED)
        function containerAPI:Dropdown(text, options, default, callback, icon)
            local dropdownFrame = SafeCreate("Frame", {
                Parent = container,
                Size = UDim2.new(1, 0, 0, 50),
                BackgroundTransparency = 1
            })
            
            local label = SafeCreate("TextLabel", {
                Parent = dropdownFrame,
                AnchorPoint = Vector2.new(0, 0.5),
                Position = UDim2.new(0, 0, 0.5, 0),
                Size = UDim2.new(0.3, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = (icon or "üìã") .. "  " .. text,
                TextColor3 = theme.Text,
                Font = Font.GothamMedium,
                TextSize = 15,
                TextXAlignment = Enum.TextXAlignment.Left
            })
            
            local dropdownButton = SafeCreate("TextButton", {
                Parent = dropdownFrame,
                AnchorPoint = Vector2.new(1, 0.5),
                Position = UDim2.new(1, 0, 0.5, 0),
                Size = UDim2.new(0.7, 0, 1, 0),
                BackgroundColor3 = theme.Surface,
                AutoButtonColor = false,
                Text = default or "Select...",
                TextColor3 = theme.SubText,
                Font = Font.GothamMedium,
                TextSize = 14
            })
            
            SafeCreate("UICorner", {
                CornerRadius = UDim.new(0, 14),
                Parent = dropdownButton
            })
            
            SafeCreate("UIStroke", {
                Parent = dropdownButton,
                Color = theme.Border,
                Thickness = 1
            })
            
            local dropdownList = SafeCreate("Frame", {
                Parent = self.ScreenGui,
                Size = UDim2.new(0, 200, 0, 0),
                BackgroundColor3 = theme.Surface2,
                Visible = false,
                ZIndex = 1000,
                ClipsDescendants = true
            })
            
            SafeCreate("UICorner", {
                CornerRadius = UDim.new(0, 14),
                Parent = dropdownList
            })
            
            SafeCreate("UIStroke", {
                Parent = dropdownList,
                Color = theme.AccentColor,
                Thickness = 1.5
            })
            
            local listLayout = SafeCreate("UIListLayout", {
                Parent = dropdownList,
                SortOrder = Enum.SortOrder.LayoutOrder,
                Padding = UDim.new(0, 6)
            })
            
            SafeCreate("UIPadding", {
                Parent = dropdownList,
                PaddingTop = UDim.new(0, 10),
                PaddingBottom = UDim.new(0, 10),
                PaddingLeft = UDim.new(0, 10),
                PaddingRight = UDim.new(0, 10)
            })
            
            local selected = default
            local isOpen = false
            
            local function updateList()
                -- Clear existing options
                for _, child in ipairs(dropdownList:GetChildren()) do
                    if child:IsA("TextButton") then
                        child:Destroy()
                    end
                end
                
                -- Add new options
                for i, option in ipairs(options) do
                    local optionText = tostring(option)
                    local optionButton = SafeCreate("TextButton", {
                        Parent = dropdownList,
                        Size = UDim2.new(1, 0, 0, 38),
                        BackgroundColor3 = theme.Surface2,
                        AutoButtonColor = false,
                        Text = optionText,
                        TextColor3 = theme.Text,
                        Font = Font.Gotham,
                        TextSize = 13,
                        LayoutOrder = i,
                        ZIndex = 1001
                    })
                    
                    SafeCreate("UICorner", {
                        CornerRadius = UDim.new(0, 8),
                        Parent = optionButton
                    })
                    
                    if optionText == selected then
                        optionButton.BackgroundColor3 = theme.AccentColor
                        optionButton.TextColor3 = Color3.new(1, 1, 1)
                    end
                    
                    optionButton.MouseEnter:Connect(function()
                        if optionText ~= selected then
                            CreateTween(optionButton, {BackgroundColor3 = theme.Hover}, 0.15)
                        end
                    end)
                    
                    optionButton.MouseLeave:Connect(function()
                        if optionText ~= selected then
                            CreateTween(optionButton, {BackgroundColor3 = theme.Surface2}, 0.15)
                        end
                    end)
                    
                    optionButton.MouseButton1Click:Connect(function()
                        selected = option
                        dropdownButton.Text = optionText
                        dropdownButton.TextColor3 = theme.AccentColor
                        isOpen = false
                        
                        CreateTween(dropdownList, {
                            Size = UDim2.new(0, 200, 0, 0)
                        }, 0.2)
                        
                        task.wait(0.2)
                        dropdownList.Visible = false
                        
                        if callback then
                            local success, err = pcall(callback, option)
                            if not success and Nova.Debug then
                                warn("[Nova UI] Dropdown error:", err)
                            end
                        end
                    end)
                end
                
                local height = math.min(#options * 44, 250)
                dropdownList.Size = UDim2.new(0, 200, 0, isOpen and height or 0)
            end
            
            dropdownButton.MouseButton1Click:Connect(function()
                isOpen = not isOpen
                
                if isOpen then
                    local buttonPos = dropdownButton.AbsolutePosition
                    local buttonSize = dropdownButton.AbsoluteSize
                    
                    dropdownList.Position = UDim2.new(
                        0, buttonPos.X,
                        0, buttonPos.Y + buttonSize.Y + 6
                    )
                    
                    updateList()
                    dropdownList.Visible = true
                    
                    CreateTween(dropdownList, {
                        Size = UDim2.new(0, 200, 0, math.min(#options * 44, 250))
                    }, 0.25)
                else
                    CreateTween(dropdownList, {
                        Size = UDim2.new(0, 200, 0, 0)
                    }, 0.2)
                    
                    task.wait(0.2)
                    dropdownList.Visible = false
                end
            end)
            
            -- Close dropdown when clicking outside
            local dropdownConn
            dropdownConn = UserInputService.InputBegan:Connect(function(input)
                if isOpen and input.UserInputType == UserInputType.MouseButton1 then
                    local mousePos = input.Position
                    local listPos = dropdownList.AbsolutePosition
                    local listSize = dropdownList.AbsoluteSize
                    
                    if mousePos.X < listPos.X or mousePos.X > listPos.X + listSize.X or
                       mousePos.Y < listPos.Y or mousePos.Y > listPos.Y + listSize.Y then
                        isOpen = false
                        CreateTween(dropdownList, {
                            Size = UDim2.new(0, 200, 0, 0)
                        }, 0.2)
                        
                        task.wait(0.2)
                        dropdownList.Visible = false
                    end
                end
            end)
            
            table.insert(Nova.Connections, dropdownConn)
            updateList()
            
            local dropdownObj = {
                Instance = dropdownButton,
                SetOptions = function(self, newOptions)
                    if type(newOptions) == "table" then
                        options = newOptions
                        updateList()
                    end
                    return self
                end,
                Set = function(self, value)
                    selected = value
                    dropdownButton.Text = tostring(value)
                    dropdownButton.TextColor3 = theme.AccentColor
                    return self
                end,
                Get = function(self)
                    return selected
                end,
                Destroy = function(self)
                    if dropdownConn then
                        dropdownConn:Disconnect()
                    end
                    dropdownList:Destroy()
                    dropdownButton:Destroy()
                end
            }
            
            table.insert(Nova.containerWidgets, dropdownObj)
            table.insert(Nova.WidgetInstances, dropdownButton)
            return dropdownObj
        end
        
        -- Textbox Widget
        function containerAPI:Textbox(text, placeholder, callback, defaultValue, icon)
            local textboxFrame = SafeCreate("Frame", {
                Parent = container,
                Size = UDim2.new(1, 0, 0, 50),
                BackgroundTransparency = 1
            })
            
            local label = SafeCreate("TextLabel", {
                Parent = textboxFrame,
                AnchorPoint = Vector2.new(0, 0.5),
                Position = UDim2.new(0, 0, 0.5, 0),
                Size = UDim2.new(0.3, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = (icon or "üìù") .. "  " .. text,
                TextColor3 = theme.Text,
                Font = Font.GothamMedium,
                TextSize = 15,
                TextXAlignment = Enum.TextXAlignment.Left
            })
            
            local textbox = SafeCreate("TextBox", {
                Parent = textboxFrame,
                AnchorPoint = Vector2.new(1, 0.5),
                Position = UDim2.new(1, 0, 0.5, 0),
                Size = UDim2.new(0.7, 0, 1, 0),
                BackgroundColor3 = theme.Surface,
                PlaceholderText = placeholder or "Enter text...",
                Text = defaultValue or "",
                TextColor3 = theme.Text,
                Font = Font.Gotham,
                TextSize = 14,
                ClearTextOnFocus = false
            })
            
            SafeCreate("UICorner", {
                CornerRadius = UDim.new(0, 14),
                Parent = textbox
            })
            
            SafeCreate("UIStroke", {
                Parent = textbox,
                Color = theme.Border,
                Thickness = 1
            })
            
            if callback then
                textbox.FocusLost:Connect(function(enterPressed)
                    local success, err = pcall(callback, textbox.Text, enterPressed)
                    if not success and Nova.Debug then
                        warn("[Nova UI] Textbox error:", err)
                    end
                end)
            end
            
            local textboxObj = {
                Instance = textbox,
                SetText = function(self, value)
                    textbox.Text = value
                    return self
                end,
                GetText = function(self)
                    return textbox.Text
                end,
                SetCallback = function(self, newCallback)
                    if newCallback then
                        textbox.FocusLost:Connect(newCallback)
                    end
                    return self
                end,
                Destroy = function(self)
                    textbox:Destroy()
                end
            }
            
            table.insert(Nova.containerWidgets, textboxObj)
            table.insert(Nova.WidgetInstances, textbox)
            return textboxObj
        end
        
        -- Label Widget
        function containerAPI:Label(text, color, size, align)
            local labelFrame = SafeCreate("Frame", {
                Parent = container,
                Size = UDim2.new(1, 0, 0, size or 32),
                BackgroundTransparency = 1
            })
            
            local labelWidget = SafeCreate("TextLabel", {
                Parent = labelFrame,
                Size = UDim2.new(1, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = text,
                TextColor3 = color or theme.Text,
                Font = Font.Gotham,
                TextSize = size or 14,
                TextXAlignment = align or Enum.TextXAlignment.Left,
                TextWrapped = true
            })
            
            return labelWidget
        end
        
        -- Divider
        function containerAPI:Divider(color)
            local divider = SafeCreate("Frame", {
                Parent = container,
                Size = UDim2.new(1, 0, 0, 1),
                BackgroundColor3 = color or theme.Border,
                BackgroundTransparency = 0.6,
                BorderSizePixel = 0
            })
            
            SafeCreate("UICorner", {
                CornerRadius = UDim.new(1, 0),
                Parent = divider
            })
            
            return divider
        end
        
        -- Color Picker (from Library8_1)
        function containerAPI:ColorPicker(text, defaultColor, callback, icon)
            local colorFrame = SafeCreate("Frame", {
                Parent = container,
                Size = UDim2.new(1, 0, 0, 52),
                BackgroundTransparency = 1
            })
            
            local label = SafeCreate("TextLabel", {
                Parent = colorFrame,
                AnchorPoint = Vector2.new(0, 0.5),
                Position = UDim2.new(0, 0, 0.5, 0),
                Size = UDim2.new(0.5, 0, 0, 22),
                BackgroundTransparency = 1,
                Text = (icon or "üé®") .. "  " .. text,
                TextColor3 = theme.Text,
                Font = Font.GothamMedium,
                TextSize = 14,
                TextXAlignment = Enum.TextXAlignment.Left
            })
            
            local colorPreview = SafeCreate("TextButton", {
                Parent = colorFrame,
                AnchorPoint = Vector2.new(1, 0.5),
                Position = UDim2.new(1, 0, 0.5, 0),
                Size = UDim2.new(0, 36, 0, 36),
                BackgroundColor3 = defaultColor or theme.AccentColor,
                AutoButtonColor = false,
                Text = ""
            })
            
            SafeCreate("UICorner", {
                CornerRadius = UDim.new(0, 10),
                Parent = colorPreview
            })
            
            SafeCreate("UIStroke", {
                Color = Color3.fromRGB(255, 255, 255),
                Thickness = 2,
                Parent = colorPreview
            })
            
            local pickerFrame = SafeCreate("Frame", {
                Parent = self.ScreenGui,
                BackgroundColor3 = theme.Surface,
                Size = UDim2.new(0, 220, 0, 180),
                Position = UDim2.new(0.5, -110, 0.5, -90),
                Visible = false,
                ZIndex = 1000
            })
            
            SafeCreate("UICorner", {
                CornerRadius = UDim.new(0, 10),
                Parent = pickerFrame
            })
            
            SafeCreate("UIStroke", {
                Color = theme.AccentColor,
                Thickness = 2,
                Parent = pickerFrame
            })
            
            local colorGrid = {
                {Color3.fromRGB(255, 50, 50), Color3.fromRGB(255, 100, 50), Color3.fromRGB(255, 150, 50)},
                {Color3.fromRGB(50, 255, 50), Color3.fromRGB(100, 255, 100), Color3.fromRGB(150, 255, 150)},
                {Color3.fromRGB(50, 50, 255), Color3.fromRGB(100, 100, 255), Color3.fromRGB(150, 150, 255)},
                {Color3.fromRGB(255, 50, 255), Color3.fromRGB(255, 255, 50), Color3.fromRGB(50, 255, 255)},
                {Color3.fromRGB(255, 255, 255), Color3.fromRGB(200, 200, 200), Color3.fromRGB(100, 100, 100)}
            }
            
            local isOpen = false
            local currentColor = defaultColor or theme.AccentColor
            
            local function OpenPicker()
                if isOpen then return end
                isOpen = true
                pickerFrame.Visible = true
                
                pickerFrame:ClearAllChildren()
                
                for row, colors in pairs(colorGrid) do
                    for col, color in pairs(colors) do
                        local colorButton = SafeCreate("TextButton", {
                            Text = "",
                            BackgroundColor3 = color,
                            Size = UDim2.new(0, 40, 0, 40),
                            Position = UDim2.new(0, (col-1) * 45 + 15, 0, (row-1) * 45 + 15),
                            AutoButtonColor = false,
                            ZIndex = 1001,
                            Parent = pickerFrame
                        })
                        
                        SafeCreate("UICorner", {
                            CornerRadius = UDim.new(0, 6),
                            Parent = colorButton
                        })
                        
                        SafeCreate("UIStroke", {
                            Color = Color3.fromRGB(255, 255, 255),
                            Thickness = 1,
                            Transparency = 0.5,
                            Parent = colorButton
                        })
                        
                        colorButton.MouseEnter:Connect(function()
                            CreateTween(colorButton.UIStroke, {Transparency = 0}, 0.2)
                        end)
                        
                        colorButton.MouseLeave:Connect(function()
                            CreateTween(colorButton.UIStroke, {Transparency = 0.5}, 0.2)
                        end)
                        
                        colorButton.MouseButton1Click:Connect(function()
                            currentColor = color
                            colorPreview.BackgroundColor3 = color
                            pickerFrame.Visible = false
                            isOpen = false
                            if callback then
                                callback(color)
                            end
                        end)
                    end
                end
            end
            
            colorPreview.MouseButton1Click:Connect(OpenPicker)
            
            return {
                Set = function(self, color)
                    currentColor = color
                    colorPreview.BackgroundColor3 = color
                    if callback then
                        callback(color)
                    end
                    return self
                end,
                Get = function(self)
                    return currentColor
                end
            }
        end
        
        -- Store container widgets reference in section data
        table.insert(sectionData.ContainerWidgets, Nova.containerWidgets)
        
        return containerAPI
    end
    
    -- Direct widget methods (shortcuts)
    function api:Button(text, callback, icon, color)
        local container = api:Container()
        return container and container:Button(text, callback, icon, color)
    end
    
    function api:Toggle(text, default, callback, icon)
        local container = api:Container()
        return container and container:Toggle(text, default, callback, icon)
    end
    
    function api:Slider(text, min, max, default, callback, precision, icon)
        local container = api:Container()
        return container and container:Slider(text, min, max, default, callback, precision, icon)
    end
    
    function api:Dropdown(text, options, default, callback, icon)
        local container = api:Container()
        return container and container:Dropdown(text, options, default, callback, icon)
    end
    
    function api:Textbox(text, placeholder, callback, defaultValue, icon)
        local container = api:Container()
        return container and container:Textbox(text, placeholder, callback, defaultValue, icon)
    end
    
    function api:Label(text, color, size, align)
        local container = api:Container()
        return container and container:Label(text, color, size, align)
    end
    
    function api:Divider(color)
        local container = api:Container()
        return container and container:Divider(color)
    end
    
    function api:ColorPicker(text, defaultColor, callback, icon)
        local container = api:Container()
        return container and container:ColorPicker(text, defaultColor, callback, icon)
    end
    
    return api
end

-- Apply Theme
function Nova:ApplyTheme()
    if not self.CurrentTheme then return end
    
    local theme = self.CurrentTheme
    
    -- Update UI elements
    if self.Background then
        self.Background.BackgroundColor3 = theme.Background
    end
    
    if self.Header then
        self.Header.BackgroundColor3 = theme.Surface
    end
    
    if self.Title then
        self.Title.TextColor3 = theme.Text
    end
    
    if self.Logo then
        self.Logo.TextColor3 = theme.AccentColor
    end
    
    if self.CloseButton then
        self.CloseButton.BackgroundColor3 = theme.Warning
    end
    
    if self.SettingsButton then
        self.SettingsButton.BackgroundColor3 = theme.Surface2
    end
    
    if self.Sidebar then
        self.Sidebar.BackgroundColor3 = theme.Surface2
    end
    
    if self.OpenButton then
        self.OpenButton.BackgroundColor3 = theme.AccentColor
    end
    
    -- Update section buttons
    for _, section in ipairs(self.Sections) do
        if section.Button then
            local textLabel = section.Button:FindFirstChildWhichIsA("TextLabel", true)
            if textLabel then
                if section.Frame == self.ActiveSection then
                    section.Button.BackgroundColor3 = theme.AccentColor
                    textLabel.TextColor3 = Color3.new(1, 1, 1)
                else
                    section.Button.BackgroundColor3 = theme.Surface2
                    textLabel.TextColor3 = theme.SubText
                end
            end
        end
    end
end

-- ESP System (from Library8_1)
function Nova:CreateESP(player, settings)
    if not player or not player.Character then return end
    
    local espFolder = Instance.new("Folder")
    espFolder.Name = "ESP_" .. player.Name
    espFolder.Parent = self.Folder or CoreGui
    
    local character = player.Character
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    local humanoid = character:FindFirstChild("Humanoid")
    
    if not humanoidRootPart or not humanoid then return end
    
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "ESPBillboard"
    billboard.Size = UDim2.new(0, 150, 0, 80)
    billboard.StudsOffset = Vector3.new(0, 3.5, 0)
    billboard.AlwaysOnTop = true
    billboard.MaxDistance = settings.MaxDistance or 500
    billboard.Enabled = true
    billboard.Parent = espFolder
    
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Name = "Name"
    nameLabel.Text = player.Name
    nameLabel.TextColor3 = settings.NameColor or Color3.fromRGB(255, 255, 255)
    nameLabel.Font = Font.GothamMedium
    nameLabel.TextSize = 12
    nameLabel.BackgroundTransparency = 1
    nameLabel.Size = UDim2.new(1, 0, 0, 18)
    nameLabel.Parent = billboard
    
    local distanceLabel = Instance.new("TextLabel")
    distanceLabel.Name = "Distance"
    distanceLabel.Text = "0m"
    distanceLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    distanceLabel.Font = Font.GothamMedium
    distanceLabel.TextSize = 10
    distanceLabel.BackgroundTransparency = 1
    distanceLabel.Size = UDim2.new(1, 0, 0, 14)
    distanceLabel.Parent = billboard
    
    local healthBarBack = Instance.new("Frame")
    healthBarBack.Name = "HealthBarBack"
    healthBarBack.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    healthBarBack.Size = UDim2.new(1, 0, 0, 6)
    healthBarBack.Parent = billboard
    
    local healthBar = Instance.new("Frame")
    healthBar.Name = "HealthBar"
    healthBar.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
    healthBar.Size = UDim2.new(0.5, 0, 1, 0)
    healthBar.Parent = healthBarBack
    
    if settings.BoxESP then
        local boxAdornment = Instance.new("BoxHandleAdornment")
        boxAdornment.Name = "BoxESP"
        boxAdornment.Adornee = humanoidRootPart
        boxAdornment.Size = Vector3.new(4, 6, 2)
        boxAdornment.Color3 = settings.BoxColor or self.CurrentTheme.AccentColor
        boxAdornment.Transparency = 0.6
        boxAdornment.AlwaysOnTop = true
        boxAdornment.ZIndex = 1
        boxAdornment.Parent = espFolder
    end
    
    local espData = {
        Player = player,
        Folder = espFolder,
        LastUpdate = tick(),
        Update = function()
            if not player or not player.Character then return false end
            
            local now = tick()
            if now - espData.LastUpdate < 0.1 then return true end
            espData.LastUpdate = now
            
            local char = player.Character
            local hrp = char:FindFirstChild("HumanoidRootPart")
            local hum = char:FindFirstChild("Humanoid")
            
            if not hrp or not hum then return false end
            
            if Players.LocalPlayer.Character and Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                local distance = (hrp.Position - Players.LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
                distanceLabel.Text = math.floor(distance) .. "m"
                billboard.Enabled = distance <= (settings.MaxDistance or 500)
            end
            
            local healthPercent = hum.Health / hum.MaxHealth
            healthBar.Size = UDim2.new(healthPercent, 0, 1, 0)
            healthBar.BackgroundColor3 = Color3.fromRGB(
                255 * (1 - healthPercent),
                255 * healthPercent,
                0
            )
            
            return true
        end,
        Destroy = function()
            espFolder:Destroy()
        end
    }
    
    self.ESPItems[player] = espData
    return espData
end

-- Cleanup
function Nova:Destroy()
    -- Stop animations
    if self.SnowThread then
        task.cancel(self.SnowThread)
    end
    
    -- Disconnect all connections
    for _, conn in ipairs(self.Connections) do
        if typeof(conn) == "RBXScriptConnection" then
            pcall(conn.Disconnect, conn)
        end
    end
    
    -- Destroy ESP items
    for player, espData in pairs(self.ESPItems) do
        espData:Destroy()
    end
    self.ESPItems = {}
    
    -- Destroy floating texts
    for _, textData in ipairs(self.FloatingTexts) do
        if textData.connection then
            textData.connection:Disconnect()
        end
        if textData.label then
            textData.label:Destroy()
        end
    end
    self.FloatingTexts = {}
    
    -- Destroy all widget instances
    for _, widget in ipairs(self.WidgetInstances) do
        if widget and widget.Destroy then
            pcall(widget.Destroy, widget)
        elseif widget and typeof(widget) == "Instance" then
            pcall(widget.Destroy, widget)
        end
    end
    
    -- Destroy blur effect
    if self.BlurEffect then
        self.BlurEffect:Destroy()
    end
    
    -- Destroy open button
    if self.OpenButton then
        self.OpenButton:Destroy()
    end
    
    -- Destroy settings GUI
    if self.SettingsGUI then
        self.SettingsGUI:Destroy()
    end
    
    -- Destroy screen gui
    if self.ScreenGui then
        pcall(self.ScreenGui.Destroy, self.ScreenGui)
    end
    
    -- Remove from active menus
    for i, menu in ipairs(Nova.ActiveMenus) do
        if menu == self then
            table.remove(Nova.ActiveMenus, i)
            break
        end
    end
    
    -- Clear tables
    table.clear(self.Connections)
    table.clear(self.Sections)
    table.clear(self.WidgetInstances)
    table.clear(self.SnowParticles)
    
    -- Clear self
    setmetatable(self, nil)
    for k in pairs(self) do
        self[k] = nil
    end
    
    print("[Nova UI] Menu destroyed")
end

-- Global cleanup
function Nova.CleanupAll()
    for _, menu in ipairs(Nova.ActiveMenus) do
        if menu and menu.Destroy then
            pcall(menu.Destroy, menu)
        end
    end
    table.clear(Nova.ActiveMenus)
    print("[Nova UI] All menus cleaned up")
end

-- Example usage function
function Nova:ExampleUsage()
    local mainSection = self:Section("Main", "‚≠ê")
    
    -- Player section
    local playerSection = self:Section("Player", "üë§")
    playerSection:Container("Player Settings", "Adjust player properties")
    
    playerSection:Button("Reset Character", function()
        if Players.LocalPlayer.Character then
            Players.LocalPlayer.Character:BreakJoints()
            self:ShowNotification("Character reset!", self.CurrentTheme.Success)
        end
    end, "üîÑ", self.CurrentTheme.Warning)
    
    playerSection:Toggle("Fly", false, function(state)
        self.EnabledFeatures.Fly = state
        self:ShowNotification(state and "Fly enabled!" or "Fly disabled!", 
            state and self.CurrentTheme.Success or self.CurrentTheme.Warning)
    end, "‚úà")
    
    playerSection:Slider("Walk Speed", 16, 100, 16, function(value)
        if Players.LocalPlayer.Character then
            local humanoid = Players.LocalPlayer.Character:FindFirstChild("Humanoid")
            if humanoid then
                humanoid.WalkSpeed = value
            end
        end
    end, 0, "üö∂")
    
    -- Visual section
    local visualSection = self:Section("Visual", "üëÅÔ∏è")
    visualSection:Container("ESP Settings", "Player ESP configuration")
    
    local espToggle = visualSection:Toggle("Enable ESP", false, function(state)
        self.EnabledFeatures.ESP = state
        self:ShowNotification(state and "ESP enabled!" or "ESP disabled!", 
            state and self.CurrentTheme.Success or self.CurrentTheme.Warning)
    end, "üéØ")
    
    visualSection:ColorPicker("ESP Color", self.CurrentTheme.AccentColor, function(color)
        if self.ESPSettings then
            self.ESPSettings.Color = color
        end
    end, "üé®")
    
    visualSection:Slider("Max Distance", 50, 500, 200, function(value)
        if self.ESPSettings then
            self.ESPSettings.MaxDistance = value
        end
    end, 0, "üìè")
    
    -- Misc section
    local miscSection = self:Section("Misc", "‚öô")
    miscSection:Container("Miscellaneous", "Additional features")
    
    miscSection:Dropdown("Theme", {"GoldenNewYear", "ModernElegant", "WinterWonderland"}, "GoldenNewYear", function(option)
        self.Config.Theme = option
        self.CurrentTheme = Nova.Themes[option]
        self:ApplyTheme()
        self:ShowNotification("Theme changed to " .. option, self.CurrentTheme.AccentColor)
    end, "üé®")
    
    miscSection:Button("Show Notification", function()
        self:ShowNotification("This is a test notification!", self.CurrentTheme.Info, 2)
    end, "üîî", self.CurrentTheme.Info)
    
    miscSection:Button("Destroy Menu", function()
        self:Destroy()
    end, "üóëÔ∏è", self.CurrentTheme.Warning)
end

return Nova
