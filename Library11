-- ElegantModMenu.lua (ModuleScript)
local ElegantModMenu = {}
ElegantModMenu.__index = ElegantModMenu

-- Конфигурация
local CONFIG = {
    WINDOW_WIDTH = 350,
    WINDOW_HEIGHT = 450,
    ELEMENT_HEIGHT = 40,
    PADDING = 12,
    CORNER_RADIUS = 10,
    ANIMATION_DURATION = 0.25,
    BLUR_INTENSITY = 12
}

-- Цветовая схема
local COLORS = {
    BACKGROUND = {
        PRIMARY = Color3.fromRGB(20, 20, 30),
        SECONDARY = Color3.fromRGB(30, 30, 40),
        TERTIARY = Color3.fromRGB(40, 40, 55),
        MODAL = Color3.fromRGB(0, 0, 0, 0.7)
    },
    ACCENT = {
        PRIMARY = Color3.fromRGB(0, 150, 255),
        SUCCESS = Color3.fromRGB(0, 200, 100),
        WARNING = Color3.fromRGB(255, 160, 0),
        ERROR = Color3.fromRGB(240, 70, 70)
    },
    TEXT = {
        PRIMARY = Color3.fromRGB(250, 250, 250),
        SECONDARY = Color3.fromRGB(190, 190, 200),
        DISABLED = Color3.fromRGB(120, 120, 130)
    },
    STATES = {
        HOVER = Color3.fromRGB(255, 255, 255, 0.15),
        PRESSED = Color3.fromRGB(255, 255, 255, 0.25)
    }
}

-- Вспомогательные функции
local function tween(object, properties, duration)
    local tweenService = game:GetService("TweenService")
    local tweenInfo = TweenInfo.new(duration or CONFIG.ANIMATION_DURATION, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local tween = tweenService:Create(object, tweenInfo, properties)
    tween:Play()
    return tween
end

local function createRoundedFrame()
    local frame = Instance.new("Frame")
    frame.BackgroundTransparency = 1
    frame.BorderSizePixel = 0
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, CONFIG.CORNER_RADIUS)
    corner.Parent = frame
    
    return frame
end

local function createTextLabel(text, size, parent)
    local label = Instance.new("TextLabel")
    label.Text = text
    label.TextColor3 = COLORS.TEXT.PRIMARY
    label.BackgroundTransparency = 1
    label.Font = Enum.Font.GothamSemibold
    label.TextSize = size
    label.TextXAlignment = Enum.TextXAlignment.Left
    
    if parent then
        label.Parent = parent
    end
    
    return label
end

local function createButton()
    local button = Instance.new("TextButton")
    button.BackgroundTransparency = 1
    button.AutoButtonColor = false
    button.Text = ""
    
    local overlay = Instance.new("Frame")
    overlay.Name = "Overlay"
    overlay.Size = UDim2.new(1, 0, 1, 0)
    overlay.BackgroundTransparency = 1
    overlay.BackgroundColor3 = Color3.new(1, 1, 1)
    overlay.BorderSizePixel = 0
    overlay.Parent = button
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, CONFIG.CORNER_RADIUS)
    corner.Parent = overlay
    
    return button
end

-- Конструктор
function ElegantModMenu.new(options)
    options = options or {}
    
    local self = setmetatable({}, ElegantModMenu)
    
    self.name = options.Name or "Mod Menu"
    self.icon = options.Icon or "⚙️"
    self.accentColor = options.AccentColor or COLORS.ACCENT.PRIMARY
    
    self.sections = {}
    self.elements = {}
    self.currentSection = nil
    
    self:cleanupOldMenus()
    self:createMainWindow()
    
    return self
end

function ElegantModMenu:cleanupOldMenus()
    local coreGui = game:GetService("CoreGui")
    
    for _, child in pairs(coreGui:GetChildren()) do
        if child.Name == "ElegantModMenu" then
            child:Destroy()
        end
    end
end

function ElegantModMenu:createMainWindow()
    -- Основной GUI
    self.screenGui = Instance.new("ScreenGui")
    self.screenGui.Name = "ElegantModMenu"
    self.screenGui.ResetOnSpawn = false
    self.screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    self.screenGui.IgnoreGuiInset = true
    self.screenGui.Parent = game:GetService("CoreGui")
    
    -- Модальный фон с блюром
    self.modalBackground = Instance.new("Frame")
    self.modalBackground.Name = "ModalBackground"
    self.modalBackground.Size = UDim2.new(1, 0, 1, 0)
    self.modalBackground.BackgroundColor3 = COLORS.BACKGROUND.MODAL
    self.modalBackground.BackgroundTransparency = 1
    self.modalBackground.Visible = false
    self.modalBackground.Parent = self.screenGui
    
    local modalButton = Instance.new("TextButton")
    modalButton.Name = "ModalButton"
    modalButton.Size = UDim2.new(1, 0, 1, 0)
    modalButton.BackgroundTransparency = 1
    modalButton.Text = ""
    modalButton.Parent = self.modalBackground
    
    modalButton.MouseButton1Click:Connect(function()
        self:hide()
    end)
    
    -- Основное окно
    self.window = Instance.new("Frame")
    self.window.Name = "Window"
    self.window.Size = UDim2.new(0, CONFIG.WINDOW_WIDTH, 0, 0)
    self.window.Position = UDim2.new(0.5, -CONFIG.WINDOW_WIDTH/2, 0.5, 0)
    self.window.BackgroundColor3 = COLORS.BACKGROUND.PRIMARY
    self.window.ClipsDescendants = true
    self.window.Visible = false
    self.window.Parent = self.screenGui
    
    local windowCorner = Instance.new("UICorner")
    windowCorner.CornerRadius = UDim.new(0, 14)
    windowCorner.Parent = self.window
    
    local windowStroke = Instance.new("UIStroke")
    windowStroke.Color = Color3.fromRGB(50, 50, 65)
    windowStroke.Thickness = 1
    windowStroke.Transparency = 0.3
    windowStroke.Parent = self.window
    
    -- Эффект свечения
    local glow = Instance.new("ImageLabel")
    glow.Name = "Glow"
    glow.Size = UDim2.new(1, 40, 1, 40)
    glow.Position = UDim2.new(0, -20, 0, -20)
    glow.BackgroundTransparency = 1
    glow.Image = "rbxassetid://8992231221"
    glow.ImageColor3 = self.accentColor
    glow.ImageTransparency = 0.9
    glow.ScaleType = Enum.ScaleType.Slice
    glow.SliceCenter = Rect.new(100, 100, 100, 100)
    glow.SliceScale = 0.02
    glow.ZIndex = -1
    glow.Parent = self.window
    
    -- Заголовок
    self.header = Instance.new("Frame")
    self.header.Name = "Header"
    self.header.Size = UDim2.new(1, 0, 0, 55)
    self.header.BackgroundColor3 = COLORS.BACKGROUND.SECONDARY
    self.header.Parent = self.window
    
    local headerCorner = Instance.new("UICorner")
    headerCorner.CornerRadius = UDim.new(0, 14, 0, 0)
    headerCorner.Parent = self.header
    
    local headerGradient = Instance.new("UIGradient")
    headerGradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, self.accentColor),
        ColorSequenceKeypoint.new(0.1, self.accentColor),
        ColorSequenceKeypoint.new(1, COLORS.BACKGROUND.SECONDARY)
    })
    headerGradient.Rotation = 90
    headerGradient.Transparency = NumberSequence.new({
        NumberSequenceKeypoint.new(0, 0.9),
        NumberSequenceKeypoint.new(1, 0.95)
    })
    headerGradient.Parent = self.header
    
    -- Иконка и название
    local titleContainer = Instance.new("Frame")
    titleContainer.Name = "TitleContainer"
    titleContainer.Size = UDim2.new(1, -100, 1, 0)
    titleContainer.Position = UDim2.new(0, 15, 0, 0)
    titleContainer.BackgroundTransparency = 1
    titleContainer.Parent = self.header
    
    self.titleIcon = createTextLabel(self.icon, 22, titleContainer)
    self.titleIcon.Size = UDim2.new(0, 35, 1, 0)
    self.titleIcon.TextXAlignment = Enum.TextXAlignment.Left
    
    self.titleLabel = createTextLabel(self.name, 18, titleContainer)
    self.titleLabel.Size = UDim2.new(1, -40, 1, 0)
    self.titleLabel.Position = UDim2.new(0, 35, 0, 0)
    self.titleLabel.Font = Enum.Font.GothamBold
    self.titleLabel.TextColor3 = COLORS.TEXT.PRIMARY
    
    -- Кнопка закрытия
    self.closeButton = Instance.new("TextButton")
    self.closeButton.Name = "CloseButton"
    self.closeButton.Size = UDim2.new(0, 32, 0, 32)
    self.closeButton.Position = UDim2.new(1, -42, 0.5, -16)
    self.closeButton.BackgroundColor3 = COLORS.ACCENT.ERROR
    self.closeButton.BackgroundTransparency = 0.9
    self.closeButton.Text = "✕"
    self.closeButton.TextColor3 = COLORS.TEXT.PRIMARY
    self.closeButton.TextSize = 18
    self.closeButton.Font = Enum.Font.GothamBold
    self.closeButton.AutoButtonColor = false
    self.closeButton.Parent = self.header
    
    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 8)
    closeCorner.Parent = self.closeButton
    
    local closeStroke = Instance.new("UIStroke")
    closeStroke.Color = COLORS.ACCENT.ERROR
    closeStroke.Thickness = 1
    closeStroke.Transparency = 0.5
    closeStroke.Parent = self.closeButton
    
    self.closeButton.MouseEnter:Connect(function()
        tween(self.closeButton, {BackgroundTransparency = 0.8})
    end)
    
    self.closeButton.MouseLeave:Connect(function()
        tween(self.closeButton, {BackgroundTransparency = 0.9})
    end)
    
    self.closeButton.MouseButton1Click:Connect(function()
        self:hide()
    end)
    
    -- Контент
    self.content = Instance.new("Frame")
    self.content.Name = "Content"
    self.content.Size = UDim2.new(1, -CONFIG.PADDING*2, 1, -75)
    self.content.Position = UDim2.new(0, CONFIG.PADDING, 0, 65)
    self.content.BackgroundTransparency = 1
    self.content.ClipsDescendants = true
    self.content.Parent = self.window
    
    -- Scrolling frame
    self.scrollingFrame = Instance.new("ScrollingFrame")
    self.scrollingFrame.Name = "ScrollingFrame"
    self.scrollingFrame.Size = UDim2.new(1, 0, 1, 0)
    self.scrollingFrame.BackgroundTransparency = 1
    self.scrollingFrame.BorderSizePixel = 0
    self.scrollingFrame.ScrollBarThickness = 4
    self.scrollingFrame.ScrollBarImageColor3 = self.accentColor
    self.scrollingFrame.ScrollBarImageTransparency = 0.8
    self.scrollingFrame.ScrollingDirection = Enum.ScrollingDirection.Y
    self.scrollingFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
    self.scrollingFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
    self.scrollingFrame.Parent = self.content
    
    -- UIListLayout
    self.uiListLayout = Instance.new("UIListLayout")
    self.uiListLayout.Padding = UDim.new(0, CONFIG.PADDING)
    self.uiListLayout.SortOrder = Enum.SortOrder.LayoutOrder
    self.uiListLayout.Parent = self.scrollingFrame
    
    -- Фабричная кнопка
    self:createFabButton()
end

function ElegantModMenu:createFabButton()
    self.fabButton = Instance.new("TextButton")
    self.fabButton.Name = "FabButton"
    self.fabButton.Size = UDim2.new(0, 56, 0, 56)
    self.fabButton.Position = UDim2.new(1, -68, 1, -68)
    self.fabButton.BackgroundColor3 = self.accentColor
    self.fabButton.Text = self.icon
    self.fabButton.TextColor3 = COLORS.TEXT.PRIMARY
    self.fabButton.TextSize = 22
    self.fabButton.Font = Enum.Font.GothamBold
    self.fabButton.AutoButtonColor = false
    self.fabButton.Visible = true
    self.fabButton.Parent = self.screenGui
    
    local fabCorner = Instance.new("UICorner")
    fabCorner.CornerRadius = UDim.new(1, 0)
    fabCorner.Parent = self.fabButton
    
    local fabStroke = Instance.new("UIStroke")
    fabStroke.Color = Color3.fromRGB(255, 255, 255)
    fabStroke.Thickness = 2
    fabStroke.Transparency = 0.2
    fabStroke.Parent = self.fabButton
    
    -- Эффект свечения
    local fabGlow = Instance.new("ImageLabel")
    fabGlow.Name = "FabGlow"
    fabGlow.Size = UDim2.new(1, 20, 1, 20)
    fabGlow.Position = UDim2.new(0, -10, 0, -10)
    fabGlow.BackgroundTransparency = 1
    fabGlow.Image = "rbxassetid://8992231221"
    fabGlow.ImageColor3 = self.accentColor
    fabGlow.ImageTransparency = 0.9
    fabGlow.ScaleType = Enum.ScaleType.Slice
    fabGlow.SliceCenter = Rect.new(100, 100, 100, 100)
    fabGlow.SliceScale = 0.02
    fabGlow.ZIndex = -1
    fabGlow.Parent = self.fabButton
    
    -- Анимации при наведении
    self.fabButton.MouseEnter:Connect(function()
        tween(self.fabButton, {
            Size = UDim2.new(0, 60, 0, 60),
            BackgroundTransparency = 0.2
        })
        tween(fabGlow, {ImageTransparency = 0.7})
    end)
    
    self.fabButton.MouseLeave:Connect(function()
        tween(self.fabButton, {
            Size = UDim2.new(0, 56, 0, 56),
            BackgroundTransparency = 0.3
        })
        tween(fabGlow, {ImageTransparency = 0.9})
    end)
    
    self.fabButton.MouseButton1Click:Connect(function()
        self:show()
    end)
end

-- Основные методы
function ElegantModMenu:show()
    if self.window.Visible then return end
    
    -- Показываем модальный фон
    self.modalBackground.Visible = true
    tween(self.modalBackground, {BackgroundTransparency = 0.3})
    
    -- Показываем и анимируем окно
    self.window.Visible = true
    self.window.Size = UDim2.new(0, CONFIG.WINDOW_WIDTH, 0, 0)
    self.window.Position = UDim2.new(0.5, -CONFIG.WINDOW_WIDTH/2, 0.5, 0)
    
    tween(self.window, {
        Size = UDim2.new(0, CONFIG.WINDOW_WIDTH, 0, CONFIG.WINDOW_HEIGHT),
        Position = UDim2.new(0.5, -CONFIG.WINDOW_WIDTH/2, 0.5, -CONFIG.WINDOW_HEIGHT/2)
    }, 0.35)
    
    -- Прячем FAB
    self.fabButton.Visible = false
end

function ElegantModMenu:hide()
    if not self.window.Visible then return end
    
    -- Анимация скрытия окна
    tween(self.window, {
        Size = UDim2.new(0, CONFIG.WINDOW_WIDTH, 0, 0),
        Position = UDim2.new(0.5, -CONFIG.WINDOW_WIDTH/2, 0.5, 0)
    }, 0.3)
    
    tween(self.modalBackground, {BackgroundTransparency = 1})
    
    task.delay(0.3, function()
        self.window.Visible = false
        self.modalBackground.Visible = false
        self.fabButton.Visible = true
    end)
end

function ElegantModMenu:toggle()
    if self.window.Visible then
        self:hide()
    else
        self:show()
    end
end

-- Секции
function ElegantModMenu:addSection(name)
    local section = {
        name = name,
        elements = {}
    }
    
    table.insert(self.sections, section)
    self.currentSection = section
    
    -- Заголовок секции
    local sectionHeader = Instance.new("Frame")
    sectionHeader.Name = "SectionHeader"
    sectionHeader.Size = UDim2.new(1, 0, 0, 32)
    sectionHeader.BackgroundTransparency = 1
    sectionHeader.LayoutOrder = #self.elements + 1
    sectionHeader.Parent = self.scrollingFrame
    
    local sectionContainer = Instance.new("Frame")
    sectionContainer.Name = "SectionContainer"
    sectionContainer.Size = UDim2.new(1, 0, 1, 0)
    sectionContainer.BackgroundTransparency = 1
    sectionContainer.Parent = sectionHeader
    
    local sectionLabel = createTextLabel(string.upper(name), 12, sectionContainer)
    sectionLabel.Size = UDim2.new(1, -10, 1, 0)
    sectionLabel.Position = UDim2.new(0, 10, 0, 0)
    sectionLabel.TextColor3 = self.accentColor
    sectionLabel.Font = Enum.Font.GothamBold
    sectionLabel.TextXAlignment = Enum.TextXAlignment.Left
    
    local divider = Instance.new("Frame")
    divider.Name = "Divider"
    divider.Size = UDim2.new(0, 0, 0, 1)
    divider.Position = UDim2.new(0, 0, 1, -1)
    divider.BackgroundColor3 = self.accentColor
    divider.BackgroundTransparency = 0.7
    divider.BorderSizePixel = 0
    divider.Parent = sectionContainer
    
    tween(divider, {Size = UDim2.new(1, 0, 0, 1)}, 0.5)
    
    table.insert(self.elements, sectionHeader)
    
    return section
end

-- Кнопка (улучшенный стиль)
function ElegantModMenu:addButton(name, callback, icon)
    local buttonContainer = createRoundedFrame()
    buttonContainer.Name = "ButtonContainer"
    buttonContainer.Size = UDim2.new(1, 0, 0, CONFIG.ELEMENT_HEIGHT)
    buttonContainer.BackgroundColor3 = COLORS.BACKGROUND.SECONDARY
    buttonContainer.BackgroundTransparency = 0.8
    buttonContainer.LayoutOrder = #self.elements + 1
    buttonContainer.Parent = self.scrollingFrame
    
    local buttonStroke = Instance.new("UIStroke")
    buttonStroke.Color = self.accentColor
    buttonStroke.Thickness = 1
    buttonStroke.Transparency = 0.8
    buttonStroke.Parent = buttonContainer
    
    local button = createButton()
    button.Size = UDim2.new(1, 0, 1, 0)
    button.Parent = buttonContainer
    
    -- Контент
    local content = Instance.new("Frame")
    content.Name = "Content"
    content.Size = UDim2.new(1, -20, 1, 0)
    content.Position = UDim2.new(0, 10, 0, 0)
    content.BackgroundTransparency = 1
    content.Parent = buttonContainer
    
    if icon then
        local iconLabel = createTextLabel(icon, 18, content)
        iconLabel.Size = UDim2.new(0, 28, 0, 28)
        iconLabel.Position = UDim2.new(0, 0, 0.5, -14)
        iconLabel.TextXAlignment = Enum.TextXAlignment.Left
    end
    
    local textLabel = createTextLabel(name, 15, content)
    textLabel.Size = UDim2.new(1, icon and -35 or -15, 1, 0)
    textLabel.Position = icon and UDim2.new(0, 35, 0, 0) or UDim2.new(0, 5, 0, 0)
    textLabel.Font = Enum.Font.GothamSemibold
    
    local arrow = Instance.new("ImageLabel")
    arrow.Name = "Arrow"
    arrow.Size = UDim2.new(0, 16, 0, 16)
    arrow.Position = UDim2.new(1, -20, 0.5, -8)
    arrow.BackgroundTransparency = 1
    arrow.Image = "rbxassetid://10884537833"
    arrow.ImageColor3 = COLORS.TEXT.SECONDARY
    arrow.Parent = content
    
    -- Взаимодействие
    local overlay = button:FindFirstChild("Overlay")
    
    button.MouseEnter:Connect(function()
        tween(overlay, {BackgroundTransparency = 0.85})
        tween(arrow, {ImageColor3 = self.accentColor})
        tween(buttonStroke, {Transparency = 0.5})
    end)
    
    button.MouseLeave:Connect(function()
        tween(overlay, {BackgroundTransparency = 1})
        tween(arrow, {ImageColor3 = COLORS.TEXT.SECONDARY})
        tween(buttonStroke, {Transparency = 0.8})
    end)
    
    button.MouseButton1Down:Connect(function()
        tween(overlay, {BackgroundTransparency = 0.7})
    end)
    
    button.MouseButton1Up:Connect(function()
        tween(overlay, {BackgroundTransparency = 0.85})
    end)
    
    button.MouseButton1Click:Connect(function()
        if callback then
            callback()
        end
    end)
    
    table.insert(self.elements, buttonContainer)
    
    return buttonContainer
end

-- Переключатель (улучшенный стиль)
function ElegantModMenu:addToggle(name, defaultState, callback, icon)
    local state = defaultState or false
    
    local toggleContainer = createRoundedFrame()
    toggleContainer.Name = "ToggleContainer"
    toggleContainer.Size = UDim2.new(1, 0, 0, CONFIG.ELEMENT_HEIGHT)
    toggleContainer.BackgroundColor3 = COLORS.BACKGROUND.SECONDARY
    toggleContainer.BackgroundTransparency = 0.8
    toggleContainer.LayoutOrder = #self.elements + 1
    toggleContainer.Parent = self.scrollingFrame
    
    local button = createButton()
    button.Size = UDim2.new(1, 0, 1, 0)
    button.Parent = toggleContainer
    
    -- Контент
    local content = Instance.new("Frame")
    content.Name = "Content"
    content.Size = UDim2.new(1, -20, 1, 0)
    content.Position = UDim2.new(0, 10, 0, 0)
    content.BackgroundTransparency = 1
    content.Parent = toggleContainer
    
    if icon then
        local iconLabel = createTextLabel(icon, 18, content)
        iconLabel.Size = UDim2.new(0, 28, 0, 28)
        iconLabel.Position = UDim2.new(0, 0, 0.5, -14)
        iconLabel.TextXAlignment = Enum.TextXAlignment.Left
    end
    
    local textLabel = createTextLabel(name, 15, content)
    textLabel.Size = UDim2.new(0.7, icon and -35 or -15, 1, 0)
    textLabel.Position = icon and UDim2.new(0, 35, 0, 0) or UDim2.new(0, 5, 0, 0)
    textLabel.Font = Enum.Font.GothamSemibold
    
    -- Тоггл
    local toggleBackground = Instance.new("Frame")
    toggleBackground.Name = "ToggleBackground"
    toggleBackground.Size = UDim2.new(0, 48, 0, 24)
    toggleBackground.Position = UDim2.new(1, -58, 0.5, -12)
    toggleBackground.BackgroundColor3 = state and self.accentColor or COLORS.BACKGROUND.TERTIARY
    toggleBackground.BorderSizePixel = 0
    toggleBackground.Parent = content
    
    local toggleCorner = Instance.new("UICorner")
    toggleCorner.CornerRadius = UDim.new(0, 12)
    toggleCorner.Parent = toggleBackground
    
    local toggleStroke = Instance.new("UIStroke")
    toggleStroke.Color = state and self.accentColor or COLORS.BACKGROUND.TERTIARY
    toggleStroke.Thickness = 1
    toggleStroke.Transparency = 0.5
    toggleStroke.Parent = toggleBackground
    
    local toggleCircle = Instance.new("Frame")
    toggleCircle.Name = "ToggleCircle"
    toggleCircle.Size = UDim2.new(0, 18, 0, 18)
    toggleCircle.Position = state and UDim2.new(1, -20, 0.5, -9) or UDim2.new(0, 2, 0.5, -9)
    toggleCircle.BackgroundColor3 = COLORS.TEXT.PRIMARY
    toggleCircle.BorderSizePixel = 0
    toggleCircle.Parent = toggleBackground
    
    local circleCorner = Instance.new("UICorner")
    circleCorner.CornerRadius = UDim.new(0.5, 0)
    circleCorner.Parent = toggleCircle
    
    -- Функция переключения
    local function setState(newState)
        state = newState
        
        tween(toggleBackground, {
            BackgroundColor3 = state and self.accentColor or COLORS.BACKGROUND.TERTIARY
        })
        
        tween(toggleStroke, {
            Color = state and self.accentColor or COLORS.BACKGROUND.TERTIARY
        })
        
        tween(toggleCircle, {
            Position = state and UDim2.new(1, -20, 0.5, -9) or UDim2.new(0, 2, 0.5, -9)
        })
        
        if callback then
            callback(state)
        end
    end
    
    button.MouseButton1Click:Connect(function()
        setState(not state)
    end)
    
    table.insert(self.elements, toggleContainer)
    
    return {
        setState = function(newState)
            setState(newState)
        end,
        getState = function()
            return state
        end
    }
end

-- Слайдер (ИСПРАВЛЕННЫЙ - полность рабочий!)
function ElegantModMenu:addSlider(name, min, max, defaultValue, callback, icon)
    local value = defaultValue or min
    
    local sliderContainer = createRoundedFrame()
    sliderContainer.Name = "SliderContainer"
    sliderContainer.Size = UDim2.new(1, 0, 0, 65)
    sliderContainer.BackgroundColor3 = COLORS.BACKGROUND.SECONDARY
    sliderContainer.BackgroundTransparency = 0.8
    sliderContainer.LayoutOrder = #self.elements + 1
    sliderContainer.Parent = self.scrollingFrame
    
    -- Заголовок
    local header = Instance.new("Frame")
    header.Name = "Header"
    header.Size = UDim2.new(1, -20, 0, 22)
    header.Position = UDim2.new(0, 10, 0, 5)
    header.BackgroundTransparency = 1
    header.Parent = sliderContainer
    
    if icon then
        local iconLabel = createTextLabel(icon, 16, header)
        iconLabel.Size = UDim2.new(0, 22, 1, 0)
        iconLabel.TextXAlignment = Enum.TextXAlignment.Left
    end
    
    local nameLabel = createTextLabel(name, 14, header)
    nameLabel.Size = UDim2.new(0.6, icon and -27 or -5, 1, 0)
    nameLabel.Position = icon and UDim2.new(0, 27, 0, 0) or UDim2.new(0, 0, 0, 0)
    nameLabel.Font = Enum.Font.GothamSemibold
    
    local valueLabel = createTextLabel(tostring(value), 14, header)
    valueLabel.Size = UDim2.new(0.4, -5, 1, 0)
    valueLabel.Position = UDim2.new(0.6, 5, 0, 0)
    valueLabel.TextXAlignment = Enum.TextXAlignment.Right
    valueLabel.TextColor3 = self.accentColor
    valueLabel.Font = Enum.Font.GothamBold
    
    -- Трек слайдера
    local track = Instance.new("Frame")
    track.Name = "Track"
    track.Size = UDim2.new(1, -20, 0, 8)
    track.Position = UDim2.new(0, 10, 0, 40)
    track.BackgroundColor3 = COLORS.BACKGROUND.TERTIARY
    track.BorderSizePixel = 0
    track.Parent = sliderContainer
    
    local trackCorner = Instance.new("UICorner")
    trackCorner.CornerRadius = UDim.new(0, 4)
    trackCorner.Parent = track
    
    local fill = Instance.new("Frame")
    fill.Name = "Fill"
    fill.Size = UDim2.new(0, 0, 1, 0)
    fill.BackgroundColor3 = self.accentColor
    fill.BorderSizePixel = 0
    fill.Parent = track
    
    local fillCorner = Instance.new("UICorner")
    fillCorner.CornerRadius = UDim.new(0, 4)
    fillCorner.Parent = fill
    
    local thumb = Instance.new("Frame")
    thumb.Name = "Thumb"
    thumb.Size = UDim2.new(0, 22, 0, 22)
    thumb.Position = UDim2.new(0, -11, 0.5, -11)
    thumb.BackgroundColor3 = COLORS.TEXT.PRIMARY
    thumb.BorderSizePixel = 0
    thumb.ZIndex = 2
    thumb.Parent = track
    
    local thumbCorner = Instance.new("UICorner")
    thumbCorner.CornerRadius = UDim.new(0.5, 0)
    thumbCorner.Parent = thumb
    
    local thumbStroke = Instance.new("UIStroke")
    thumbStroke.Color = self.accentColor
    thumbStroke.Thickness = 2
    thumbStroke.Parent = thumb
    
    -- Обновление значения
    local function updateValue(newValue)
        value = math.clamp(newValue, min, max)
        value = math.floor(value * 100) / 100
        
        local percentage = (value - min) / (max - min)
        
        fill.Size = UDim2.new(percentage, 0, 1, 0)
        thumb.Position = UDim2.new(percentage, -11, 0.5, -11)
        valueLabel.Text = string.format("%.1f", value)
        
        if callback then
            callback(value)
        end
    end
    
    -- Взаимодействие (ИСПРАВЛЕНО)
    local dragging = false
    local userInputService = game:GetService("UserInputService")
    local runService = game:GetService("RunService")
    
    -- Функция для обновления позиции при движении мыши
    local function updateFromMouse()
        if dragging then
            local mouse = userInputService:GetMouseLocation()
            local trackAbsolute = track.AbsolutePosition
            local trackSize = track.AbsoluteSize
            
-- Слайдер (ИСПРАВЛЕННЫЙ - правильное управление перетаскиванием)
function ElegantModMenu:addSlider(name, min, max, defaultValue, callback, icon)
    local value = defaultValue or min
    
    local sliderContainer = createRoundedFrame()
    sliderContainer.Name = "SliderContainer"
    sliderContainer.Size = UDim2.new(1, 0, 0, 65)
    sliderContainer.BackgroundColor3 = COLORS.BACKGROUND.SECONDARY
    sliderContainer.BackgroundTransparency = 0.8
    sliderContainer.LayoutOrder = #self.elements + 1
    sliderContainer.Parent = self.scrollingFrame
    
    -- Заголовок
    local header = Instance.new("Frame")
    header.Name = "Header"
    header.Size = UDim2.new(1, -20, 0, 22)
    header.Position = UDim2.new(0, 10, 0, 5)
    header.BackgroundTransparency = 1
    header.Parent = sliderContainer
    
    if icon then
        local iconLabel = createTextLabel(icon, 16, header)
        iconLabel.Size = UDim2.new(0, 22, 1, 0)
        iconLabel.TextXAlignment = Enum.TextXAlignment.Left
    end
    
    local nameLabel = createTextLabel(name, 14, header)
    nameLabel.Size = UDim2.new(0.6, icon and -27 or -5, 1, 0)
    nameLabel.Position = icon and UDim2.new(0, 27, 0, 0) or UDim2.new(0, 0, 0, 0)
    nameLabel.Font = Enum.Font.GothamSemibold
    
    local valueLabel = createTextLabel(tostring(value), 14, header)
    valueLabel.Size = UDim2.new(0.4, -5, 1, 0)
    valueLabel.Position = UDim2.new(0.6, 5, 0, 0)
    valueLabel.TextXAlignment = Enum.TextXAlignment.Right
    valueLabel.TextColor3 = self.accentColor
    valueLabel.Font = Enum.Font.GothamBold
    
    -- Трек слайдера
    local track = Instance.new("Frame")
    track.Name = "Track"
    track.Size = UDim2.new(1, -20, 0, 8)
    track.Position = UDim2.new(0, 10, 0, 40)
    track.BackgroundColor3 = COLORS.BACKGROUND.TERTIARY
    track.BorderSizePixel = 0
    track.Parent = sliderContainer
    
    local trackCorner = Instance.new("UICorner")
    trackCorner.CornerRadius = UDim.new(0, 4)
    trackCorner.Parent = track
    
    local fill = Instance.new("Frame")
    fill.Name = "Fill"
    fill.Size = UDim2.new(0, 0, 1, 0)
    fill.BackgroundColor3 = self.accentColor
    fill.BorderSizePixel = 0
    fill.Parent = track
    
    local fillCorner = Instance.new("UICorner")
    fillCorner.CornerRadius = UDim.new(0, 4)
    fillCorner.Parent = fill
    
    local thumb = Instance.new("Frame")
    thumb.Name = "Thumb"
    thumb.Size = UDim2.new(0, 22, 0, 22)
    thumb.Position = UDim2.new(0, -11, 0.5, -11)
    thumb.BackgroundColor3 = COLORS.TEXT.PRIMARY
    thumb.BorderSizePixel = 0
    thumb.ZIndex = 2
    thumb.Parent = track
    
    local thumbCorner = Instance.new("UICorner")
    thumbCorner.CornerRadius = UDim.new(0.5, 0)
    thumbCorner.Parent = thumb
    
    local thumbStroke = Instance.new("UIStroke")
    thumbStroke.Color = self.accentColor
    thumbStroke.Thickness = 2
    thumbStroke.Parent = thumb
    
    -- Обновление значения
    local function updateValue(newValue)
        value = math.clamp(newValue, min, max)
        value = math.floor(value * 100) / 100
        
        local percentage = (value - min) / (max - min)
        
        fill.Size = UDim2.new(percentage, 0, 1, 0)
        thumb.Position = UDim2.new(percentage, -11, 0.5, -11)
        valueLabel.Text = string.format("%.1f", value)
        
        if callback then
            callback(value)
        end
    end
    
    -- Взаимодействие (ИСПРАВЛЕНО - правильное управление перетаскиванием)
    local dragging = false
    local userInputService = game:GetService("UserInputService")
    local runService = game:GetService("RunService")
    local mouseMoveConnection
    local mouseUpConnection
    
    -- Функция для обновления позиции при движении мыши
    local function updateFromMouse()
        if not dragging then return end
        
        local mouse = userInputService:GetMouseLocation()
        local trackAbsolute = track.AbsolutePosition
        local trackSize = track.AbsoluteSize
        
        local relativeX = (mouse.X - trackAbsolute.X) / trackSize.X
        local newValue = min + (max - min) * math.clamp(relativeX, 0, 1)
        updateValue(newValue)
    end
    
    -- Создаем кнопку для трека
    local trackButton = Instance.new("TextButton")
    trackButton.Size = UDim2.new(1, 0, 1, 0)
    trackButton.BackgroundTransparency = 1
    trackButton.Text = ""
    trackButton.Parent = track
    
    -- Создаем кнопку для ползунка
    local thumbButton = Instance.new("TextButton")
    thumbButton.Size = UDim2.new(1, 0, 1, 0)
    thumbButton.BackgroundTransparency = 1
    thumbButton.Text = ""
    thumbButton.Parent = thumb
    
    -- Обработка клика по треку
    trackButton.MouseButton1Down:Connect(function()
        dragging = true
        
        -- Подписываемся на события мыши
        mouseMoveConnection = userInputService.InputChanged:Connect(function(input)
            if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                updateFromMouse()
            end
        end)
        
        mouseUpConnection = userInputService.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
                -- Отписываемся от событий
                if mouseMoveConnection then
                    mouseMoveConnection:Disconnect()
                    mouseMoveConnection = nil
                end
                if mouseUpConnection then
                    mouseUpConnection:Disconnect()
                    mouseUpConnection = nil
                end
            end
        end)
        
        -- Немедленно обновляем позицию
        local mouse = userInputService:GetMouseLocation()
        local trackAbsolute = track.AbsolutePosition
        local trackSize = track.AbsoluteSize
        
        local relativeX = (mouse.X - trackAbsolute.X) / trackSize.X
        local newValue = min + (max - min) * math.clamp(relativeX, 0, 1)
        updateValue(newValue)
    end)
    
    -- Обработка клика по ползунку
    thumbButton.MouseButton1Down:Connect(function()
        dragging = true
        
        -- Подписываемся на события мыши
        mouseMoveConnection = userInputService.InputChanged:Connect(function(input)
            if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                updateFromMouse()
            end
        end)
        
        mouseUpConnection = userInputService.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
                -- Отписываемся от событий
                if mouseMoveConnection then
                    mouseMoveConnection:Disconnect()
                    mouseMoveConnection = nil
                end
                if mouseUpConnection then
                    mouseUpConnection:Disconnect()
                    mouseUpConnection = nil
                end
            end
        end)
    end)
    
    -- Также добавляем обработку отпускания мыши вне слайдера
    local globalMouseUpConnection
    globalMouseUpConnection = userInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 and dragging then
            dragging = false
            -- Отписываемся от событий
            if mouseMoveConnection then
                mouseMoveConnection:Disconnect()
                mouseMoveConnection = nil
            end
            if mouseUpConnection then
                mouseUpConnection:Disconnect()
                mouseUpConnection = nil
            end
        end
    end)
    
    -- Очищаем соединения при уничтожении слайдера
    sliderContainer.Destroying:Connect(function()
        if mouseMoveConnection then
            mouseMoveConnection:Disconnect()
        end
        if mouseUpConnection then
            mouseUpConnection:Disconnect()
        end
        if globalMouseUpConnection then
            globalMouseUpConnection:Disconnect()
        end
    end)
    
    -- Инициализация
    updateValue(value)
    
    table.insert(self.elements, sliderContainer)
    
    return {
        setValue = function(newValue)
            updateValue(newValue)
        end,
        getValue = function()
            return value
        end
    }
end

-- Текстовое поле (ButtonBox)
function ElegantModMenu:addButtonBox(name, placeholder, defaultText, callback, icon)
    local text = defaultText or ""
    
    local boxContainer = createRoundedFrame()
    boxContainer.Name = "ButtonBoxContainer"
    boxContainer.Size = UDim2.new(1, 0, 0, CONFIG.ELEMENT_HEIGHT)
    boxContainer.BackgroundColor3 = COLORS.BACKGROUND.SECONDARY
    boxContainer.BackgroundTransparency = 0.8
    boxContainer.LayoutOrder = #self.elements + 1
    boxContainer.Parent = self.scrollingFrame
    
    local boxStroke = Instance.new("UIStroke")
    boxStroke.Color = self.accentColor
    boxStroke.Thickness = 1
    boxStroke.Transparency = 0.8
    boxStroke.Parent = boxContainer
    
    local content = Instance.new("Frame")
    content.Name = "Content"
    content.Size = UDim2.new(1, -20, 1, 0)
    content.Position = UDim2.new(0, 10, 0, 0)
    content.BackgroundTransparency = 1
    content.Parent = boxContainer
    
    if icon then
        local iconLabel = createTextLabel(icon, 16, content)
        iconLabel.Size = UDim2.new(0, 24, 0, 24)
        iconLabel.Position = UDim2.new(0, 0, 0.5, -12)
        iconLabel.TextXAlignment = Enum.TextXAlignment.Left
    end
    
    local nameLabel = createTextLabel(name, 14, content)
    nameLabel.Size = UDim2.new(0.35, icon and -30 or -10, 1, 0)
    nameLabel.Position = icon and UDim2.new(0, 30, 0, 0) or UDim2.new(0, 0, 0, 0)
    nameLabel.Font = Enum.Font.GothamSemibold
    
    -- Поле ввода
    local textBox = Instance.new("TextBox")
    textBox.Name = "TextBox"
    textBox.Size = UDim2.new(0.4, -10, 0, 30)
    textBox.Position = UDim2.new(0.35, 10, 0.5, -15)
    textBox.BackgroundColor3 = COLORS.BACKGROUND.TERTIARY
    textBox.BorderSizePixel = 0
    textBox.Text = text
    textBox.PlaceholderText = placeholder or "Введите текст..."
    textBox.TextColor3 = COLORS.TEXT.PRIMARY
    textBox.PlaceholderColor3 = COLORS.TEXT.SECONDARY
    textBox.TextSize = 13
    textBox.Font = Enum.Font.Gotham
    textBox.ClearTextOnFocus = false
    textBox.TextXAlignment = Enum.TextXAlignment.Left
    textBox.Parent = content
    
    local textBoxCorner = Instance.new("UICorner")
    textBoxCorner.CornerRadius = UDim.new(0, 6)
    textBoxCorner.Parent = textBox
    
    local textBoxPadding = Instance.new("UIPadding")
    textBoxPadding.PaddingLeft = UDim.new(0, 10)
    textBoxPadding.PaddingRight = UDim.new(0, 10)
    textBoxPadding.Parent = textBox
    
    local textBoxStroke = Instance.new("UIStroke")
    textBoxStroke.Color = self.accentColor
    textBoxStroke.Thickness = 1
    textBoxStroke.Transparency = 0.5
    textBoxStroke.Parent = textBox
    
    -- Кнопка отправки
    local sendButton = Instance.new("TextButton")
    sendButton.Name = "SendButton"
    sendButton.Size = UDim2.new(0, 60, 0, 30)
    sendButton.Position = UDim2.new(1, -65, 0.5, -15)
    sendButton.BackgroundColor3 = self.accentColor
    sendButton.BackgroundTransparency = 0.7
    sendButton.Text = "SEND"
    sendButton.TextColor3 = COLORS.TEXT.PRIMARY
    sendButton.TextSize = 12
    sendButton.Font = Enum.Font.GothamBold
    sendButton.AutoButtonColor = false
    sendButton.Parent = content
    
    local sendCorner = Instance.new("UICorner")
    sendCorner.CornerRadius = UDim.new(0, 6)
    sendCorner.Parent = sendButton
    
    local sendStroke = Instance.new("UIStroke")
    sendStroke.Color = self.accentColor
    sendStroke.Thickness = 1
    sendStroke.Parent = sendButton
    
    -- Взаимодействие
    sendButton.MouseEnter:Connect(function()
        tween(sendButton, {BackgroundTransparency = 0.5})
    end)
    
    sendButton.MouseLeave:Connect(function()
        tween(sendButton, {BackgroundTransparency = 0.7})
    end)
    
    sendButton.MouseButton1Click:Connect(function()
        local inputText = textBox.Text
        if inputText ~= "" and callback then
            callback(inputText)
            textBox.Text = ""
        end
    end)
    
    textBox.FocusLost:Connect(function(enterPressed)
        if enterPressed and textBox.Text ~= "" and callback then
            callback(textBox.Text)
            textBox.Text = ""
        end
    end)
    
    table.insert(self.elements, boxContainer)
    
    return {
        setText = function(newText)
            text = newText
            textBox.Text = newText
        end,
        getText = function()
            return textBox.Text
        end
    }
end

-- ToggleBox (числовой ввод)
function ElegantModMenu:addToggleBox(name, placeholder, defaultValue, callback, icon)
    local value = defaultValue or 0
    
    local boxContainer = createRoundedFrame()
    boxContainer.Name = "ToggleBoxContainer"
    boxContainer.Size = UDim2.new(1, 0, 0, CONFIG.ELEMENT_HEIGHT)
    boxContainer.BackgroundColor3 = COLORS.BACKGROUND.SECONDARY
    boxContainer.BackgroundTransparency = 0.8
    boxContainer.LayoutOrder = #self.elements + 1
    boxContainer.Parent = self.scrollingFrame
    
    local boxStroke = Instance.new("UIStroke")
    boxStroke.Color = self.accentColor
    boxStroke.Thickness = 1
    boxStroke.Transparency = 0.8
    boxStroke.Parent = boxContainer
    
    local content = Instance.new("Frame")
    content.Name = "Content"
    content.Size = UDim2.new(1, -20, 1, 0)
    content.Position = UDim2.new(0, 10, 0, 0)
    content.BackgroundTransparency = 1
    content.Parent = boxContainer
    
    if icon then
        local iconLabel = createTextLabel(icon, 16, content)
        iconLabel.Size = UDim2.new(0, 24, 0, 24)
        iconLabel.Position = UDim2.new(0, 0, 0.5, -12)
        iconLabel.TextXAlignment = Enum.TextXAlignment.Left
    end
    
    local nameLabel = createTextLabel(name, 14, content)
    nameLabel.Size = UDim2.new(0.3, icon and -30 or -10, 1, 0)
    nameLabel.Position = icon and UDim2.new(0, 30, 0, 0) or UDim2.new(0, 0, 0, 0)
    nameLabel.Font = Enum.Font.GothamSemibold
    
    -- Кнопки управления
    local minusButton = Instance.new("TextButton")
    minusButton.Name = "MinusButton"
    minusButton.Size = UDim2.new(0, 32, 0, 32)
    minusButton.Position = UDim2.new(0.3, 10, 0.5, -16)
    minusButton.BackgroundColor3 = self.accentColor
    minusButton.BackgroundTransparency = 0.7
    minusButton.Text = "−"
    minusButton.TextColor3 = COLORS.TEXT.PRIMARY
    minusButton.TextSize = 18
    minusButton.Font = Enum.Font.GothamBold
    minusButton.AutoButtonColor = false
    minusButton.Parent = content
    
    local minusCorner = Instance.new("UICorner")
    minusCorner.CornerRadius = UDim.new(0, 6)
    minusCorner.Parent = minusButton
    
    local minusStroke = Instance.new("UIStroke")
    minusStroke.Color = self.accentColor
    minusStroke.Thickness = 1
    minusStroke.Parent = minusButton
    
    -- Поле ввода чисел
    local numberBox = Instance.new("TextBox")
    numberBox.Name = "NumberBox"
    numberBox.Size = UDim2.new(0, 70, 0, 32)
    numberBox.Position = UDim2.new(0.3, 47, 0.5, -16)
    numberBox.BackgroundColor3 = COLORS.BACKGROUND.TERTIARY
    numberBox.BorderSizePixel = 0
    numberBox.Text = tostring(value)
    numberBox.PlaceholderText = placeholder or "0"
    numberBox.TextColor3 = COLORS.TEXT.PRIMARY
    numberBox.PlaceholderColor3 = COLORS.TEXT.SECONDARY
    numberBox.TextSize = 14
    numberBox.Font = Enum.Font.GothamSemibold
    numberBox.ClearTextOnFocus = false
    numberBox.TextXAlignment = Enum.TextXAlignment.Center
    numberBox.Parent = content
    
    local numberCorner = Instance.new("UICorner")
    numberCorner.CornerRadius = UDim.new(0, 6)
    numberCorner.Parent = numberBox
    
    local numberStroke = Instance.new("UIStroke")
    numberStroke.Color = self.accentColor
    numberStroke.Thickness = 1
    numberStroke.Transparency = 0.5
    numberStroke.Parent = numberBox
    
    local plusButton = Instance.new("TextButton")
    plusButton.Name = "PlusButton"
    plusButton.Size = UDim2.new(0, 32, 0, 32)
    plusButton.Position = UDim2.new(0.3, 122, 0.5, -16)
    plusButton.BackgroundColor3 = self.accentColor
    plusButton.BackgroundTransparency = 0.7
    plusButton.Text = "+"
    plusButton.TextColor3 = COLORS.TEXT.PRIMARY
    plusButton.TextSize = 18
    plusButton.Font = Enum.Font.GothamBold
    plusButton.AutoButtonColor = false
    plusButton.Parent = content
    
    local plusCorner = Instance.new("UICorner")
    plusCorner.CornerRadius = UDim.new(0, 6)
    plusCorner.Parent = plusButton
    
    local plusStroke = Instance.new("UIStroke")
    plusStroke.Color = self.accentColor
    plusStroke.Thickness = 1
    plusStroke.Parent = plusButton
    
    -- Кнопка применения
    local applyButton = Instance.new("TextButton")
    applyButton.Name = "ApplyButton"
    applyButton.Size = UDim2.new(0, 60, 0, 32)
    applyButton.Position = UDim2.new(1, -65, 0.5, -16)
    applyButton.BackgroundColor3 = self.accentColor
    applyButton.BackgroundTransparency = 0.7
    applyButton.Text = "APPLY"
    applyButton.TextColor3 = COLORS.TEXT.PRIMARY
    applyButton.TextSize = 12
    applyButton.Font = Enum.Font.GothamBold
    applyButton.AutoButtonColor = false
    applyButton.Parent = content
    
    local applyCorner = Instance.new("UICorner")
    applyCorner.CornerRadius = UDim.new(0, 6)
    applyCorner.Parent = applyButton
    
    local applyStroke = Instance.new("UIStroke")
    applyStroke.Color = self.accentColor
    applyStroke.Thickness = 1
    applyStroke.Parent = applyButton
    
    -- Взаимодействие с кнопками
    local function updateValue(newValue)
        value = newValue
        numberBox.Text = tostring(math.floor(value))
        if callback then
            callback(value)
        end
    end
    
    local function buttonHover(button)
        button.MouseEnter:Connect(function()
            tween(button, {BackgroundTransparency = 0.5})
        end)
        
        button.MouseLeave:Connect(function()
            tween(button, {BackgroundTransparency = 0.7})
        end)
    end
    
    buttonHover(minusButton)
    buttonHover(plusButton)
    buttonHover(applyButton)
    
    minusButton.MouseButton1Click:Connect(function()
        updateValue(value - 1)
    end)
    
    plusButton.MouseButton1Click:Connect(function()
        updateValue(value + 1)
    end)
    
    applyButton.MouseButton1Click:Connect(function()
        local num = tonumber(numberBox.Text)
        if num then
            updateValue(num)
        end
    end)
    
    numberBox.FocusLost:Connect(function(enterPressed)
        if enterPressed then
            local num = tonumber(numberBox.Text)
            if num then
                updateValue(num)
            else
                numberBox.Text = tostring(value)
            end
        end
    end)
    
    table.insert(self.elements, boxContainer)
    
    return {
        setValue = function(newValue)
            updateValue(newValue)
        end,
        getValue = function()
            return value
        end
    }
end

-- Выпадающий список (ИСПРАВЛЕННЫЙ - с ScrollingFrame и правильным ZIndex)
function ElegantModMenu:addDropdown(name, options, defaultIndex, callback, icon)
    local selectedIndex = defaultIndex or 1
    local isOpen = false
    
    local dropdownContainer = createRoundedFrame()
    dropdownContainer.Name = "DropdownContainer"
    dropdownContainer.Size = UDim2.new(1, 0, 0, CONFIG.ELEMENT_HEIGHT)
    dropdownContainer.BackgroundColor3 = COLORS.BACKGROUND.SECONDARY
    dropdownContainer.BackgroundTransparency = 0.8
    dropdownContainer.LayoutOrder = #self.elements + 1
    dropdownContainer.ClipsDescendants = false
    dropdownContainer.ZIndex = 5
    dropdownContainer.Parent = self.scrollingFrame
    
    local dropdownStroke = Instance.new("UIStroke")
    dropdownStroke.Color = self.accentColor
    dropdownStroke.Thickness = 1
    dropdownStroke.Transparency = 0.8
    dropdownStroke.Parent = dropdownContainer
    
    local button = createButton()
    button.Name = "DropdownButton"
    button.Size = UDim2.new(1, 0, 0, CONFIG.ELEMENT_HEIGHT)
    button.ZIndex = 6
    button.Parent = dropdownContainer
    
    -- Контент
    local content = Instance.new("Frame")
    content.Name = "Content"
    content.Size = UDim2.new(1, -20, 1, 0)
    content.Position = UDim2.new(0, 10, 0, 0)
    content.BackgroundTransparency = 1
    content.ZIndex = 7
    content.Parent = dropdownContainer
    
    if icon then
        local iconLabel = createTextLabel(icon, 16, content)
        iconLabel.Size = UDim2.new(0, 24, 0, 24)
        iconLabel.Position = UDim2.new(0, 0, 0.5, -12)
        iconLabel.TextXAlignment = Enum.TextXAlignment.Left
        iconLabel.ZIndex = 8
    end
    
    local nameLabel = createTextLabel(name, 14, content)
    nameLabel.Size = UDim2.new(0.5, icon and -30 or -10, 1, 0)
    nameLabel.Position = icon and UDim2.new(0, 30, 0, 0) or UDim2.new(0, 0, 0, 0)
    nameLabel.Font = Enum.Font.GothamSemibold
    nameLabel.ZIndex = 8
    
    local selectedLabel = createTextLabel(options[selectedIndex] or "Select...", 13, content)
    selectedLabel.Size = UDim2.new(0.3, -10, 1, 0)
    selectedLabel.Position = UDim2.new(0.5, 10, 0, 0)
    selectedLabel.TextXAlignment = Enum.TextXAlignment.Right
    selectedLabel.TextColor3 = self.accentColor
    selectedLabel.Font = Enum.Font.GothamMedium
    selectedLabel.ZIndex = 8
    
    local arrow = Instance.new("ImageLabel")
    arrow.Name = "Arrow"
    arrow.Size = UDim2.new(0, 16, 0, 16)
    arrow.Position = UDim2.new(1, -20, 0.5, -8)
    arrow.BackgroundTransparency = 1
    arrow.Image = "rbxassetid://10884537837"
    arrow.ImageColor3 = COLORS.TEXT.SECONDARY
    arrow.Rotation = isOpen and 180 or 0
    arrow.ZIndex = 8
    arrow.Parent = content
    
    -- Контейнер для опций (снаружи, чтобы был поверх всех элементов)
    local optionsOuterContainer = Instance.new("Frame")
    optionsOuterContainer.Name = "OptionsOuterContainer"
    optionsOuterContainer.Size = UDim2.new(1, 0, 0, 0)
    optionsOuterContainer.Position = UDim2.new(0, 0, 1, 5)
    optionsOuterContainer.BackgroundTransparency = 1
    optionsOuterContainer.Visible = false
    optionsOuterContainer.ClipsDescendants = true
    optionsOuterContainer.ZIndex = 50
    optionsOuterContainer.Parent = dropdownContainer
    
    -- ScrollingFrame для опций
    local optionsScrolling = Instance.new("ScrollingFrame")
    optionsScrolling.Name = "OptionsScrolling"
    optionsScrolling.Size = UDim2.new(1, 0, 0, 0)
    optionsScrolling.Position = UDim2.new(0, 0, 0, 0)
    optionsScrolling.BackgroundColor3 = COLORS.BACKGROUND.PRIMARY
    optionsScrolling.BackgroundTransparency = 0
    optionsScrolling.BorderSizePixel = 0
    optionsScrolling.ScrollBarThickness = 4
    optionsScrolling.ScrollBarImageColor3 = self.accentColor
    optionsScrolling.ScrollBarImageTransparency = 0.7
    optionsScrolling.ScrollingDirection = Enum.ScrollingDirection.Y
    optionsScrolling.AutomaticCanvasSize = Enum.AutomaticSize.Y
    optionsScrolling.CanvasSize = UDim2.new(0, 0, 0, 0)
    optionsScrolling.ZIndex = 51
    optionsScrolling.Parent = optionsOuterContainer
    
    local optionsCorner = Instance.new("UICorner")
    optionsCorner.CornerRadius = UDim.new(0, CONFIG.CORNER_RADIUS)
    optionsCorner.Parent = optionsScrolling
    
    local optionsStroke = Instance.new("UIStroke")
    optionsStroke.Color = self.accentColor
    optionsStroke.Thickness = 1
    optionsStroke.Transparency = 0.5
    optionsStroke.ZIndex = 51
    optionsStroke.Parent = optionsScrolling
    
    local optionsList = Instance.new("UIListLayout")
    optionsList.Padding = UDim.new(0, 1)
    optionsList.SortOrder = Enum.SortOrder.LayoutOrder
    optionsList.Parent = optionsScrolling
    
    -- Создание опций
    local optionButtons = {}
    for i, option in ipairs(options) do
        local optionButton = createButton()
        optionButton.Name = "OptionButton"
        optionButton.Size = UDim2.new(1, -10, 0, 30)
        optionButton.Position = UDim2.new(0, 5, 0, (i-1)*31)
        optionButton.BackgroundColor3 = i == selectedIndex and self.accentColor or COLORS.BACKGROUND.SECONDARY
        optionButton.BackgroundTransparency = i == selectedIndex and 0.8 or 0.9
        optionButton.LayoutOrder = i
        optionButton.ZIndex = 52
        optionButton.Parent = optionsScrolling
        
        local optionCorner = Instance.new("UICorner")
        optionCorner.CornerRadius = UDim.new(0, 6)
        optionCorner.Parent = optionButton
        
        local optionLabel = createTextLabel(option, 13, optionButton)
        optionLabel.Size = UDim2.new(1, -10, 1, 0)
        optionLabel.Position = UDim2.new(0, 10, 0, 0)
        optionLabel.TextColor3 = i == selectedIndex and COLORS.TEXT.PRIMARY or COLORS.TEXT.SECONDARY
        optionLabel.ZIndex = 53
        
        table.insert(optionButtons, optionButton)
        
        optionButton.MouseButton1Click:Connect(function()
            selectedIndex = i
            selectedLabel.Text = option
            isOpen = false
            
            -- Обновляем стиль всех кнопок
            for btnIndex, btn in ipairs(optionButtons) do
                btn.BackgroundColor3 = btnIndex == i and self.accentColor or COLORS.BACKGROUND.SECONDARY
                btn.BackgroundTransparency = btnIndex == i and 0.8 or 0.9
                btn:FindFirstChildOfClass("TextLabel").TextColor3 = btnIndex == i and COLORS.TEXT.PRIMARY or COLORS.TEXT.SECONDARY
            end
            
            -- Анимация закрытия
            tween(optionsOuterContainer, {Size = UDim2.new(1, 0, 0, 0)})
            tween(optionsScrolling, {Size = UDim2.new(1, 0, 0, 0)})
            tween(arrow, {Rotation = 0})
            
            task.delay(0.2, function()
                optionsOuterContainer.Visible = false
            end)
            
            if callback then
                callback(option, i)
            end
        end)
    end
    
    -- Переключение видимости
    button.MouseButton1Click:Connect(function()
        isOpen = not isOpen
        
        if isOpen then
            optionsOuterContainer.Visible = true
            local maxHeight = 150  -- Максимальная высота списка
            local itemHeight = 31
            local optionsHeight = math.min(#options * itemHeight, maxHeight)
            
            tween(optionsOuterContainer, {Size = UDim2.new(1, 0, 0, optionsHeight)})
            tween(optionsScrolling, {Size = UDim2.new(1, 0, 0, optionsHeight)})
            tween(arrow, {Rotation = 180})
        else
            tween(optionsOuterContainer, {Size = UDim2.new(1, 0, 0, 0)})
            tween(optionsScrolling, {Size = UDim2.new(1, 0, 0, 0)})
            tween(arrow, {Rotation = 0})
            
            task.delay(0.2, function()
                optionsOuterContainer.Visible = false
            end)
        end
    end)
    
    table.insert(self.elements, dropdownContainer)
    
    return {
        setSelected = function(index)
            if options[index] then
                selectedIndex = index
                selectedLabel.Text = options[index]
                
                for btnIndex, btn in ipairs(optionButtons) do
                    btn.BackgroundColor3 = btnIndex == index and self.accentColor or COLORS.BACKGROUND.SECONDARY
                    btn.BackgroundTransparency = btnIndex == index and 0.8 or 0.9
                    btn:FindFirstChildOfClass("TextLabel").TextColor3 = btnIndex == index and COLORS.TEXT.PRIMARY or COLORS.TEXT.SECONDARY
                end
                
                if callback then
                    callback(options[index], index)
                end
            end
        end,
        getSelected = function()
            return selectedIndex, options[selectedIndex]
        end
    }
end

-- Выбор цвета
function ElegantModMenu:addColorPicker(name, defaultColor, callback, icon)
    local currentColor = defaultColor or self.accentColor
    
    local colorContainer = createRoundedFrame()
    colorContainer.Name = "ColorPickerContainer"
    colorContainer.Size = UDim2.new(1, 0, 0, CONFIG.ELEMENT_HEIGHT)
    colorContainer.BackgroundColor3 = COLORS.BACKGROUND.SECONDARY
    colorContainer.BackgroundTransparency = 0.8
    colorContainer.LayoutOrder = #self.elements + 1
    colorContainer.Parent = self.scrollingFrame
    
    local button = createButton()
    button.Name = "ColorPickerButton"
    button.Size = UDim2.new(1, 0, 1, 0)
    button.Parent = colorContainer
    
    -- Контент
    local content = Instance.new("Frame")
    content.Name = "Content"
    content.Size = UDim2.new(1, -20, 1, 0)
    content.Position = UDim2.new(0, 10, 0, 0)
    content.BackgroundTransparency = 1
    content.Parent = colorContainer
    
    if icon then
        local iconLabel = createTextLabel(icon, 16, content)
        iconLabel.Size = UDim2.new(0, 24, 0, 24)
        iconLabel.Position = UDim2.new(0, 0, 0.5, -12)
        iconLabel.TextXAlignment = Enum.TextXAlignment.Left
    end
    
    local nameLabel = createTextLabel(name, 14, content)
    nameLabel.Size = UDim2.new(0.7, icon and -30 or -10, 1, 0)
    nameLabel.Position = icon and UDim2.new(0, 30, 0, 0) or UDim2.new(0, 0, 0, 0)
    nameLabel.Font = Enum.Font.GothamSemibold
    
    local preview = Instance.new("Frame")
    preview.Name = "ColorPreview"
    preview.Size = UDim2.new(0, 32, 0, 32)
    preview.Position = UDim2.new(1, -42, 0.5, -16)
    preview.BackgroundColor3 = currentColor
    preview.BorderSizePixel = 0
    preview.Parent = content
    
    local previewCorner = Instance.new("UICorner")
    previewCorner.CornerRadius = UDim.new(0, 8)
    previewCorner.Parent = preview
    
    local previewStroke = Instance.new("UIStroke")
    previewStroke.Color = Color3.new(1, 1, 1)
    previewStroke.Thickness = 2
    previewStroke.Transparency = 0.2
    previewStroke.Parent = preview
    
    table.insert(self.elements, colorContainer)
    
    return {
        setColor = function(color)
            currentColor = color
            preview.BackgroundColor3 = color
            if callback then
                callback(color)
            end
        end,
        getColor = function()
            return currentColor
        end
    }
end

-- Вспомогательные методы
function ElegantModMenu:addPlayerSelector(name, callback, icon)
    local players = {}
    for _, player in ipairs(game:GetService("Players"):GetPlayers()) do
        if player ~= game.Players.LocalPlayer then
            table.insert(players, player.Name)
        end
    end
    
    return self:addDropdown(name, players, 1, function(selected)
        if callback then
            callback(selected)
        end
    end, icon or "👤")
end

function ElegantModMenu:addItemSelector(name, items, callback, icon)
    return self:addDropdown(name, items, 1, function(selected)
        if callback then
            callback(selected)
        end
    end, icon or "📦")
end

-- Публичные методы
function ElegantModMenu:destroy()
    if self.screenGui then
        self.screenGui:Destroy()
    end
end

function ElegantModMenu:setVisible(visible)
    if visible then
        self:show()
    else
        self:hide()
    end
end

-- Экспорт
return ElegantModMenu
