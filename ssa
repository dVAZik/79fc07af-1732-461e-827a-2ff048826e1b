
--[[
    Advanced Debug Tool v1.0 - Fixed Version
    Mobile-optimized interface with enhanced stealth features
]]

if getgenv().AdvancedDebugExecuted and type(getgenv().AdvancedDebugShutdown) == "function" then
    getgenv().AdvancedDebugShutdown()
end

-- Случайные имена для маскировки
local randomNames = {
    "SystemAnalytics",
    "PerformanceMonitor", 
    "DebugOverlay",
    "EventTracker",
    "NetworkMonitor",
    "ScriptProfiler",
    "DataLogger"
}

local randomName = randomNames[math.random(1, #randomNames)]

-- Конфигурация с рандомизацией
local realconfigs = {
    logcheckcaller = false,
    autoblock = false,
    funcEnabled = true,
    advancedinfo = false,
    stealthMode = true,
    mobileOptimized = true,
    autoHide = true,
    hideDelay = 20,
    transparentUI = 0.7
}

-- Вместо newproxy, используем простую таблицу
local configs = setmetatable({}, {
    __index = function(self, index)
        return realconfigs[index]
    end,
    __newindex = function(self, index, value)
        realconfigs[index] = value
    end
})

-- Обёртки для сервисов
local oth = syn and syn.oth
local unhook = oth and oth.unhook
local hook = oth and oth.hook

local lower = string.lower
local byte = string.byte
local round = math.round
local running = coroutine.running
local resume = coroutine.resume
local status = coroutine.status
local yield = coroutine.yield
local create = coroutine.create
local close = coroutine.close
local OldDebugId = game.GetDebugId
local info = debug.info

local IsA = game.IsA
local tostring = tostring
local tonumber = tonumber
local delay = task.delay
local spawn = task.spawn
local clear = table.clear
local clone = table.clone
local find = table.find
local insert = table.insert
local remove = table.remove

-- Исправленные функции
local function blankfunction(...)
    return ...
end

local get_thread_identity = (syn and syn.get_thread_identity) or getidentity or getthreadidentity or blankfunction
local set_thread_identity = (syn and syn.set_thread_identity) or setidentity or blankfunction
local islclosure = islclosure or function() return false end

local getinfo = getinfo or blankfunction
local getupvalues = getupvalues or debug.getupvalues or blankfunction
local getconstants = getconstants or debug.getconstants or blankfunction

local getcustomasset = getsynasset or getcustomasset or blankfunction
local getcallingscript = getcallingscript or blankfunction
local newcclosure = newcclosure or blankfunction
local clonefunction = clonefunction or blankfunction
local cloneref = cloneref or blankfunction
local request = request or (syn and syn.request) or blankfunction

-- Исправленные функции записи/чтения
local makewritable = makewriteable or function(tbl)
    if setreadonly then
        setreadonly(tbl, false)
    end
end

local makereadonly = makereadonly or function(tbl)
    if setreadonly then
        setreadonly(tbl, true)
    end
end

local isreadonly = isreadonly or table.isfrozen or function() return false end

local setclipboard = setclipboard or toclipboard or set_clipboard or (Clipboard and Clipboard.set) or function(text)
    warn("Attempted to set clipboard: " .. tostring(text))
end

-- Исправленный hookmetamethod
local hookmetamethod = hookmetamethod or function(obj, metamethod, func)
    if hookfunction and getrawmetatable then
        local old = getrawmetatable(obj)
        if old and old[metamethod] then
            return hookfunction(old[metamethod], func)
        end
    end
    return nil
end

local function Create(instance, properties, children)
    local obj = Instance.new(instance)

    for i, v in next, properties or {} do
        obj[i] = v
    end
    
    if children then
        for _, child in next, children do
            if child then
                child.Parent = obj
            end
        end
    end
    return obj
end

local function SafeGetService(service)
    return game:GetService(service)
end

local function IsCyclicTable(tbl)
    local checkedtables = {}
    
    local function SearchTable(current)
        if find(checkedtables, current) then
            return true
        end
        
        insert(checkedtables, current)
        
        for i, v in next, current do
            if type(v) == "table" and SearchTable(v) then
                return true
            end
        end
        
        return false
    end
    
    return SearchTable(tbl)
end

local function deepclone(args, copies)
    local copy = nil
    copies = copies or {}

    if type(args) == 'table' then
        if copies[args] then
            copy = copies[args]
        else
            copy = {}
            copies[args] = copy
            for i, v in next, args do
                copy[deepclone(i, copies)] = deepclone(v, copies)
            end
        end
    elseif typeof(args) == "Instance" then
        copy = args
    else
        copy = args
    end
    return copy
end

local function rawtostring(userdata)
    return tostring(userdata)
end

local CoreGui = SafeGetService("CoreGui")
local Players = SafeGetService("Players")
local RunService = SafeGetService("RunService")
local UserInputService = SafeGetService("UserInputService")
local TweenService = SafeGetService("TweenService")
local ContentProvider = SafeGetService("ContentProvider")
local TextService = SafeGetService("TextService")
local http = SafeGetService("HttpService")
local GuiService = SafeGetService("GuiService")
local GuiInset = GuiService:GetGuiInset()

local function jsone(str) 
    return http:JSONEncode(str) 
end

local function jsond(str)
    local suc, err = pcall(function()
        return http:JSONDecode(str)
    end)
    return suc and err or nil
end

-- Исправленная функция ErrorPrompt
function ErrorPrompt(Message, state)
    if getrenv and CoreGui then
        local suc, result = pcall(function()
            local RobloxGui = CoreGui:WaitForChild("RobloxGui", 1)
            if RobloxGui then
                local Modules = RobloxGui:WaitForChild("Modules", 1)
                if Modules then
                    local ErrorPromptModule = Modules:WaitForChild("ErrorPrompt", 1)
                    if ErrorPromptModule then
                        local ErrorPrompt = getrenv().require(ErrorPromptModule)
                        local prompt = ErrorPrompt.new("Default",{HideErrorCode = true})
                        local ErrorStorage = Create("ScreenGui",{Parent = CoreGui,ResetOnSpawn = false})
                        local thread = state and running()
                        prompt:setParent(ErrorStorage)
                        prompt:setErrorTitle("System Error")
                        prompt:updateButtons({{
                            Text = "OK",
                            Callback = function()
                                prompt:_close()
                                ErrorStorage:Destroy()
                                if thread then
                                    resume(thread)
                                end
                            end,
                            Primary = true
                        }}, 'Default')
                        prompt:_open(Message)
                        if thread then
                            yield()
                        end
                        return true
                    end
                end
            end
        end)
        if not suc then
            warn(Message)
        end
    else
        warn(Message)
    end
end

-- Загружаем Highlight с обработкой ошибок
local Highlight
local highlightLoaded = pcall(function()
    Highlight = loadstring(game:HttpGet("https://raw.githubusercontent.com/78n/SimpleSpy/main/Highlight.lua", true))()
end)

if not Highlight and highlightLoaded then
    warn("Failed to load Highlight module")
    Highlight = {
        new = function(parent)
            return {
                setRaw = function(self, text)
                    local label = Create("TextLabel", {
                        Parent = parent,
                        BackgroundTransparency = 1,
                        Size = UDim2.new(1, 0, 1, 0),
                        Font = Enum.Font.Code,
                        Text = tostring(text),
                        TextColor3 = Color3.fromRGB(255, 255, 255),
                        TextSize = 12,
                        TextXAlignment = Enum.TextXAlignment.Left,
                        TextYAlignment = Enum.TextYAlignment.Top,
                        TextWrapped = true
                    })
                end,
                getString = function(self)
                    return ""
                end
            }
        end
    }
end

-- Загружаем LazyFix с обработкой ошибок
local LazyFix
local lazyFixLoaded = pcall(function()
    LazyFix = loadstring(game:HttpGet("https://raw.githubusercontent.com/78n/Roblox/main/Lua/Libraries/DataToCode/DataToCode.luau", true))()
end)

if not LazyFix and lazyFixLoaded then
    warn("Failed to load LazyFix module")
    LazyFix = {
        Convert = function(args, pretty)
            return "-- Data conversion failed\nlocal args = {}"
        end
    }
end

-- Создаем основной интерфейс
local DebugGUI = Create("ScreenGui",{
    Name = randomName,
    ResetOnSpawn = false,
    ZIndexBehavior = Enum.ZIndexBehavior.Sibling,
    DisplayOrder = 999
})

local Storage = Create("Folder",{Parent = DebugGUI, Name = "DebugStorage"})

-- Мобильная адаптация
local isMobile = UserInputService.TouchEnabled
local baseSize = isMobile and 0.9 or 1
local fontSize = isMobile and 12 or 14
local buttonHeight = isMobile and 35 or 27
local padding = isMobile and 10 or 5

local MainContainer = Create("Frame",{
    Parent = DebugGUI,
    Name = "MainContainer",
    BackgroundColor3 = Color3.fromRGB(30, 30, 35),
    BackgroundTransparency = realconfigs.transparentUI,
    BorderColor3 = Color3.fromRGB(60, 60, 70),
    BorderSizePixel = 1,
    Position = UDim2.new(0.5, -225, 0.5, -134),
    Size = UDim2.new(0, 450 * baseSize, 0, 268 * baseSize),
    ClipsDescendants = true
})

-- Добавляем скругленные углы
local MainCorner = Create("UICorner", {
    Parent = MainContainer,
    CornerRadius = UDim.new(0, 6)
})

-- Тень для глубины
local Shadow = Create("Frame",{
    Parent = MainContainer,
    Name = "Shadow",
    BackgroundColor3 = Color3.fromRGB(0, 0, 0),
    BackgroundTransparency = 0.8,
    BorderSizePixel = 0,
    Position = UDim2.new(0, 3, 0, 3),
    Size = UDim2.new(1, 0, 1, 0),
    ZIndex = -1
})

local ShadowCorner = Create("UICorner", {
    Parent = Shadow,
    CornerRadius = UDim.new(0, 6)
})

local TopBar = Create("Frame",{
    Parent = MainContainer,
    Name = "TopBar",
    BackgroundColor3 = Color3.fromRGB(40, 40, 45),
    BorderSizePixel = 0,
    Size = UDim2.new(1, 0, 0, 30 * baseSize),
    ZIndex = 2
})

local TopBarCorner = Create("UICorner", {
    Parent = TopBar,
    CornerRadius = UDim.new(0, 6)
})

-- Градиент для верхней панели
local Gradient = Create("UIGradient",{
    Parent = TopBar,
    Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(50, 50, 60)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(30, 30, 40))
    },
    Rotation = 90
})

local Title = Create("TextLabel",{
    Parent = TopBar,
    Name = "Title",
    BackgroundTransparency = 1,
    Position = UDim2.new(0, 10, 0, 0),
    Size = UDim2.new(0, 150, 1, 0),
    Font = Enum.Font.SourceSansSemibold,
    Text = randomName,
    TextColor3 = Color3.fromRGB(220, 220, 220),
    TextSize = fontSize + 2,
    TextXAlignment = Enum.TextXAlignment.Left
})

-- Кнопки управления с иконками
local ControlButtons = Create("Frame",{
    Parent = TopBar,
    Name = "ControlButtons",
    BackgroundTransparency = 1,
    Position = UDim2.new(1, -80, 0, 0),
    Size = UDim2.new(0, 80, 1, 0)
})

local MinimizeBtn = Create("ImageButton",{
    Parent = ControlButtons,
    Name = "MinimizeBtn",
    BackgroundColor3 = Color3.fromRGB(50, 50, 60),
    BorderSizePixel = 0,
    Position = UDim2.new(0, 0, 0.5, -10),
    Size = UDim2.new(0, 20, 0, 20),
    Image = "rbxassetid://7072725342",
    ImageColor3 = Color3.fromRGB(180, 180, 190)
})

local MinimizeCorner = Create("UICorner", {
    Parent = MinimizeBtn,
    CornerRadius = UDim.new(0, 4)
})

local MaximizeBtn = Create("ImageButton",{
    Parent = ControlButtons,
    Name = "MaximizeBtn",
    BackgroundColor3 = Color3.fromRGB(50, 50, 60),
    BorderSizePixel = 0,
    Position = UDim2.new(0, 25, 0.5, -10),
    Size = UDim2.new(0, 20, 0, 20),
    Image = "rbxassetid://7072725567",
    ImageColor3 = Color3.fromRGB(180, 180, 190)
})

local MaximizeCorner = Create("UICorner", {
    Parent = MaximizeBtn,
    CornerRadius = UDim.new(0, 4)
})

local CloseBtn = Create("ImageButton",{
    Parent = ControlButtons,
    Name = "CloseBtn",
    BackgroundColor3 = Color3.fromRGB(200, 60, 60),
    BorderSizePixel = 0,
    Position = UDim2.new(0, 50, 0.5, -10),
    Size = UDim2.new(0, 20, 0, 20),
    Image = "rbxassetid://7072725207",
    ImageColor3 = Color3.fromRGB(255, 255, 255)
})

local CloseCorner = Create("UICorner", {
    Parent = CloseBtn,
    CornerRadius = UDim.new(0, 4)
})

-- Тоггл для мониторинга
local MonitorToggle = Create("Frame",{
    Parent = TopBar,
    Name = "MonitorToggle",
    BackgroundColor3 = Color3.fromRGB(40, 40, 45),
    BorderSizePixel = 0,
    Position = UDim2.new(0, 170, 0, 5),
    Size = UDim2.new(0, 120, 0, 20)
})

local MonitorCorner = Create("UICorner", {
    Parent = MonitorToggle,
    CornerRadius = UDim.new(0, 4)
})

local ToggleLabel = Create("TextLabel",{
    Parent = MonitorToggle,
    Name = "ToggleLabel",
    BackgroundTransparency = 1,
    Size = UDim2.new(0, 70, 1, 0),
    Font = Enum.Font.SourceSansSemibold,
    Text = "MONITOR",
    TextColor3 = Color3.fromRGB(180, 180, 190),
    TextSize = fontSize - 2,
    TextXAlignment = Enum.TextXAlignment.Left
})

local ToggleButton = Create("Frame",{
    Parent = MonitorToggle,
    Name = "ToggleButton",
    BackgroundColor3 = Color3.fromRGB(70, 180, 80),
    BorderSizePixel = 0,
    Position = UDim2.new(1, -35, 0.5, -7),
    Size = UDim2.new(0, 30, 0, 14)
})

local ToggleCorner = Create("UICorner", {
    Parent = ToggleButton,
    CornerRadius = UDim.new(1, 0)
})

local ToggleCircle = Create("Frame",{
    Parent = ToggleButton,
    Name = "ToggleCircle",
    BackgroundColor3 = Color3.fromRGB(255, 255, 255),
    BorderSizePixel = 0,
    Position = UDim2.new(0, 2, 0.5, -6),
    Size = UDim2.new(0, 12, 0, 12)
})

local ToggleCircleCorner = Create("UICorner", {
    Parent = ToggleCircle,
    CornerRadius = UDim.new(1, 0)
})

local ContentArea = Create("Frame",{
    Parent = MainContainer,
    Name = "ContentArea",
    BackgroundTransparency = 1,
    Position = UDim2.new(0, 0, 0, 30 * baseSize),
    Size = UDim2.new(1, 0, 1, -30 * baseSize)
})

-- Левая панель с логами
local LeftPanel = Create("ScrollingFrame",{
    Parent = ContentArea,
    Name = "LeftPanel",
    Active = true,
    BackgroundColor3 = Color3.fromRGB(25, 25, 30),
    BorderSizePixel = 0,
    Size = UDim2.new(0, 150 * baseSize, 1, 0),
    CanvasSize = UDim2.new(0, 0, 0, 0),
    ScrollBarThickness = 4,
    ScrollBarImageColor3 = Color3.fromRGB(80, 80, 90)
})

local LeftPanelCorner = Create("UICorner", {
    Parent = LeftPanel,
    CornerRadius = UDim.new(0, 4)
})

local LogsTitle = Create("TextLabel",{
    Parent = LeftPanel,
    Name = "LogsTitle",
    BackgroundColor3 = Color3.fromRGB(35, 35, 40),
    BorderSizePixel = 0,
    Size = UDim2.new(1, 0, 0, 30),
    Font = Enum.Font.SourceSansSemibold,
    Text = "EVENT LOGS",
    TextColor3 = Color3.fromRGB(220, 220, 230),
    TextSize = fontSize
})

local LogsTitleCorner = Create("UICorner", {
    Parent = LogsTitle,
    CornerRadius = UDim.new(0, 4)
})

local LogsList = Create("Frame",{
    Parent = LeftPanel,
    Name = "LogsList",
    BackgroundTransparency = 1,
    Position = UDim2.new(0, 0, 0, 30),
    Size = UDim2.new(1, 0, 1, -30)
})

local LogsLayout = Create("UIListLayout",{
    Parent = LogsList,
    HorizontalAlignment = Enum.HorizontalAlignment.Center,
    SortOrder = Enum.SortOrder.LayoutOrder,
    Padding = UDim.new(0, 2)
})

-- Правая панель с деталями
local RightPanel = Create("Frame",{
    Parent = ContentArea,
    Name = "RightPanel",
    BackgroundColor3 = Color3.fromRGB(35, 35, 40),
    BorderSizePixel = 0,
    Position = UDim2.new(0, 150 * baseSize, 0, 0),
    Size = UDim2.new(1, -150 * baseSize, 1, 0)
})

local RightPanelCorner = Create("UICorner", {
    Parent = RightPanel,
    CornerRadius = UDim.new(0, 4)
})

-- Кодовая панель с вкладками
local CodeContainer = Create("Frame",{
    Parent = RightPanel,
    Name = "CodeContainer",
    BackgroundColor3 = Color3.fromRGB(20, 20, 25),
    BorderSizePixel = 0,
    Size = UDim2.new(1, 0, 0, 150 * baseSize)
})

local CodeContainerCorner = Create("UICorner", {
    Parent = CodeContainer,
    CornerRadius = UDim.new(0, 4)
})

local TabsBar = Create("Frame",{
    Parent = CodeContainer,
    Name = "TabsBar",
    BackgroundColor3 = Color3.fromRGB(30, 30, 35),
    BorderSizePixel = 0,
    Size = UDim2.new(1, 0, 0, 30)
})

local TabsBarCorner = Create("UICorner", {
    Parent = TabsBar,
    CornerRadius = UDim.new(0, 4)
})

local ScriptTab = Create("TextButton",{
    Parent = TabsBar,
    Name = "ScriptTab",
    BackgroundColor3 = Color3.fromRGB(50, 120, 220),
    BorderSizePixel = 0,
    Size = UDim2.new(0, 100, 1, 0),
    Font = Enum.Font.SourceSansSemibold,
    Text = "SCRIPT",
    TextColor3 = Color3.fromRGB(255, 255, 255),
    TextSize = fontSize
})

local ScriptTabCorner = Create("UICorner", {
    Parent = ScriptTab,
    CornerRadius = UDim.new(0, 4)
})

local InfoTab = Create("TextButton",{
    Parent = TabsBar,
    Name = "InfoTab",
    BackgroundColor3 = Color3.fromRGB(40, 40, 45),
    BorderSizePixel = 0,
    Position = UDim2.new(0, 100, 0, 0),
    Size = UDim2.new(0, 100, 1, 0),
    Font = Enum.Font.SourceSansSemibold,
    Text = "INFO",
    TextColor3 = Color3.fromRGB(180, 180, 190),
    TextSize = fontSize
})

local InfoTabCorner = Create("UICorner", {
    Parent = InfoTab,
    CornerRadius = UDim.new(0, 4)
})

local CodeBox = Create("Frame",{
    Parent = CodeContainer,
    Name = "CodeBox",
    BackgroundColor3 = Color3.fromRGB(15, 15, 20),
    BorderSizePixel = 0,
    Position = UDim2.new(0, 0, 0, 30),
    Size = UDim2.new(1, 0, 1, -30)
})

local CodeBoxCorner = Create("UICorner", {
    Parent = CodeBox,
    CornerRadius = UDim.new(0, 4)
})

-- Панель инструментов
local ToolsPanel = Create("ScrollingFrame",{
    Parent = RightPanel,
    Name = "ToolsPanel",
    Active = true,
    BackgroundColor3 = Color3.fromRGB(25, 25, 30),
    BorderSizePixel = 0,
    Position = UDim2.new(0, 0, 0, 150 * baseSize),
    Size = UDim2.new(1, 0, 1, -150 * baseSize),
    CanvasSize = UDim2.new(0, 0, 0, 0),
    ScrollBarThickness = 4
})

local ToolsPanelCorner = Create("UICorner", {
    Parent = ToolsPanel,
    CornerRadius = UDim.new(0, 4)
})

local ToolsGrid = Create("UIGridLayout",{
    Parent = ToolsPanel,
    HorizontalAlignment = Enum.HorizontalAlignment.Center,
    SortOrder = Enum.SortOrder.LayoutOrder,
    CellPadding = UDim2.new(0, 5, 0, 5),
    CellSize = UDim2.new(0, 140 * baseSize, 0, 40 * baseSize)
})

-- Статус бар
local StatusBar = Create("Frame",{
    Parent = MainContainer,
    Name = "StatusBar",
    BackgroundColor3 = Color3.fromRGB(40, 40, 45),
    BorderSizePixel = 0,
    Position = UDim2.new(0, 0, 1, -20),
    Size = UDim2.new(1, 0, 0, 20),
    ZIndex = 2
})

local StatusBarCorner = Create("UICorner", {
    Parent = StatusBar,
    CornerRadius = UDim.new(0, 4)
})

local StatusText = Create("TextLabel",{
    Parent = StatusBar,
    Name = "StatusText",
    BackgroundTransparency = 1,
    Position = UDim2.new(0, 10, 0, 0),
    Size = UDim2.new(0.5, -10, 1, 0),
    Font = Enum.Font.SourceSans,
    Text = "Ready",
    TextColor3 = Color3.fromRGB(180, 180, 190),
    TextSize = fontSize - 2,
    TextXAlignment = Enum.TextXAlignment.Left
})

local CounterText = Create("TextLabel",{
    Parent = StatusBar,
    Name = "CounterText",
    BackgroundTransparency = 1,
    Position = UDim2.new(0.5, 0, 0, 0),
    Size = UDim2.new(0.5, -10, 1, 0),
    Font = Enum.Font.SourceSans,
    Text = "Events: 0",
    TextColor3 = Color3.fromRGB(180, 180, 190),
    TextSize = fontSize - 2,
    TextXAlignment = Enum.TextXAlignment.Right
})

-- Минималистичная версия для скрытого режима
local MiniButton = Create("ImageButton",{
    Parent = DebugGUI,
    Name = "MiniButton",
    BackgroundColor3 = Color3.fromRGB(40, 40, 45),
    BackgroundTransparency = 0.3,
    BorderSizePixel = 0,
    Position = UDim2.new(1, -50, 1, -50),
    Size = UDim2.new(0, 40, 0, 40),
    Visible = false,
    Image = "rbxassetid://7072725342",
    ImageColor3 = Color3.fromRGB(220, 220, 220)
})

local MiniButtonCorner = Create("UICorner", {
    Parent = MiniButton,
    CornerRadius = UDim.new(1, 0)
})

-- Всплывающая подсказка
local ToolTip = Create("Frame",{
    Parent = DebugGUI,
    Name = "ToolTip",
    BackgroundColor3 = Color3.fromRGB(30, 30, 35),
    BackgroundTransparency = 0.1,
    BorderColor3 = Color3.fromRGB(60, 60, 70),
    Size = UDim2.new(0, 200, 0, 0),
    ZIndex = 100,
    Visible = false
})

local ToolTipCorner = Create("UICorner", {
    Parent = ToolTip,
    CornerRadius = UDim.new(0, 4)
})

local ToolTipText = Create("TextLabel",{
    Parent = ToolTip,
    Name = "ToolTipText",
    BackgroundTransparency = 1,
    Position = UDim2.new(0, 5, 0, 5),
    Size = UDim2.new(1, -10, 1, -10),
    Font = Enum.Font.SourceSans,
    Text = "",
    TextColor3 = Color3.fromRGB(220, 220, 220),
    TextSize = fontSize,
    TextWrapped = true,
    TextXAlignment = Enum.TextXAlignment.Left,
    TextYAlignment = Enum.TextYAlignment.Top
})

-------------------------------------------------------------------------------

-- Переменные состояния
local selectedColor = Color3.fromRGB(65, 140, 240)
local deselectedColor = Color3.fromRGB(50, 50, 60)
local layoutOrderNum = 999999999
local mainClosing = false
local closed = false
local sideClosing = false
local sideClosed = false
local maximized = false
local logs = {}
local selected = nil
local blacklist = {}
local blocklist = {}
local getNil = false
local connectedRemotes = {}
local toggle = true
local prevTables = {}
local remoteLogs = {}
local scheduled = {}
local schedulerconnect
local SimpleSpy = {}
local topstr = ""
local bottomstr = ""
local remotesFadeIn
local rightFadeIn
local codebox
local p
local getnilrequired = false

-- Автоблок переменные
local history = {}
local excluding = {}

-- Состояние мыши
local mouseInGui = false
local connections = {}
local DecompiledScripts = {}
local generation = {}
local running_threads = {}
local originalnamecall

-- Создаем удаленные объекты
local remoteEvent = Instance.new("RemoteEvent")
remoteEvent.Name = "SystemEvent_" .. math.random(1000, 9999)
remoteEvent.Parent = Storage

local unreliableRemoteEvent = Instance.new("UnreliableRemoteEvent")
unreliableRemoteEvent.Name = "UnreliableEvent_" .. math.random(1000, 9999)

local remoteFunction = Instance.new("RemoteFunction")
remoteFunction.Name = "SystemFunction_" .. math.random(1000, 9999)
remoteFunction.Parent = Storage

local NamecallHandler = Instance.new("BindableEvent")
NamecallHandler.Name = "NamecallHandler_" .. math.random(1000, 9999)
NamecallHandler.Parent = Storage

local IndexHandler = Instance.new("BindableEvent")
IndexHandler.Name = "IndexHandler_" .. math.random(1000, 9999)
IndexHandler.Parent = Storage

local GetDebugIdHandler = Instance.new("BindableFunction")
GetDebugIdHandler.Name = "DebugIdHandler_" .. math.random(1000, 9999)
GetDebugIdHandler.Parent = Storage

local originalEvent = remoteEvent.FireServer
local originalUnreliableEvent = unreliableRemoteEvent.FireServer
local originalFunction = remoteFunction.InvokeServer
local GetDebugIDInvoke = GetDebugIdHandler.Invoke

function GetDebugIdHandler.OnInvoke(obj: Instance)
    return OldDebugId(obj)
end

local function ThreadGetDebugId(obj: Instance): string 
    return GetDebugIDInvoke(GetDebugIdHandler, obj)
end

local synv3 = false

if syn and identifyexecutor then
    local suc, version = pcall(identifyexecutor)
    if suc and version and type(version) == "string" and version:sub(1, 2) == 'v3' then
        synv3 = true
    end
end

-- Сохранение настроек
pcall(function()
    if isfile and readfile and isfolder and makefolder and writefile then
        local configPath = "SystemDebug//Settings.json"
        
        if not isfolder("SystemDebug") then
            makefolder("SystemDebug")
        end
        if not isfolder("SystemDebug//Assets") then
            makefolder("SystemDebug//Assets")
        end
        
        if isfile(configPath) then
            local content = readfile(configPath)
            local cachedconfigs = jsond(content)
            
            if cachedconfigs and type(cachedconfigs) == "table" then
                for i, v in pairs(realconfigs) do
                    if cachedconfigs[i] == nil then
                        cachedconfigs[i] = v
                    end
                end
                realconfigs = cachedconfigs
            end
        end
        
        if not isfile(configPath) then
            writefile(configPath, jsone(realconfigs))
        end
        
        configs = setmetatable({}, {
            __index = function(self, index)
                return realconfigs[index]
            end,
            __newindex = function(self, index, newindex)
                realconfigs[index] = newindex
                writefile(configPath, jsone(realconfigs))
            end
        })
    end
end)

-- Логирование потоков
local function logthread(thread: thread)
    insert(running_threads, thread)
end

-- Очистка старых логов
function clean()
    local max = 300
    if getgenv().SystemDebugMaxRemotes and type(getgenv().SystemDebugMaxRemotes) == "number" then
        max = math.floor(getgenv().SystemDebugMaxRemotes)
    end
    
    if #remoteLogs > max then
        for i = max + 1, #remoteLogs do
            local v = remoteLogs[i]
            if v and type(v) == "table" then
                if v[1] and typeof(v[1]) == "RBXScriptConnection" then
                    v[1]:Disconnect()
                end
                if v[2] and typeof(v[2]) == "Instance" then
                    v[2]:Destroy()
                end
            end
        end
        
        local newLogs = {}
        for i = 1, math.min(max, #remoteLogs) do
            newLogs[i] = remoteLogs[i]
        end
        remoteLogs = newLogs
    end
end

local function ThreadIsNotDead(thread: thread): boolean
    return status(thread) ~= "dead"
end

-- Адаптация интерфейса для мобильных устройств
local function adaptForMobile()
    if isMobile then
        -- Увеличиваем размеры для касаний
        MinimizeBtn.Size = UDim2.new(0, 30, 0, 30)
        MaximizeBtn.Size = UDim2.new(0, 30, 0, 30)
        CloseBtn.Size = UDim2.new(0, 30, 0, 30)
        ToggleButton.Size = UDim2.new(0, 40, 0, 20)
        ToggleCircle.Size = UDim2.new(0, 16, 0, 16)
        
        -- Увеличиваем отступы
        LeftPanel.ScrollBarThickness = 8
        ToolsPanel.ScrollBarThickness = 8
        
        -- Адаптируем шрифты
        fontSize = 14
        Title.TextSize = 16
        StatusText.TextSize = 12
        CounterText.TextSize = 12
        
        -- Обновляем UI
        MainContainer.Size = UDim2.new(0, 450 * baseSize, 0, 268 * baseSize)
        LeftPanel.Size = UDim2.new(0, 150 * baseSize, 1, 0)
        RightPanel.Size = UDim2.new(1, -150 * baseSize, 1, 0)
    end
end

-- Показать/скрыть подсказку
function showToolTip(text, position)
    if not ToolTip or not ToolTipText then return end
    
    ToolTipText.Text = tostring(text)
    local textSize = TextService:GetTextSize(
        tostring(text), 
        ToolTipText.TextSize, 
        ToolTipText.Font, 
        Vector2.new(190, math.huge)
    )
    ToolTip.Size = UDim2.new(0, 200, 0, textSize.Y + 10)
    ToolTip.Position = position
    ToolTip.Visible = true
end

function hideToolTip()
    if ToolTip then
        ToolTip.Visible = false
    end
end

-- Обновление статуса
function updateStatus(text)
    if StatusText then
        StatusText.Text = tostring(text)
    end
end

-- Обновление счетчика
function updateCounter(count)
    if CounterText then
        CounterText.Text = "Events: " .. tostring(count)
    end
end

-- Создание кнопки инструмента
function createToolButton(name, desc, icon, onClick)
    local ToolButton = Create("Frame",{
        Name = name .. "Tool",
        BackgroundColor3 = Color3.fromRGB(40, 40, 45),
        BackgroundTransparency = 0.5,
        Size = UDim2.new(1, 0, 1, 0)
    })

    local ToolButtonCorner = Create("UICorner", {
        Parent = ToolButton,
        CornerRadius = UDim.new(0, 4)
    })

    local ButtonIcon = Create("ImageLabel",{
        Parent = ToolButton,
        Name = "Icon",
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 8, 0.5, -10),
        Size = UDim2.new(0, 20, 0, 20),
        Image = icon,
        ImageColor3 = Color3.fromRGB(180, 180, 190)
    })

    local ButtonText = Create("TextLabel",{
        Parent = ToolButton,
        Name = "Text",
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 35, 0, 0),
        Size = UDim2.new(1, -35, 1, 0),
        Font = Enum.Font.SourceSans,
        Text = name,
        TextColor3 = Color3.fromRGB(220, 220, 230),
        TextSize = fontSize - 1,
        TextXAlignment = Enum.TextXAlignment.Left
    })

    local ButtonBtn = Create("TextButton",{
        Parent = ToolButton,
        Name = "Button",
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, 0),
        Text = ""
    })

    ButtonBtn.MouseEnter:Connect(function()
        ToolButton.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
        if ButtonIcon then
            ButtonIcon.ImageColor3 = Color3.fromRGB(220, 220, 230)
        end
    end)

    ButtonBtn.MouseLeave:Connect(function()
        ToolButton.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
        if ButtonIcon then
            ButtonIcon.ImageColor3 = Color3.fromRGB(180, 180, 190)
        end
    end)

    ButtonBtn.MouseButton1Click:Connect(function()
        if onClick then
            pcall(onClick)
        end
    end)

    ButtonBtn.MouseButton2Click:Connect(function()
        if desc then
            local mouse = UserInputService:GetMouseLocation()
            showToolTip(desc, UDim2.new(0, mouse.X, 0, mouse.Y))
        end
    end)

    ToolButton.Parent = ToolsPanel
    return ToolButton
end

-- Создание записи лога
function createLogEntry(log)
    local LogEntry = Create("Frame",{
        Name = "LogEntry",
        BackgroundColor3 = deselectedColor,
        BackgroundTransparency = 0.5,
        Size = UDim2.new(1, -10, 0, 40)
    })

    local LogEntryCorner = Create("UICorner", {
        Parent = LogEntry,
        CornerRadius = UDim.new(0, 4)
    })

    local TypeIndicator = Create("Frame",{
        Parent = LogEntry,
        Name = "TypeIndicator",
        BackgroundColor3 = log.type == "event" and Color3.fromRGB(255, 200, 50) or Color3.fromRGB(100, 150, 255),
        BorderSizePixel = 0,
        Position = UDim2.new(0, 5, 0.5, -5),
        Size = UDim2.new(0, 10, 0, 10)
    })

    local TypeIndicatorCorner = Create("UICorner", {
        Parent = TypeIndicator,
        CornerRadius = UDim.new(1, 0)
    })

    local RemoteName = Create("TextLabel",{
        Parent = LogEntry,
        Name = "RemoteName",
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 20, 0, 5),
        Size = UDim2.new(1, -25, 0, 16),
        Font = Enum.Font.SourceSans,
        Text = log.name or "Unknown",
        TextColor3 = Color3.fromRGB(220, 220, 230),
        TextSize = fontSize,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextTruncate = Enum.TextTruncate.AtEnd
    })

    local RemotePath = Create("TextLabel",{
        Parent = LogEntry,
        Name = "RemotePath",
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 20, 0, 21),
        Size = UDim2.new(1, -25, 0, 14),
        Font = Enum.Font.SourceSans,
        Text = log.path or "",
        TextColor3 = Color3.fromRGB(150, 150, 160),
        TextSize = fontSize - 2,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextTruncate = Enum.TextTruncate.AtEnd
    })

    local SelectButton = Create("TextButton",{
        Parent = LogEntry,
        Name = "SelectButton",
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 1, 0),
        Text = ""
    })

    SelectButton.MouseEnter:Connect(function()
        LogEntry.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
    end)

    SelectButton.MouseLeave:Connect(function()
        if selected ~= log then
            LogEntry.BackgroundColor3 = deselectedColor
        end
    end)

    SelectButton.MouseButton1Click:Connect(function()
        if selected and selected.entry then
            selected.entry.BackgroundColor3 = deselectedColor
        end
        
        selected = log
        if LogEntry then
            LogEntry.BackgroundColor3 = selectedColor
            selected.entry = LogEntry
        end
        
        -- Показываем детали
        showLogDetails(log)
    end)

    LogEntry.Parent = LogsList
    log.entry = LogEntry
    return LogEntry
end

-- Показать детали лога
function showLogDetails(log)
    if not log or not codebox then return end
    
    -- Обновляем код
    if codebox.setRaw then
        local script = genScript(log.remote, log.args or {})
        if log.blocked then
            script = "-- BLOCKED BY SYSTEM\n\n" .. script
        end
        codebox:setRaw(script)
    end
    
    -- Обновляем вкладку информации
    updateInfoTab(log)
end

-- Обновление вкладки информации
function updateInfoTab(log)
    if not InfoTab then return end
    
    -- Здесь будет обновление InfoTab
    -- Временно просто меняем текст вкладки
    if InfoTab:IsA("TextButton") then
        InfoTab.Text = "INFO (" .. (log.name or "Unknown") .. ")"
    end
end

-- Генерация скрипта
function genScript(remote, args)
    prevTables = {}
    local gen = ""
    
    if not remote then
        return "-- Invalid remote"
    end
    
    if args and #args > 0 then
        local suc, result = pcall(function()
            return "local args = " .. LazyFix.Convert(args, true) .. "\n"
        end)
        
        if suc then
            gen = result
        else
            gen = "-- Conversion error\n--" .. tostring(result) .. "\nlocal args = {\n"
            for i, v in pairs(args) do
                if type(i) == "string" then
                    gen = gen .. '    ["' .. tostring(i) .. '"] = '
                else
                    gen = gen .. "    [" .. tostring(i) .. "] = "
                end
                
                if type(v) == "string" then
                    gen = gen .. '"' .. v .. '"'
                else
                    gen = gen .. tostring(v)
                end
                gen = gen .. ",\n"
            end
            gen = gen .. "}\n\n"
        end
        
        if not remote:IsDescendantOf(game) then
            gen = "function getNil(name,class) for _,v in next, getnilinstances() do if v.ClassName==class and v.Name==name then return v;end end end\n\n" .. gen
        end
        
        if remote:IsA("RemoteEvent") or remote:IsA("UnreliableRemoteEvent") then
            gen = gen .. "game:GetService('ReplicatedStorage'):FindFirstChild('" .. remote.Name .. "'):FireServer(unpack(args))"
        elseif remote:IsA("RemoteFunction") then
            gen = gen .. "game:GetService('ReplicatedStorage'):FindFirstChild('" .. remote.Name .. "'):InvokeServer(unpack(args))"
        end
    else
        if remote:IsA("RemoteEvent") or remote:IsA("UnreliableRemoteEvent") then
            gen = "game:GetService('ReplicatedStorage'):FindFirstChild('" .. remote.Name .. "'):FireServer()"
        elseif remote:IsA("RemoteFunction") then
            gen = "game:GetService('ReplicatedStorage'):FindFirstChild('" .. remote.Name .. "'):InvokeServer()"
        end
    end
    
    prevTables = {}
    return gen
end

-- Функция schedule (добавлена)
local function schedule(func, ...)
    insert(scheduled, {func, ...})
end

-- Функция checkcaller (добавлена)
local function checkcaller()
    local calling = getcallingscript()
    return calling and calling:IsDescendantOf(game)
end

-- Добавление нового удаленного события
function newRemote(type, data)
    if not data or not data.remote then return end
    
    local remote = data.remote
    local callingscript = data.callingscript
    
    local log = {
        name = remote.Name,
        type = type,
        remote = remote,
        args = data.args or {},
        caller = callingscript and callingscript.Name or "Unknown",
        path = remote:GetFullName(),
        blocked = data.blocked or false,
        time = os.time()
    }
    
    -- Создаем визуальную запись
    local entry = createLogEntry(log)
    log.entry = entry
    
    insert(logs, log)
    
    -- Обновляем счетчик
    updateCounter(#logs)
    
    -- Прокручиваем к новому элементу
    delay(0.1, function()
        if LeftPanel and LogsList then
            LeftPanel.CanvasPosition = Vector2.new(0, LogsList.AbsoluteSize.Y)
        end
    end)
    
    -- Очистка старых логов
    clean()
end

-- Обработчик удаленных событий
function remoteHandler(data)
    if not data or not data.remote then return end
    
    if configs.autoblock then
        local id = data.id

        if excluding[id] then
            return
        end
        if not history[id] then
            history[id] = {badOccurances = 0, lastCall = tick()}
        end
        if tick() - history[id].lastCall < 1 then
            history[id].badOccurances += 1
            return
        else
            history[id].badOccurances = 0
        end
        if history[id].badOccurances > 3 then
            excluding[id] = true
            return
        end
        history[id].lastCall = tick()
    end

    if (data.remote:IsA("RemoteEvent") or data.remote:IsA("UnreliableRemoteEvent")) and lower(data.method or "") == "fireserver" then
        newRemote("event", data)
    elseif data.remote:IsA("RemoteFunction") and lower(data.method or "") == "invokeserver" then
        newRemote("function", data)
    end
end

-- Хуки для перехвата
local newindex = function(method, originalfunction, ...)
    local args = {...}
    if #args > 0 and typeof(args[1]) == 'Instance' then
        local remote = args[1]

        if remote:IsA("RemoteEvent") or remote:IsA("RemoteFunction") or remote:IsA("UnreliableRemoteEvent") then
            if not configs.logcheckcaller and checkcaller() then 
                return originalfunction(...) 
            end
            local id = tostring(remote)
            local blockcheck = false
            local callArgs = {select(2, ...)}

            if not IsCyclicTable(callArgs) then
                local data = {
                    method = method,
                    remote = remote,
                    args = deepclone(callArgs),
                    callingscript = nil,
                    blockcheck = blockcheck,
                    id = id
                }

                if configs.funcEnabled then
                    local calling = getcallingscript()
                    data.callingscript = calling
                end

                schedule(remoteHandler, data)
            end
            if blockcheck then return end
        end
    end
    return originalfunction(...)
end

local newnamecall = newcclosure(function(...)
    local method = getnamecallmethod()

    if method and (method == "FireServer" or method == "fireServer" or method == "InvokeServer" or method == "invokeServer") then
        local args = {...}
        if #args > 0 and typeof(args[1]) == 'Instance' then
            local remote = args[1]

            if remote:IsA("RemoteEvent") or remote:IsA("RemoteFunction") or remote:IsA("UnreliableRemoteEvent") then    
                if not configs.logcheckcaller and checkcaller() then 
                    return originalnamecall(...) 
                end
                local id = tostring(remote)
                local blockcheck = false
                local callArgs = {select(2, ...)}

                if not IsCyclicTable(callArgs) then
                    local data = {
                        method = method,
                        remote = remote,
                        args = deepclone(callArgs),
                        callingscript = nil,
                        blockcheck = blockcheck,
                        id = id
                    }

                    if configs.funcEnabled then
                        local calling = getcallingscript()
                        data.callingscript = calling
                    end

                    schedule(remoteHandler, data)
                end
                if blockcheck then return end
            end
        end
    end
    return originalnamecall(...)
end)

local newFireServer = newcclosure(function(...)
    return newindex("FireServer", originalEvent, ...)
end)

local newUnreliableFireServer = newcclosure(function(...)
    return newindex("FireServer", originalUnreliableEvent, ...)
end)

local newInvokeServer = newcclosure(function(...)
    return newindex("InvokeServer", originalFunction, ...)
end)

-- Управление хуками
local function disablehooks()
    if synv3 and unhook then
        if originalnamecall then
            pcall(unhook, getrawmetatable(game).__namecall, originalnamecall)
        end
        if originalEvent then
            pcall(unhook, Instance.new("RemoteEvent").FireServer, originalEvent)
        end
        if originalFunction then
            pcall(unhook, Instance.new("RemoteFunction").InvokeServer, originalFunction)
        end
        if originalUnreliableEvent then
            pcall(unhook, Instance.new("UnreliableRemoteEvent").FireServer, originalUnreliableEvent)
        end
    else
        if hookfunction and originalEvent then
            pcall(hookfunction, Instance.new("RemoteEvent").FireServer, originalEvent)
        end
        if hookfunction and originalFunction then
            pcall(hookfunction, Instance.new("RemoteFunction").InvokeServer, originalFunction)
        end
        if hookfunction and originalUnreliableEvent then
            pcall(hookfunction, Instance.new("UnreliableRemoteEvent").FireServer, originalUnreliableEvent)
        end
    end
end

function toggleSpy()
    if not toggle then
        local oldnamecall
        
        if synv3 and hook then
            pcall(function()
                oldnamecall = hook(getrawmetatable(game).__namecall, clonefunction(newnamecall))
                originalEvent = hook(Instance.new("RemoteEvent").FireServer, clonefunction(newFireServer))
                originalFunction = hook(Instance.new("RemoteFunction").InvokeServer, clonefunction(newInvokeServer))
                originalUnreliableEvent = hook(Instance.new("UnreliableRemoteEvent").FireServer, clonefunction(newUnreliableFireServer))
            end)
        else
            if hookmetamethod then
                oldnamecall = hookmetamethod(game, "__namecall", clonefunction(newnamecall))
            elseif hookfunction then
                oldnamecall = hookfunction(getrawmetatable(game).__namecall, clonefunction(newnamecall))
            end
            
            if hookfunction then
                pcall(function()
                    originalEvent = hookfunction(Instance.new("RemoteEvent").FireServer, clonefunction(newFireServer))
                    originalFunction = hookfunction(Instance.new("RemoteFunction").InvokeServer, clonefunction(newInvokeServer))
                    originalUnreliableEvent = hookfunction(Instance.new("UnreliableRemoteEvent").FireServer, clonefunction(newUnreliableFireServer))
                end)
            end
        end
        
        if oldnamecall then
            originalnamecall = oldnamecall
        end
        
        if ToggleCircle then
            TweenService:Create(ToggleCircle, TweenInfo.new(0.3), {Position = UDim2.new(1, -18, 0.5, -8)}):Play()
        end
        if ToggleButton then
            TweenService:Create(ToggleButton, TweenInfo.new(0.3), {BackgroundColor3 = Color3.fromRGB(70, 180, 80)}):Play()
        end
        updateStatus("Monitoring enabled")
    else
        disablehooks()
        if ToggleCircle then
            TweenService:Create(ToggleCircle, TweenInfo.new(0.3), {Position = UDim2.new(0, 2, 0.5, -8)}):Play()
        end
        if ToggleButton then
            TweenService:Create(ToggleButton, TweenInfo.new(0.3), {BackgroundColor3 = Color3.fromRGB(100, 100, 110)}):Play()
        end
        updateStatus("Monitoring disabled")
    end
end

function toggleSpyMethod()
    toggleSpy()
    toggle = not toggle
end

-- Минимизация/максимизация
function toggleMinimize()
    if mainClosing or maximized then return end
    mainClosing = true
    
    if closed then
        -- Разворачиваем
        TweenService:Create(MainContainer, TweenInfo.new(0.3), {Size = UDim2.new(0, 450 * baseSize, 0, 268 * baseSize)}):Play()
        closed = false
        if MiniButton then
            MiniButton.Visible = false
        end
        updateStatus("Interface expanded")
    else
        -- Сворачиваем
        TweenService:Create(MainContainer, TweenInfo.new(0.3), {Size = UDim2.new(0, 150 * baseSize, 0, 30 * baseSize)}):Play()
        closed = true
        updateStatus("Interface minimized")
        
        -- Показываем маленькую кнопку
        delay(0.3, function()
            if MiniButton then
                MiniButton.Visible = true
            end
        end)
    end
    
    mainClosing = false
end

-- Переключение панелей
function toggleSidePanel()
    if sideClosing then return end
    sideClosing = true
    
    if sideClosed then
        -- Показываем правую панель
        TweenService:Create(RightPanel, TweenInfo.new(0.3), {Size = UDim2.new(1, -150 * baseSize, 1, 0)}):Play()
        sideClosed = false
    else
        -- Скрываем правую панель
        TweenService:Create(RightPanel, TweenInfo.new(0.3), {Size = UDim2.new(0, 0, 1, 0)}):Play()
        sideClosed = true
    end
    
    sideClosing = false
end

-- Максимизация кодовой панели
function maximizeCodePanel()
    if maximized or not CodeContainer then return end
    maximized = true
    
    local originalSize = CodeContainer.Size
    local originalPosition = CodeContainer.Position
    
    TweenService:Create(CodeContainer, TweenInfo.new(0.3), {
        Size = UDim2.new(1, -20, 0.8, -20),
        Position = UDim2.new(0, 10, 0.1, 10)
    }):Play()
    
    CodeContainer.ZIndex = 10
    
    -- Кнопка для возврата
    local exitBtn = Create("TextButton",{
        Parent = CodeContainer,
        BackgroundColor3 = Color3.fromRGB(200, 60, 60),
        Position = UDim2.new(1, -30, 0, 5),
        Size = UDim2.new(0, 25, 0, 25),
        Text = "X",
        Font = Enum.Font.SourceSansBold,
        TextColor3 = Color3.fromRGB(255, 255, 255),
        TextSize = 14
    })
    
    local exitBtnCorner = Create("UICorner", {
        Parent = exitBtn,
        CornerRadius = UDim.new(0, 4)
    })
    
    exitBtn.MouseButton1Click:Connect(function()
        TweenService:Create(CodeContainer, TweenInfo.new(0.3), {
            Size = originalSize,
            Position = originalPosition
        }):Play()
        
        delay(0.3, function()
            CodeContainer.ZIndex = 1
            exitBtn:Destroy()
            maximized = false
        end)
    end)
end

-- Движение интерфейса
local dragging = false
local dragStart = Vector2.new(0,0)
local startPosition = Vector2.new(0,0)

if TopBar then
    TopBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = Vector2.new(input.Position.X, input.Position.Y)
            startPosition = Vector2.new(MainContainer.Position.X.Offset, MainContainer.Position.Y.Offset)
            
            -- Поднимаем окно наверх при перетаскивании
            MainContainer.ZIndex = 100
        end
    end)
end

UserInputService.InputChanged:Connect(function(input)
    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        local delta = Vector2.new(input.Position.X, input.Position.Y) - dragStart
        local newX = startPosition.X + delta.X
        local newY = startPosition.Y + delta.Y
        
        -- Ограничиваем движение в пределах экрана
        local viewportSize = workspace.CurrentCamera.ViewportSize
        
        if newX < 0 then newX = 0 end
        if newY < 0 then newY = 0 end
        if newX + MainContainer.AbsoluteSize.X > viewportSize.X then 
            newX = viewportSize.X - MainContainer.AbsoluteSize.X 
        end
        if newY + MainContainer.AbsoluteSize.Y > viewportSize.Y - GuiInset.Y then 
            newY = viewportSize.Y - MainContainer.AbsoluteSize.Y - GuiInset.Y
        end
        
        MainContainer.Position = UDim2.new(0, newX, 0, newY)
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = false
        -- Возвращаем нормальный ZIndex
        MainContainer.ZIndex = 1
    end
end)

-- Авто-скрытие
local lastActivity = tick()
local function recordActivity()
    lastActivity = tick()
end

if MainContainer then
    MainContainer.InputBegan:Connect(recordActivity)
end
if TopBar then
    TopBar.InputBegan:Connect(recordActivity)
end

if configs.autoHide then
    spawn(function()
        while task.wait(5) do
            if tick() - lastActivity > configs.hideDelay and not closed and DebugGUI.Enabled then
                toggleMinimize()
                updateStatus("Auto-hidden due to inactivity")
            end
        end
    end)
end

-- Планировщик задач
local function taskscheduler()
    if not toggle then
        scheduled = {}
        return
    end
    if #scheduled > 100 then
        remove(scheduled, #scheduled)
    end
    if #scheduled > 0 then
        local currentf = scheduled[1]
        remove(scheduled, 1)
        if type(currentf) == "table" and type(currentf[1]) == "function" then
            pcall(currentf[1], unpack(currentf, 2))
        end
    end
end

-- Выключение
local function shutdown()
    if schedulerconnect then
        schedulerconnect:Disconnect()
    end
    for _, connection in next, connections do
        if connection and typeof(connection) == "RBXScriptConnection" then
            connection:Disconnect()
        end
    end
    for i, v in pairs(running_threads) do
        if ThreadIsNotDead(v) then
            pcall(close, v)
        end
    end
    clear(running_threads)
    clear(connections)
    clear(logs)
    clear(remoteLogs)
    disablehooks()
    
    if DebugGUI then
        DebugGUI:Destroy()
    end
    if Storage then
        Storage:Destroy()
    end
    
    UserInputService.MouseIconEnabled = true
    getgenv().AdvancedDebugExecuted = false
end

-- Инициализация Highlight
if Highlight and Highlight.new then
    codebox = Highlight.new(CodeBox)
else
    -- Fallback если Highlight не загрузился
    codebox = {
        setRaw = function(self, text)
            if CodeBox then
                for _, child in ipairs(CodeBox:GetChildren()) do
                    child:Destroy()
                end
                
                local label = Create("TextLabel", {
                    Parent = CodeBox,
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, 0, 1, 0),
                    Font = Enum.Font.Code,
                    Text = tostring(text),
                    TextColor3 = Color3.fromRGB(255, 255, 255),
                    TextSize = 12,
                    TextXAlignment = Enum.TextXAlignment.Left,
                    TextYAlignment = Enum.TextYAlignment.Top,
                    TextWrapped = true
                })
            end
        end,
        getString = function(self)
            if CodeBox then
                local label = CodeBox:FindFirstChildWhichIsA("TextLabel")
                return label and label.Text or ""
            end
            return ""
        end
    }
end

-- Настройка обработчиков событий
if MinimizeBtn then
    MinimizeBtn.MouseButton1Click:Connect(toggleMinimize)
end

if MaximizeBtn then
    MaximizeBtn.MouseButton1Click:Connect(toggleSidePanel)
end

if CloseBtn then
    CloseBtn.MouseButton1Click:Connect(shutdown)
end

if ToggleButton then
    ToggleButton.MouseButton1Click:Connect(toggleSpyMethod)
end

if MiniButton then
    MiniButton.MouseButton1Click:Connect(toggleMinimize)
end

if ScriptTab then
    ScriptTab.MouseButton1Click:Connect(function()
        ScriptTab.BackgroundColor3 = Color3.fromRGB(50, 120, 220)
        if InfoTab then
            InfoTab.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
        end
    end)
end

if InfoTab then
    InfoTab.MouseButton1Click:Connect(function()
        InfoTab.BackgroundColor3 = Color3.fromRGB(50, 120, 220)
        if ScriptTab then
            ScriptTab.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
        end
    end)
end

-- Создание инструментов
createToolButton("Copy", "Copy script to clipboard", "rbxassetid://7072725342", function()
    if codebox and codebox.getString then
        local text = codebox:getString()
        setclipboard(text)
        updateStatus("Script copied to clipboard")
    end
end)

createToolButton("Execute", "Execute script", "rbxassetid://7072725567", function()
    if selected and selected.remote and selected.args then
        updateStatus("Executing...")
        pcall(function()
            if selected.remote:IsA("RemoteEvent") or selected.remote:IsA("UnreliableRemoteEvent") then
                selected.remote:FireServer(unpack(selected.args))
            elseif selected.remote:IsA("RemoteFunction") then
                selected.remote:InvokeServer(unpack(selected.args))
            end
            updateStatus("Execution successful")
        end)
    else
        updateStatus("No remote selected or invalid data")
    end
end)

createToolButton("Clear", "Clear all logs", "rbxassetid://7072725207", function()
    clear(logs)
    selected = nil
    
    -- Очищаем визуальные элементы
    if LogsList then
        for _, child in ipairs(LogsList:GetChildren()) do
            if child:IsA("Frame") and child.Name == "LogEntry" then
                child:Destroy()
            end
        end
    end
    
    -- Очищаем кодбокс
    if codebox and codebox.setRaw then
        codebox:setRaw("")
    end
    
    updateCounter(0)
    updateStatus("Logs cleared")
end)

createToolButton("Block", "Block this remote", "rbxassetid://7072923071", function()
    if selected and selected.remote then
        blocklist[selected.remote] = true
        updateStatus("Remote blocked")
    else
        updateStatus("No remote selected")
    end
end)

createToolButton("Save", "Save logs to file", "rbxassetid://7072923388", function()
    updateStatus("Save feature coming soon")
end)

createToolButton("Settings", "Open settings", "rbxassetid://7072923693", function()
    updateStatus("Settings panel coming soon")
end)

-- Адаптация для мобильных устройств
adaptForMobile()

-- Запуск мониторинга
toggleSpyMethod()

-- Запуск планировщика
schedulerconnect = RunService.Heartbeat:Connect(taskscheduler)

-- Показ интерфейса
local success, err = pcall(function()
    if gethui then
        DebugGUI.Parent = gethui()
    elseif syn and syn.protect_gui then
        syn.protect_gui(DebugGUI)
        DebugGUI.Parent = CoreGui
    else
        DebugGUI.Parent = CoreGui
    end
end)

if not success then
    DebugGUI.Parent = CoreGui
end

DebugGUI.Enabled = true

-- Обновление счетчика
updateCounter(0)
updateStatus("System ready")

-- Скрытый запуск
if configs.stealthMode then
    delay(2, function()
        toggleMinimize()
    end)
end

getgenv().AdvancedDebugExecuted = true
getgenv().AdvancedDebugShutdown = shutdown

-- Горячие клавиши
UserInputService.InputBegan:Connect(function(input, processed)
    if not processed then
        -- Ctrl+Shift+D для показа/скрытия
        if input.KeyCode == Enum.KeyCode.D and
           UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) and
           UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then
            DebugGUI.Enabled = not DebugGUI.Enabled
            updateStatus(DebugGUI.Enabled and "Interface shown" or "Interface hidden")
        end
        
        -- Alt+M для минимизации
        if input.KeyCode == Enum.KeyCode.M and
           UserInputService:IsKeyDown(Enum.KeyCode.LeftAlt) then
            toggleMinimize()
        end
        
        -- Alt+S для переключения мониторинга
        if input.KeyCode == Enum.KeyCode.S and
           UserInputService:IsKeyDown(Enum.KeyCode.LeftAlt) then
            toggleSpyMethod()
        end
    end
end)

-- Функция для показа подсказки при наведении
local function setupTooltips()
    -- Подсказки для кнопок управления
    if MinimizeBtn then
        MinimizeBtn.MouseEnter:Connect(function()
            local mouse = UserInputService:GetMouseLocation()
            showToolTip("Minimize window", UDim2.new(0, mouse.X, 0, mouse.Y))
        end)
        MinimizeBtn.MouseLeave:Connect(hideToolTip)
    end
    
    if MaximizeBtn then
        MaximizeBtn.MouseEnter:Connect(function()
            local mouse = UserInputService:GetMouseLocation()
            showToolTip("Toggle side panel", UDim2.new(0, mouse.X, 0, mouse.Y))
        end)
        MaximizeBtn.MouseLeave:Connect(hideToolTip)
    end
    
    if CloseBtn then
        CloseBtn.MouseEnter:Connect(function()
            local mouse = UserInputService:GetMouseLocation()
            showToolTip("Close debug tool", UDim2.new(0, mouse.X, 0, mouse.Y))
        end)
        CloseBtn.MouseLeave:Connect(hideToolTip)
    end
    
    if ToggleButton then
        ToggleButton.MouseEnter:Connect(function()
            local mouse = UserInputService:GetMouseLocation()
            showToolTip("Toggle remote monitoring", UDim2.new(0, mouse.X, 0, mouse.Y))
        end)
        ToggleButton.MouseLeave:Connect(hideToolTip)
    end
    
    if MiniButton then
        MiniButton.MouseEnter:Connect(function()
            local mouse = UserInputService:GetMouseLocation()
            showToolTip("Show debug window", UDim2.new(0, mouse.X, 0, mouse.Y))
        end)
        MiniButton.MouseLeave:Connect(hideToolTip)
    end
end

setupTooltips()

print("[System] Advanced Debug Tool initialized successfully - " .. randomName)

-- Экспортируем API для внешнего использования
local AdvancedDebugAPI = {
    Show = function()
        if DebugGUI then
            DebugGUI.Enabled = true
            toggleMinimize()
            updateStatus("Interface shown")
        end
    end,
    
    Hide = function()
        toggleMinimize()
        updateStatus("Interface hidden")
    end,
    
    ToggleMonitor = toggleSpyMethod,
    
    ClearLogs = function()
        clear(logs)
        selected = nil
        if LogsList then
            for _, child in ipairs(LogsList:GetChildren()) do
                if child:IsA("Frame") and child.Name == "LogEntry" then
                    child:Destroy()
                end
            end
        end
        if codebox and codebox.setRaw then
            codebox:setRaw("")
        end
        updateCounter(0)
        updateStatus("Logs cleared")
    end,
    
    GetLogs = function()
        return logs
    end,
    
    Shutdown = shutdown
}

getgenv().AdvancedDebug = AdvancedDebugAPI

return AdvancedDebugAPI
