--[[
    Nova UI Library v2.0
    Ultimate Mod Menu Framework for Roblox
    Author: Nova Team
    License: MIT
    
    FEATURES:
    - Modern, clean UI design
    - Full mobile support with floating button
    - No errors, production-ready
    - Optimized performance
    - Complete widget set
    - Built-in console system
--]]

-- Services
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")

-- Library Table
local Nova = {
    Version = "2.0",
    Debug = false,
    Instances = {}
}

Nova.__index = Nova

-- Configuration
local DEFAULT_CONFIG = {
    AccentColor = Color3.fromRGB(0, 170, 255),
    BackgroundTransparency = 0.1,
    Theme = "Dark",
    Keybind = Enum.KeyCode.RightShift
}

local themes = {
    Dark = {
        Background = Color3.fromRGB(30, 30, 35),
        Surface = Color3.fromRGB(40, 40, 45),
        Text = Color3.fromRGB(240, 240, 245),
        SubText = Color3.fromRGB(180, 180, 185),
        Border = Color3.fromRGB(60, 60, 70),
        Hover = Color3.fromRGB(50, 50, 55)
    },
    Light = {
        Background = Color3.fromRGB(250, 250, 250),
        Surface = Color3.fromRGB(255, 255, 255),
        Text = Color3.fromRGB(30, 30, 35),
        SubText = Color3.fromRGB(100, 100, 105),
        Border = Color3.fromRGB(220, 220, 225),
        Hover = Color3.fromRGB(240, 240, 245)
    }
}

-- Utility Functions
local function Create(class, props)
    local obj = Instance.new(class)
    
    for prop, value in pairs(props) do
        if prop ~= "Parent" then
            local success = pcall(function()
                obj[prop] = value
            end)
            if not success and Nova.Debug then
                warn("[Nova UI] Failed to set property", prop, "on", class)
            end
        end
    end
    
    if props.Parent then
        obj.Parent = props.Parent
    end
    
    table.insert(Nova.Instances, obj)
    return obj
end

local function Tween(obj, props, duration, style)
    if not obj or not props then return nil end
    
    local tweenInfo = TweenInfo.new(duration or 0.25, style or Enum.EasingStyle.Quint)
    local tweenObj = TweenService:Create(obj, tweenInfo, props)
    tweenObj:Play()
    return tweenObj
end

local function Round(num, decimalPlaces)
    decimalPlaces = decimalPlaces or 2
    local mult = 10 ^ decimalPlaces
    return math.floor(num * mult + 0.5) / mult
end

-- Main Constructor
function Nova.new(menuName)
    menuName = menuName or "NovaMenu"
    
    -- Cleanup old menus
    pcall(function()
        for _, child in ipairs(CoreGui:GetChildren()) do
            if child:IsA("ScreenGui") and child.Name:find(menuName) then
                child:Destroy()
            end
        end
    end)
    
    local self = setmetatable({}, Nova)
    
    self.MenuName = menuName .. "_" .. HttpService:GenerateGUID(false):sub(1, 8)
    self.Sections = {}
    self.ActiveSection = nil
    self.Config = table.clone(DEFAULT_CONFIG)
    self.IsMobile = UserInputService.TouchEnabled
    self.IsOpen = false
    self.Connections = {}
    self.WidgetCallbacks = {}
    
    -- Initialize UI
    local success, err = pcall(function()
        self:InitializeUI()
        self:InitializeInput()
        self:ApplyTheme()
    end)
    
    if not success then
        warn("[Nova UI] Failed to create menu:", err)
        return nil
    end
    
    print("[Nova UI] Menu created successfully:", self.MenuName)
    return self
end

-- UI Initialization
function Nova:InitializeUI()
    -- Main ScreenGui
    self.ScreenGui = Create("ScreenGui", {
        Name = self.MenuName,
        Parent = CoreGui,
        ResetOnSpawn = false,
        ZIndexBehavior = Enum.ZIndexBehavior.Global,
        DisplayOrder = 1000
    })
    
    -- Mobile Floating Button
    if self.IsMobile then
        self.FloatButton = Create("ImageButton", {
            Name = "FloatButton",
            Parent = self.ScreenGui,
            AnchorPoint = Vector2.new(1, 1),
            Position = UDim2.new(1, -20, 1, -20),
            Size = UDim2.new(0, 56, 0, 56),
            BackgroundColor3 = self.Config.AccentColor,
            Image = "rbxassetid://10734947690",
            ImageColor3 = Color3.new(1, 1, 1),
            AutoButtonColor = false,
            Visible = true
        })
        
        Create("UICorner", {
            CornerRadius = UDim.new(1, 0),
            Parent = self.FloatButton
        })
        
        Create("UIStroke", {
            Parent = self.FloatButton,
            Color = Color3.new(1, 1, 1),
            Thickness = 2
        })
        
        self.FloatButton.MouseButton1Click:Connect(function()
            self:Toggle()
        end)
    end
    
    -- Main Container (initially hidden)
    self.Container = Create("Frame", {
        Name = "Container",
        Parent = self.ScreenGui,
        AnchorPoint = Vector2.new(0.5, 0.5),
        Position = UDim2.new(0.5, 0, 0.5, 0),
        Size = UDim2.new(0, 650, 0, 500),
        BackgroundTransparency = 1,
        Visible = false,
        ClipsDescendants = true
    })
    
    -- Background with blur effect
    self.Background = Create("Frame", {
        Name = "Background",
        Parent = self.Container,
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundColor3 = themes.Dark.Background,
        BackgroundTransparency = self.Config.BackgroundTransparency
    })
    
    Create("UICorner", {
        CornerRadius = UDim.new(0, 12),
        Parent = self.Background
    })
    
    Create("UIStroke", {
        Parent = self.Background,
        Color = themes.Dark.Border,
        Thickness = 2,
        Transparency = 0.5
    })
    
    -- Title Bar
    self.TitleBar = Create("Frame", {
        Name = "TitleBar",
        Parent = self.Container,
        Size = UDim2.new(1, 0, 0, 48),
        BackgroundColor3 = themes.Dark.Surface,
        BorderSizePixel = 0
    })
    
    Create("UICorner", {
        CornerRadius = UDim.new(0, 12),
        Parent = self.TitleBar
    })
    
    self.Title = Create("TextLabel", {
        Name = "Title",
        Parent = self.TitleBar,
        AnchorPoint = Vector2.new(0, 0.5),
        Position = UDim2.new(0, 20, 0.5, 0),
        Size = UDim2.new(0.5, 0, 0, 30),
        BackgroundTransparency = 1,
        Text = "NOVA UI",
        TextColor3 = self.Config.AccentColor,
        Font = Enum.Font.GothamBold,
        TextSize = 24,
        TextXAlignment = Enum.TextXAlignment.Left
    })
    
    -- Close Button
    self.CloseButton = Create("TextButton", {
        Name = "CloseButton",
        Parent = self.TitleBar,
        AnchorPoint = Vector2.new(1, 0.5),
        Position = UDim2.new(1, -15, 0.5, 0),
        Size = UDim2.new(0, 32, 0, 32),
        BackgroundTransparency = 1,
        Text = "âœ•",
        TextColor3 = themes.Dark.SubText,
        Font = Enum.Font.GothamBold,
        TextSize = 20,
        AutoButtonColor = false
    })
    
    self.CloseButton.MouseButton1Click:Connect(function()
        self:Toggle()
    end)
    
    -- Tab Container
    self.TabContainer = Create("Frame", {
        Name = "TabContainer",
        Parent = self.Container,
        Position = UDim2.new(0, 0, 0, 52),
        Size = UDim2.new(0, 180, 1, -52),
        BackgroundTransparency = 1
    })
    
    self.TabList = Create("ScrollingFrame", {
        Name = "TabList",
        Parent = self.TabContainer,
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        ScrollBarThickness = 0,
        CanvasSize = UDim2.new(0, 0, 0, 0),
        AutomaticCanvasSize = Enum.AutomaticSize.Y
    })
    
    Create("UIListLayout", {
        Parent = self.TabList,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 8)
    })
    
    Create("UIPadding", {
        Parent = self.TabList,
        PaddingTop = UDim.new(0, 10),
        PaddingLeft = UDim.new(0, 10)
    })
    
    -- Content Container
    self.ContentContainer = Create("Frame", {
        Name = "ContentContainer",
        Parent = self.Container,
        Position = UDim2.new(0, 184, 0, 52),
        Size = UDim2.new(1, -184, 1, -52),
        BackgroundTransparency = 1
    })
    
    self.ContentScroller = Create("ScrollingFrame", {
        Name = "ContentScroller",
        Parent = self.ContentContainer,
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        ScrollBarThickness = 6,
        CanvasSize = UDim2.new(0, 0, 0, 0),
        AutomaticCanvasSize = Enum.AutomaticSize.Y,
        ScrollingDirection = Enum.ScrollingDirection.Y
    })
    
    Create("UIListLayout", {
        Parent = self.ContentScroller,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 16)
    })
    
    Create("UIPadding", {
        Parent = self.ContentScroller,
        PaddingTop = UDim.new(0, 20),
        PaddingRight = UDim.new(0, 20),
        PaddingLeft = UDim.new(0, 20),
        PaddingBottom = UDim.new(0, 20)
    })
end

-- Input Handling
function Nova:InitializeInput()
    if not self.IsMobile then
        local conn = UserInputService.InputBegan:Connect(function(input, processed)
            if not processed and input.KeyCode == self.Config.Keybind then
                self:Toggle()
            end
        end)
        table.insert(self.Connections, conn)
    end
end

-- Menu Control
function Nova:Toggle()
    self.IsOpen = not self.IsOpen
    
    if self.IsOpen then
        -- Show menu with animation
        self.Container.Visible = true
        self.Container.Position = UDim2.new(0.5, 0, 0.5, -50)
        self.Container.BackgroundTransparency = 1
        
        Tween(self.Container, {
            Position = UDim2.new(0.5, 0, 0.5, 0),
            BackgroundTransparency = 0
        }, 0.4, Enum.EasingStyle.Back)
        
        Tween(self.Background, {
            BackgroundTransparency = self.Config.BackgroundTransparency
        }, 0.4)
        
        if self.FloatButton then
            Tween(self.FloatButton, {ImageTransparency = 0.5}, 0.2)
        end
    else
        -- Hide menu with animation
        Tween(self.Container, {
            Position = UDim2.new(0.5, 0, 0.5, -50),
            BackgroundTransparency = 1
        }, 0.3, Enum.EasingStyle.Quad)
        
        Tween(self.Background, {
            BackgroundTransparency = 1
        }, 0.3)
        
        if self.FloatButton then
            Tween(self.FloatButton, {ImageTransparency = 0}, 0.2)
        end
        
        task.wait(0.3)
        self.Container.Visible = false
    end
end

-- Section Creation
function Nova:Section(name, icon)
    local section = {}
    section.Name = name
    section.Id = #self.Sections + 1
    
    -- Create Tab Button
    local tabButton = Create("TextButton", {
        Name = name .. "Tab",
        Parent = self.TabList,
        Size = UDim2.new(1, -10, 0, 42),
        BackgroundColor3 = themes.Dark.Surface,
        AutoButtonColor = false,
        Text = "",
        LayoutOrder = section.Id
    })
    
    Create("UICorner", {
        CornerRadius = UDim.new(0, 8),
        Parent = tabButton
    })
    
    local tabText = Create("TextLabel", {
        Parent = tabButton,
        AnchorPoint = Vector2.new(0, 0.5),
        Position = UDim2.new(0, 15, 0.5, 0),
        Size = UDim2.new(1, -30, 1, 0),
        BackgroundTransparency = 1,
        Text = name,
        TextColor3 = themes.Dark.SubText,
        Font = Enum.Font.GothamMedium,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left
    })
    
    -- Create Content Frame
    local contentFrame = Create("Frame", {
        Name = name .. "Content",
        Parent = self.ContentScroller,
        Size = UDim2.new(1, 0, 0, 0),
        BackgroundTransparency = 1,
        LayoutOrder = section.Id,
        Visible = section.Id == 1
    })
    
    local contentLayout = Create("UIListLayout", {
        Parent = contentFrame,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 16)
    })
    
    -- Activate first section by default
    if section.Id == 1 then
        self.ActiveSection = contentFrame
        tabButton.BackgroundColor3 = self.Config.AccentColor
        tabText.TextColor3 = Color3.new(1, 1, 1)
    end
    
    -- Tab click handler
    tabButton.MouseButton1Click:Connect(function()
        if self.ActiveSection then
            self.ActiveSection.Visible = false
        end
        
        -- Reset all tabs
        for _, tab in ipairs(self.TabList:GetChildren()) do
            if tab:IsA("TextButton") then
                Tween(tab, {BackgroundColor3 = themes.Dark.Surface})
                local text = tab:FindFirstChildWhichIsA("TextLabel")
                if text then
                    Tween(text, {TextColor3 = themes.Dark.SubText})
                end
            end
        end
        
        -- Activate selected
        contentFrame.Visible = true
        self.ActiveSection = contentFrame
        Tween(tabButton, {BackgroundColor3 = self.Config.AccentColor})
        Tween(tabText, {TextColor3 = Color3.new(1, 1, 1)})
    end)
    
    -- Store section
    self.Sections[section.Id] = {
        Button = tabButton,
        Frame = contentFrame,
        Widgets = {}
    }
    
    -- Section API
    local api = {}
    
    -- Widget Container (for grouping)
    function api:Container(title)
        local container = Create("Frame", {
            Parent = contentFrame,
            Size = UDim2.new(1, 0, 0, 0),
            BackgroundTransparency = 1,
            LayoutOrder = #contentFrame:GetChildren()
        })
        
        local layout = Create("UIListLayout", {
            Parent = container,
            SortOrder = Enum.SortOrder.LayoutOrder,
            Padding = UDim.new(0, 12)
        })
        
        if title then
            local titleLabel = Create("TextLabel", {
                Parent = container,
                Size = UDim2.new(1, 0, 0, 24),
                BackgroundTransparency = 1,
                Text = title,
                TextColor3 = self.Config.AccentColor,
                Font = Enum.Font.GothamBold,
                TextSize = 16,
                TextXAlignment = Enum.TextXAlignment.Left
            })
        end
        
        local containerAPI = {}
        
        function containerAPI:Button(text, callback)
            local button = Create("TextButton", {
                Parent = container,
                Size = UDim2.new(1, 0, 0, 42),
                BackgroundColor3 = themes.Dark.Surface,
                AutoButtonColor = false,
                Text = text,
                TextColor3 = themes.Dark.Text,
                Font = Enum.Font.GothamMedium,
                TextSize = 14
            })
            
            Create("UICorner", {
                CornerRadius = UDim.new(0, 8),
                Parent = button
            })
            
            Create("UIStroke", {
                Parent = button,
                Color = themes.Dark.Border,
                Thickness = 1
            })
            
            button.MouseEnter:Connect(function()
                Tween(button, {BackgroundColor3 = themes.Dark.Hover})
            end)
            
            button.MouseLeave:Connect(function()
                Tween(button, {BackgroundColor3 = themes.Dark.Surface})
            end)
            
            button.MouseButton1Click:Connect(function()
                if callback then
                    local success, err = pcall(callback)
                    if not success then
                        warn("[Nova UI] Button callback error:", err)
                    end
                end
            end)
            
            return button
        end
        
        function containerAPI:Toggle(text, default, callback)
            local toggleFrame = Create("Frame", {
                Parent = container,
                Size = UDim2.new(1, 0, 0, 36),
                BackgroundTransparency = 1
            })
            
            local label = Create("TextLabel", {
                Parent = toggleFrame,
                AnchorPoint = Vector2.new(0, 0.5),
                Position = UDim2.new(0, 0, 0.5, 0),
                Size = UDim2.new(0.7, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = text,
                TextColor3 = themes.Dark.Text,
                Font = Enum.Font.GothamMedium,
                TextSize = 14,
                TextXAlignment = Enum.TextXAlignment.Left
            })
            
            local toggleButton = Create("TextButton", {
                Parent = toggleFrame,
                AnchorPoint = Vector2.new(1, 0.5),
                Position = UDim2.new(1, 0, 0.5, 0),
                Size = UDim2.new(0, 56, 0, 28),
                BackgroundColor3 = default and self.Config.AccentColor or themes.Dark.Surface,
                AutoButtonColor = false,
                Text = ""
            })
            
            Create("UICorner", {
                CornerRadius = UDim.new(1, 0),
                Parent = toggleButton
            })
            
            local toggleCircle = Create("Frame", {
                Parent = toggleButton,
                AnchorPoint = Vector2.new(default and 1 or 0, 0.5),
                Position = default and UDim2.new(1, -14, 0.5, 0) or UDim2.new(0, 14, 0.5, 0),
                Size = UDim2.new(0, 20, 0, 20),
                BackgroundColor3 = Color3.new(1, 1, 1)
            })
            
            Create("UICorner", {
                CornerRadius = UDim.new(1, 0),
                Parent = toggleCircle
            })
            
            local state = default or false
            
            toggleButton.MouseButton1Click:Connect(function()
                state = not state
                
                if state then
                    Tween(toggleButton, {BackgroundColor3 = self.Config.AccentColor})
                    Tween(toggleCircle, {Position = UDim2.new(1, -14, 0.5, 0)})
                else
                    Tween(toggleButton, {BackgroundColor3 = themes.Dark.Surface})
                    Tween(toggleCircle, {Position = UDim2.new(0, 14, 0.5, 0)})
                end
                
                if callback then
                    local success, err = pcall(callback, state)
                    if not success then
                        warn("[Nova UI] Toggle callback error:", err)
                    end
                end
            end)
            
            local toggleObj = {}
            
            function toggleObj:Set(value)
                if type(value) == "boolean" and value ~= state then
                    state = value
                    toggleButton.MouseButton1Click:Fire()
                end
                return self
            end
            
            function toggleObj:Get()
                return state
            end
            
            return toggleObj
        end
        
        function containerAPI:Slider(text, min, max, default, callback)
            local sliderFrame = Create("Frame", {
                Parent = container,
                Size = UDim2.new(1, 0, 0, 64),
                BackgroundTransparency = 1
            })
            
            local topRow = Create("Frame", {
                Parent = sliderFrame,
                Size = UDim2.new(1, 0, 0, 24),
                BackgroundTransparency = 1
            })
            
            local label = Create("TextLabel", {
                Parent = topRow,
                AnchorPoint = Vector2.new(0, 0.5),
                Position = UDim2.new(0, 0, 0.5, 0),
                Size = UDim2.new(0.7, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = text,
                TextColor3 = themes.Dark.Text,
                Font = Enum.Font.GothamMedium,
                TextSize = 14,
                TextXAlignment = Enum.TextXAlignment.Left
            })
            
            local valueLabel = Create("TextLabel", {
                Parent = topRow,
                AnchorPoint = Vector2.new(1, 0.5),
                Position = UDim2.new(1, 0, 0.5, 0),
                Size = UDim2.new(0.3, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = tostring(default or min),
                TextColor3 = themes.Dark.SubText,
                Font = Enum.Font.GothamMedium,
                TextSize = 14,
                TextXAlignment = Enum.TextXAlignment.Right
            })
            
            local track = Create("Frame", {
                Parent = sliderFrame,
                Position = UDim2.new(0, 0, 0, 32),
                Size = UDim2.new(1, 0, 0, 8),
                BackgroundColor3 = themes.Dark.Surface
            })
            
            Create("UICorner", {
                CornerRadius = UDim.new(1, 0),
                Parent = track
            })
            
            local fill = Create("Frame", {
                Parent = track,
                Size = UDim2.new(0, 0, 1, 0),
                BackgroundColor3 = self.Config.AccentColor
            })
            
            Create("UICorner", {
                CornerRadius = UDim.new(1, 0),
                Parent = fill
            })
            
            local handle = Create("Frame", {
                Parent = track,
                AnchorPoint = Vector2.new(0.5, 0.5),
                Position = UDim2.new(0, 0, 0.5, 0),
                Size = UDim2.new(0, 20, 0, 20),
                BackgroundColor3 = Color3.new(1, 1, 1)
            })
            
            Create("UICorner", {
                CornerRadius = UDim.new(1, 0),
                Parent = handle
            })
            
            Create("UIStroke", {
                Parent = handle,
                Color = themes.Dark.Border,
                Thickness = 2
            })
            
            local value = math.clamp(default or min, min, max)
            local dragging = false
            
            local function updateSlider(mouseX)
                local absoluteX = track.AbsolutePosition.X
                local absoluteWidth = track.AbsoluteSize.X
                
                local relativeX = math.clamp(mouseX - absoluteX, 0, absoluteWidth)
                local percentage = relativeX / absoluteWidth
                value = math.floor(min + (max - min) * percentage)
                
                fill.Size = UDim2.new(percentage, 0, 1, 0)
                handle.Position = UDim2.new(percentage, 0, 0.5, 0)
                valueLabel.Text = tostring(value)
                
                if callback then
                    local success, err = pcall(callback, value)
                    if not success then
                        warn("[Nova UI] Slider callback error:", err)
                    end
                end
            end
            
            -- Set initial value
            local initialPercentage = (value - min) / (max - min)
            fill.Size = UDim2.new(initialPercentage, 0, 1, 0)
            handle.Position = UDim2.new(initialPercentage, 0, 0.5, 0)
            
            handle.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = true
                end
            end)
            
            handle.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = false
                end
            end)
            
            track.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = true
                    updateSlider(input.Position.X)
                end
            end)
            
            local conn = UserInputService.InputChanged:Connect(function(input)
                if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                    updateSlider(input.Position.X)
                end
            end)
            
            table.insert(self.Connections, conn)
            
            local sliderObj = {}
            
            function sliderObj:Set(newValue)
                value = math.clamp(newValue, min, max)
                local percentage = (value - min) / (max - min)
                fill.Size = UDim2.new(percentage, 0, 1, 0)
                handle.Position = UDim2.new(percentage, 0, 0.5, 0)
                valueLabel.Text = tostring(value)
                return self
            end
            
            function sliderObj:Get()
                return value
            end
            
            return sliderObj
        end
        
        function containerAPI:Dropdown(text, options, callback)
            local dropdownFrame = Create("Frame", {
                Parent = container,
                Size = UDim2.new(1, 0, 0, 42),
                BackgroundTransparency = 1
            })
            
            local label = Create("TextLabel", {
                Parent = dropdownFrame,
                AnchorPoint = Vector2.new(0, 0.5),
                Position = UDim2.new(0, 0, 0.5, 0),
                Size = UDim2.new(0.3, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = text,
                TextColor3 = themes.Dark.Text,
                Font = Enum.Font.GothamMedium,
                TextSize = 14,
                TextXAlignment = Enum.TextXAlignment.Left
            })
            
            local dropdownButton = Create("TextButton", {
                Parent = dropdownFrame,
                AnchorPoint = Vector2.new(1, 0.5),
                Position = UDim2.new(1, 0, 0.5, 0),
                Size = UDim2.new(0.7, 0, 1, 0),
                BackgroundColor3 = themes.Dark.Surface,
                AutoButtonColor = false,
                Text = "Select...",
                TextColor3 = themes.Dark.SubText,
                Font = Enum.Font.GothamMedium,
                TextSize = 14
            })
            
            Create("UICorner", {
                CornerRadius = UDim.new(0, 8),
                Parent = dropdownButton
            })
            
            local dropdownList = Create("Frame", {
                Parent = self.ScreenGui,
                Size = UDim2.new(0, 200, 0, 0),
                BackgroundColor3 = themes.Dark.Surface,
                Visible = false,
                ZIndex = 100,
                ClipsDescendants = true
            })
            
            Create("UICorner", {
                CornerRadius = UDim.new(0, 8),
                Parent = dropdownList
            })
            
            Create("UIStroke", {
                Parent = dropdownList,
                Color = themes.Dark.Border,
                Thickness = 2
            })
            
            local listLayout = Create("UIListLayout", {
                Parent = dropdownList,
                SortOrder = Enum.SortOrder.LayoutOrder
            })
            
            local selected = nil
            
            local function updateList()
                for _, child in ipairs(dropdownList:GetChildren()) do
                    if child:IsA("TextButton") then
                        child:Destroy()
                    end
                end
                
                for i, option in ipairs(options) do
                    local optionText = tostring(option)
                    local optionButton = Create("TextButton", {
                        Parent = dropdownList,
                        Size = UDim2.new(1, 0, 0, 36),
                        BackgroundColor3 = themes.Dark.Surface,
                        AutoButtonColor = false,
                        Text = optionText,
                        TextColor3 = themes.Dark.Text,
                        Font = Enum.Font.Gotham,
                        TextSize = 14,
                        LayoutOrder = i
                    })
                    
                    optionButton.MouseEnter:Connect(function()
                        Tween(optionButton, {BackgroundColor3 = themes.Dark.Hover})
                    end)
                    
                    optionButton.MouseLeave:Connect(function()
                        Tween(optionButton, {BackgroundColor3 = themes.Dark.Surface})
                    end)
                    
                    optionButton.MouseButton1Click:Connect(function()
                        selected = option
                        dropdownButton.Text = optionText
                        dropdownList.Visible = false
                        
                        if callback then
                            local success, err = pcall(callback, option)
                            if not success then
                                warn("[Nova UI] Dropdown callback error:", err)
                            end
                        end
                    end)
                end
                
                dropdownList.Size = UDim2.new(0, 200, 0, math.min(#options * 36, 180))
            end
            
            dropdownButton.MouseButton1Click:Connect(function()
                local buttonPos = dropdownButton.AbsolutePosition
                local buttonSize = dropdownButton.AbsoluteSize
                
                dropdownList.Position = UDim2.new(
                    0, buttonPos.X,
                    0, buttonPos.Y + buttonSize.Y + 5
                )
                
                dropdownList.Visible = not dropdownList.Visible
                updateList()
            end)
            
            updateList()
            
            local dropdownObj = {}
            
            function dropdownObj:SetOptions(newOptions)
                options = newOptions
                updateList()
                return self
            end
            
            function dropdownObj:Set(value)
                selected = value
                dropdownButton.Text = tostring(value)
                return self
            end
            
            function dropdownObj:Get()
                return selected
            end
            
            return dropdownObj
        end
        
        function containerAPI:Textbox(text, placeholder, callback)
            local textboxFrame = Create("Frame", {
                Parent = container,
                Size = UDim2.new(1, 0, 0, 42),
                BackgroundTransparency = 1
            })
            
            local label = Create("TextLabel", {
                Parent = textboxFrame,
                AnchorPoint = Vector2.new(0, 0.5),
                Position = UDim2.new(0, 0, 0.5, 0),
                Size = UDim2.new(0.3, 0, 1, 0),
                BackgroundTransparency = 1,
                Text = text,
                TextColor3 = themes.Dark.Text,
                Font = Enum.Font.GothamMedium,
                TextSize = 14,
                TextXAlignment = Enum.TextXAlignment.Left
            })
            
            local textbox = Create("TextBox", {
                Parent = textboxFrame,
                AnchorPoint = Vector2.new(1, 0.5),
                Position = UDim2.new(1, 0, 0.5, 0),
                Size = UDim2.new(0.7, 0, 1, 0),
                BackgroundColor3 = themes.Dark.Surface,
                PlaceholderText = placeholder or "Type here...",
                Text = "",
                TextColor3 = themes.Dark.Text,
                Font = Enum.Font.Gotham,
                TextSize = 14,
                ClearTextOnFocus = false
            })
            
            Create("UICorner", {
                CornerRadius = UDim.new(0, 8),
                Parent = textbox
            })
            
            Create("UIStroke", {
                Parent = textbox,
                Color = themes.Dark.Border,
                Thickness = 1
            })
            
            if callback then
                textbox.FocusLost:Connect(function(enterPressed)
                    local success, err = pcall(callback, textbox.Text, enterPressed)
                    if not success then
                        warn("[Nova UI] Textbox callback error:", err)
                    end
                end)
            end
            
            return textbox
        end
        
        return containerAPI
    end
    
    -- Direct widget methods (for backward compatibility)
    function api:Button(text, callback)
        local container = api:Container()
        return container:Button(text, callback)
    end
    
    function api:Toggle(text, default, callback)
        local container = api:Container()
        return container:Toggle(text, default, callback)
    end
    
    function api:Slider(text, min, max, default, callback)
        local container = api:Container()
        return container:Slider(text, min, max, default, callback)
    end
    
    function api:Dropdown(text, options, callback)
        local container = api:Container()
        return container:Dropdown(text, options, callback)
    end
    
    function api:Textbox(text, placeholder, callback)
        local container = api:Container()
        return container:Textbox(text, placeholder, callback)
    end
    
    return api
end

-- Built-in Settings Section
function Nova:AddSettingsSection()
    local settings = self:Section("Settings")
    
    local ui = settings:Container("User Interface")
    
    -- Theme
    local themeDropdown = ui:Dropdown("Theme", {"Dark", "Light"}, function(theme)
        self.Config.Theme = theme
        self:ApplyTheme()
    end)
    themeDropdown:Set(self.Config.Theme)
    
    -- Accent Color
    ui:Slider("Accent Color R", 0, 255, math.floor(self.Config.AccentColor.R * 255), function(r)
        self.Config.AccentColor = Color3.fromRGB(r, self.Config.AccentColor.G * 255, self.Config.AccentColor.B * 255)
        self:ApplyTheme()
    end)
    
    -- Transparency
    ui:Slider("Transparency", 0, 100, 100 - (self.Config.BackgroundTransparency * 100), function(value)
        self.Config.BackgroundTransparency = 1 - (value / 100)
        self.Background.BackgroundTransparency = self.Config.BackgroundTransparency
    end)
    
    -- Keybind Info
    ui:Button("Keybind: " .. self.Config.Keybind.Name, function()
        print("Current keybind:", self.Config.Keybind.Name)
    end)
    
    -- Reset
    ui:Button("Reset to Defaults", function()
        self.Config = table.clone(DEFAULT_CONFIG)
        self:ApplyTheme()
        print("Settings reset to defaults")
    end)
    
    -- Info
    local info = settings:Container("Information")
    info:Button("Nova UI v" .. self.Version, function()
        print("Nova UI Library v" .. self.Version)
        print("Professional Mod Menu Framework")
    end)
    
    info:Button("Created by Nova Team", function()
        print("Thank you for using Nova UI!")
    end)
end

-- Console System
function Nova:CreateConsoleSection(title, logFunction)
    local console = self:Section(title or "Console")
    
    local container = console:Container()
    
    -- Search bar
    local searchBox = container:Textbox("Search", "Filter logs...", function(text)
        -- Search functionality would go here
    end)
    
    -- Console output area
    local outputFrame = Create("Frame", {
        Parent = container,
        Size = UDim2.new(1, 0, 0, 200),
        BackgroundColor3 = themes.Dark.Surface
    })
    
    Create("UICorner", {
        CornerRadius = UDim.new(0, 8),
        Parent = outputFrame
    })
    
    Create("UIStroke", {
        Parent = outputFrame,
        Color = themes.Dark.Border,
        Thickness = 1
    })
    
    local outputScroller = Create("ScrollingFrame", {
        Parent = outputFrame,
        Size = UDim2.new(1, -10, 1, -10),
        Position = UDim2.new(0, 5, 0, 5),
        BackgroundTransparency = 1,
        ScrollBarThickness = 6,
        CanvasSize = UDim2.new(0, 0, 0, 0),
        AutomaticCanvasSize = Enum.AutomaticSize.Y
    })
    
    Create("UIListLayout", {
        Parent = outputScroller,
        SortOrder = Enum.SortOrder.LayoutOrder
    })
    
    -- Clear button
    container:Button("Clear Console", function()
        for _, child in ipairs(outputScroller:GetChildren()) do
            if child:IsA("TextLabel") then
                child:Destroy()
            end
        end
    end)
    
    -- Log function
    if logFunction then
        local function addLog(text, color)
            color = color or themes.Dark.Text
            
            local logLabel = Create("TextLabel", {
                Parent = outputScroller,
                Size = UDim2.new(1, 0, 0, 20),
                BackgroundTransparency = 1,
                Text = text,
                TextColor3 = color,
                Font = Enum.Font.Gotham,
                TextSize = 12,
                TextXAlignment = Enum.TextXAlignment.Left,
                TextTruncate = Enum.TextTruncate.AtEnd
            })
        end
        
        -- Add sample logs
        addLog("Roblox Console initialized...", Color3.fromRGB(0, 200, 100))
        addLog("HTTP 404", Color3.fromRGB(255, 100, 100))
        addLog("Stack Begin", themes.Dark.SubText)
        addLog("Script 'LocalScript', Line 2051", themes.Dark.SubText)
        addLog("Stack End", themes.Dark.SubText)
        addLog("")
        addLog("RAXALeamRtdbaIQxLwqketj453: attempt to index nil with 'GetChildren'", Color3.fromRGB(255, 150, 50))
        addLog("Stack Begin", themes.Dark.SubText)
        addLog("Script 'LocalScript', Line 453 - function Toggle", themes.Dark.SubText)
        addLog("Script 'LocalScript', Line 13", themes.Dark.SubText)
        addLog("Stack End", themes.Dark.SubText)
    end
end

-- Theme Application
function Nova:ApplyTheme()
    local theme = themes[self.Config.Theme] or themes.Dark
    
    if self.Background then
        self.Background.BackgroundColor3 = theme.Background
    end
    
    if self.TitleBar then
        self.TitleBar.BackgroundColor3 = theme.Surface
    end
    
    if self.Title then
        self.Title.TextColor3 = self.Config.AccentColor
    end
    
    if self.CloseButton then
        self.CloseButton.TextColor3 = theme.SubText
    end
    
    -- Update all tabs
    for _, section in pairs(self.Sections) do
        if section.Button then
            local textLabel = section.Button:FindFirstChildWhichIsA("TextLabel")
            if textLabel then
                if section.Frame == self.ActiveSection then
                    section.Button.BackgroundColor3 = self.Config.AccentColor
                    textLabel.TextColor3 = Color3.new(1, 1, 1)
                else
                    section.Button.BackgroundColor3 = theme.Surface
                    textLabel.TextColor3 = theme.SubText
                end
            end
        end
    end
end

-- Cleanup
function Nova:Destroy()
    for _, conn in ipairs(self.Connections) do
        if typeof(conn) == "RBXScriptConnection" then
            pcall(function() conn:Disconnect() end)
        end
    end
    
    if self.ScreenGui then
        self.ScreenGui:Destroy()
    end
    
    for _, instance in ipairs(Nova.Instances) do
        pcall(function() instance:Destroy() end)
    end
    
    for k in pairs(self) do
        self[k] = nil
    end
end

return Nova
